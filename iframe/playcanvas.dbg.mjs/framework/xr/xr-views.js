import { platform } from '../../core/platform.js';
import { EventHandler } from '../../core/event-handler.js';
import { XrView } from './xr-view.js';
import { XRDEPTHSENSINGFORMAT_L8A8, XRDEPTHSENSINGFORMAT_F32, XRDEPTHSENSINGUSAGE_GPU, XRTYPE_AR } from './constants.js';
import { PIXELFORMAT_LA8, PIXELFORMAT_R32F } from '../../platform/graphics/constants.js';

/**
 * Provides access to list of {@link XrView}'s. And information about their capabilities,
 * such as support and availability of view's camera color texture, depth texture and other parameters.
 *
 * @category XR
 */
class XrViews extends EventHandler {
  /**
   * @param {import('./xr-manager.js').XrManager} manager - WebXR Manager.
   * @hideconstructor
   */
  constructor(manager) {
    super();
    /**
     * @type {import('./xr-manager.js').XrManager}
     * @private
     */
    this._manager = void 0;
    /**
     * @type {Map<string,XrView>}
     * @private
     */
    this._index = new Map();
    /**
     * @type {Map<string,XrView>}
     * @private
     */
    this._indexTmp = new Map();
    /**
     * @type {XrView[]}
     * @private
     */
    this._list = [];
    /**
     * @type {boolean}
     * @private
     */
    this._supportedColor = platform.browser && !!window.XRCamera && !!window.XRWebGLBinding;
    /**
     * @type {boolean}
     * @private
     */
    this._supportedDepth = platform.browser && !!window.XRDepthInformation;
    /**
     * @type {boolean}
     * @private
     */
    this._availableColor = false;
    /**
     * @type {boolean}
     * @private
     */
    this._availableDepth = false;
    /**
     * @type {string}
     * @private
     */
    this._depthUsage = '';
    /**
     * @type {string}
     * @private
     */
    this._depthFormat = '';
    /**
     * @type {object}
     * @private
     */
    this._depthFormats = {
      [XRDEPTHSENSINGFORMAT_L8A8]: PIXELFORMAT_LA8,
      [XRDEPTHSENSINGFORMAT_F32]: PIXELFORMAT_R32F
    };
    this._manager = manager;
    this._manager.on('start', this._onSessionStart, this);
    this._manager.on('end', this._onSessionEnd, this);
  }

  /**
   * An array of {@link XrView}'s of this session. Views are not available straight
   * away on session start, and can be added/removed mid-session. So use of add/remove
   * events is required for accessing views.
   *
   * @type {XrView[]}
   */
  get list() {
    return this._list;
  }

  /**
   * Check if Camera Color is supported. It might be still unavailable even if requested,
   * based on hardware capabilities and granted permissions.
   *
   * @type {boolean}
   */
  get supportedColor() {
    return this._supportedColor;
  }

  /**
   * Check if Camera Depth is supported. It might be still unavailable even if requested,
   * based on hardware capabilities and granted permissions.
   *
   * @type {boolean}
   */
  get supportedDepth() {
    return this._supportedDepth;
  }

  /**
   * Check if Camera Color is available. This information becomes available only after
   * session has started.
   *
   * @type {boolean}
   */
  get availableColor() {
    return this._availableColor;
  }

  /**
   * Check if Camera Depth is available. This information becomes available only after
   * session has started.
   *
   * @type {boolean}
   */
  get availableDepth() {
    return this._availableDepth;
  }

  /**
   * @type {string}
   * @ignore
   */
  get depthUsage() {
    return this._depthUsage;
  }

  /**
   * Whether the depth sensing is GPU optimized.
   *
   * @type {boolean}
   */
  get depthGpuOptimized() {
    return this._depthUsage === XRDEPTHSENSINGUSAGE_GPU;
  }

  /**
   * @type {string}
   * @ignore
   */
  get depthFormat() {
    return this._depthFormat;
  }

  /**
   * The depth sensing pixel format. Currently supported either:
   * {@link PIXELFORMAT_LA8} or {@link PIXELFORMAT_R32F}
   *
   * @type {number|null}
   */
  get depthPixelFormat() {
    var _this$_depthFormats$t;
    return (_this$_depthFormats$t = this._depthFormats[this._depthFormat]) != null ? _this$_depthFormats$t : null;
  }

  /**
   * @param {*} frame - XRFrame from requestAnimationFrame callback.
   * @param {XRView} xrView - XRView from WebXR API.
   * @ignore
   */
  update(frame, xrViews) {
    for (let i = 0; i < xrViews.length; i++) {
      this._indexTmp.set(xrViews[i].eye, xrViews[i]);
    }
    for (const [eye, xrView] of this._indexTmp) {
      let view = this._index.get(eye);
      if (!view) {
        // add new view
        view = new XrView(this._manager, xrView, xrViews.length);
        this._index.set(eye, view);
        this._list.push(view);
        view.update(frame, xrView);
        this.fire('add', view);
      } else {
        // update existing view0
        view.update(frame, xrView);
      }
    }

    // remove views
    for (const [eye, view] of this._index) {
      if (this._indexTmp.has(eye)) continue;
      view.destroy();
      this._index.delete(eye);
      const ind = this._list.indexOf(view);
      if (ind !== -1) this._list.splice(ind, 1);
      this.fire('remove', view);
    }
    this._indexTmp.clear();
  }

  /**
   * Get an {@link XrView} by its associated eye constant.
   *
   * @param {string} eye - An XREYE_* view is associated with. Can be 'none' for monoscope views.
   * @returns {XrView|null} View or null if view of such eye is not available.
   */
  get(eye) {
    return this._index.get(eye) || null;
  }

  /**
   * @private
   */
  _onSessionStart() {
    if (this._manager.type !== XRTYPE_AR) return;
    this._availableColor = this._manager.session.enabledFeatures.indexOf('camera-access') !== -1;
    this._availableDepth = this._manager.session.enabledFeatures.indexOf('depth-sensing') !== -1;
    if (this._availableDepth) {
      const session = this._manager.session;
      this._depthUsage = session.depthUsage;
      this._depthFormat = session.depthDataFormat;
    }
  }

  /**
   * @private
   */
  _onSessionEnd() {
    for (const view of this._index.values()) {
      view.destroy();
    }
    this._index.clear();
    this._availableColor = false;
    this._availableDepth = false;
    this._depthUsage = '';
    this._depthFormat = '';
    this._list.length = 0;
  }
}
/**
 * Fired when view has been added. Views are not available straight away on session start
 * and are added mid-session. They can be added/removed mid session by underlyng system. The
 * handler is passed the {@link XrView} that has been added.
 *
 * @event
 * @example
 * xr.views.on('add', (view) => {
 *     console.log('View added');
 * });
 */
XrViews.EVENT_ADD = 'add';
/**
 * Fired when view has been removed. They can be added/removed mid session by underlyng system.
 * The handler is passed the {@link XrView} that has been removed.
 *
 * @event
 * @example
 * xr.views.on('remove', (view) => {
 *     console.log('View removed');
 * });
 */
XrViews.EVENT_REMOVE = 'remove';

export { XrViews };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieHItdmlld3MuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9mcmFtZXdvcmsveHIveHItdmlld3MuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcGxhdGZvcm0gfSBmcm9tICcuLi8uLi9jb3JlL3BsYXRmb3JtLmpzJztcbmltcG9ydCB7IEV2ZW50SGFuZGxlciB9IGZyb20gXCIuLi8uLi9jb3JlL2V2ZW50LWhhbmRsZXIuanNcIjtcbmltcG9ydCB7IFhyVmlldyB9IGZyb20gXCIuL3hyLXZpZXcuanNcIjtcbmltcG9ydCB7IFhSVFlQRV9BUiwgWFJERVBUSFNFTlNJTkdVU0FHRV9HUFUsIFhSREVQVEhTRU5TSU5HRk9STUFUX0w4QTgsIFhSREVQVEhTRU5TSU5HRk9STUFUX0YzMiB9IGZyb20gXCIuL2NvbnN0YW50cy5qc1wiO1xuaW1wb3J0IHsgUElYRUxGT1JNQVRfTEE4LCBQSVhFTEZPUk1BVF9SMzJGIH0gZnJvbSAnLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3MvY29uc3RhbnRzLmpzJztcblxuLyoqXG4gKiBQcm92aWRlcyBhY2Nlc3MgdG8gbGlzdCBvZiB7QGxpbmsgWHJWaWV3fSdzLiBBbmQgaW5mb3JtYXRpb24gYWJvdXQgdGhlaXIgY2FwYWJpbGl0aWVzLFxuICogc3VjaCBhcyBzdXBwb3J0IGFuZCBhdmFpbGFiaWxpdHkgb2YgdmlldydzIGNhbWVyYSBjb2xvciB0ZXh0dXJlLCBkZXB0aCB0ZXh0dXJlIGFuZCBvdGhlciBwYXJhbWV0ZXJzLlxuICpcbiAqIEBjYXRlZ29yeSBYUlxuICovXG5jbGFzcyBYclZpZXdzIGV4dGVuZHMgRXZlbnRIYW5kbGVyIHtcbiAgICAvKipcbiAgICAgKiBGaXJlZCB3aGVuIHZpZXcgaGFzIGJlZW4gYWRkZWQuIFZpZXdzIGFyZSBub3QgYXZhaWxhYmxlIHN0cmFpZ2h0IGF3YXkgb24gc2Vzc2lvbiBzdGFydFxuICAgICAqIGFuZCBhcmUgYWRkZWQgbWlkLXNlc3Npb24uIFRoZXkgY2FuIGJlIGFkZGVkL3JlbW92ZWQgbWlkIHNlc3Npb24gYnkgdW5kZXJseW5nIHN5c3RlbS4gVGhlXG4gICAgICogaGFuZGxlciBpcyBwYXNzZWQgdGhlIHtAbGluayBYclZpZXd9IHRoYXQgaGFzIGJlZW4gYWRkZWQuXG4gICAgICpcbiAgICAgKiBAZXZlbnRcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIHhyLnZpZXdzLm9uKCdhZGQnLCAodmlldykgPT4ge1xuICAgICAqICAgICBjb25zb2xlLmxvZygnVmlldyBhZGRlZCcpO1xuICAgICAqIH0pO1xuICAgICAqL1xuICAgIHN0YXRpYyBFVkVOVF9BREQgPSAnYWRkJztcblxuICAgIC8qKlxuICAgICAqIEZpcmVkIHdoZW4gdmlldyBoYXMgYmVlbiByZW1vdmVkLiBUaGV5IGNhbiBiZSBhZGRlZC9yZW1vdmVkIG1pZCBzZXNzaW9uIGJ5IHVuZGVybHluZyBzeXN0ZW0uXG4gICAgICogVGhlIGhhbmRsZXIgaXMgcGFzc2VkIHRoZSB7QGxpbmsgWHJWaWV3fSB0aGF0IGhhcyBiZWVuIHJlbW92ZWQuXG4gICAgICpcbiAgICAgKiBAZXZlbnRcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIHhyLnZpZXdzLm9uKCdyZW1vdmUnLCAodmlldykgPT4ge1xuICAgICAqICAgICBjb25zb2xlLmxvZygnVmlldyByZW1vdmVkJyk7XG4gICAgICogfSk7XG4gICAgICovXG4gICAgc3RhdGljIEVWRU5UX1JFTU9WRSA9ICdyZW1vdmUnO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge2ltcG9ydCgnLi94ci1tYW5hZ2VyLmpzJykuWHJNYW5hZ2VyfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgX21hbmFnZXI7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7TWFwPHN0cmluZyxYclZpZXc+fVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgX2luZGV4ID0gbmV3IE1hcCgpO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge01hcDxzdHJpbmcsWHJWaWV3Pn1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9pbmRleFRtcCA9IG5ldyBNYXAoKTtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtYclZpZXdbXX1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9saXN0ID0gW107XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9zdXBwb3J0ZWRDb2xvciA9IHBsYXRmb3JtLmJyb3dzZXIgJiYgISF3aW5kb3cuWFJDYW1lcmEgJiYgISF3aW5kb3cuWFJXZWJHTEJpbmRpbmc7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9zdXBwb3J0ZWREZXB0aCA9IHBsYXRmb3JtLmJyb3dzZXIgJiYgISF3aW5kb3cuWFJEZXB0aEluZm9ybWF0aW9uO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBfYXZhaWxhYmxlQ29sb3IgPSBmYWxzZTtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtib29sZWFufVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgX2F2YWlsYWJsZURlcHRoID0gZmFsc2U7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgX2RlcHRoVXNhZ2UgPSAnJztcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBfZGVwdGhGb3JtYXQgPSAnJztcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtvYmplY3R9XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBfZGVwdGhGb3JtYXRzID0ge1xuICAgICAgICBbWFJERVBUSFNFTlNJTkdGT1JNQVRfTDhBOF06IFBJWEVMRk9STUFUX0xBOCxcbiAgICAgICAgW1hSREVQVEhTRU5TSU5HRk9STUFUX0YzMl06IFBJWEVMRk9STUFUX1IzMkZcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4veHItbWFuYWdlci5qcycpLlhyTWFuYWdlcn0gbWFuYWdlciAtIFdlYlhSIE1hbmFnZXIuXG4gICAgICogQGhpZGVjb25zdHJ1Y3RvclxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG1hbmFnZXIpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLl9tYW5hZ2VyID0gbWFuYWdlcjtcbiAgICAgICAgdGhpcy5fbWFuYWdlci5vbignc3RhcnQnLCB0aGlzLl9vblNlc3Npb25TdGFydCwgdGhpcyk7XG4gICAgICAgIHRoaXMuX21hbmFnZXIub24oJ2VuZCcsIHRoaXMuX29uU2Vzc2lvbkVuZCwgdGhpcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQW4gYXJyYXkgb2Yge0BsaW5rIFhyVmlld30ncyBvZiB0aGlzIHNlc3Npb24uIFZpZXdzIGFyZSBub3QgYXZhaWxhYmxlIHN0cmFpZ2h0XG4gICAgICogYXdheSBvbiBzZXNzaW9uIHN0YXJ0LCBhbmQgY2FuIGJlIGFkZGVkL3JlbW92ZWQgbWlkLXNlc3Npb24uIFNvIHVzZSBvZiBhZGQvcmVtb3ZlXG4gICAgICogZXZlbnRzIGlzIHJlcXVpcmVkIGZvciBhY2Nlc3Npbmcgdmlld3MuXG4gICAgICpcbiAgICAgKiBAdHlwZSB7WHJWaWV3W119XG4gICAgICovXG4gICAgZ2V0IGxpc3QoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9saXN0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIENhbWVyYSBDb2xvciBpcyBzdXBwb3J0ZWQuIEl0IG1pZ2h0IGJlIHN0aWxsIHVuYXZhaWxhYmxlIGV2ZW4gaWYgcmVxdWVzdGVkLFxuICAgICAqIGJhc2VkIG9uIGhhcmR3YXJlIGNhcGFiaWxpdGllcyBhbmQgZ3JhbnRlZCBwZXJtaXNzaW9ucy5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtib29sZWFufVxuICAgICAqL1xuICAgIGdldCBzdXBwb3J0ZWRDb2xvcigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N1cHBvcnRlZENvbG9yO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIENhbWVyYSBEZXB0aCBpcyBzdXBwb3J0ZWQuIEl0IG1pZ2h0IGJlIHN0aWxsIHVuYXZhaWxhYmxlIGV2ZW4gaWYgcmVxdWVzdGVkLFxuICAgICAqIGJhc2VkIG9uIGhhcmR3YXJlIGNhcGFiaWxpdGllcyBhbmQgZ3JhbnRlZCBwZXJtaXNzaW9ucy5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtib29sZWFufVxuICAgICAqL1xuICAgIGdldCBzdXBwb3J0ZWREZXB0aCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N1cHBvcnRlZERlcHRoO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIENhbWVyYSBDb2xvciBpcyBhdmFpbGFibGUuIFRoaXMgaW5mb3JtYXRpb24gYmVjb21lcyBhdmFpbGFibGUgb25seSBhZnRlclxuICAgICAqIHNlc3Npb24gaGFzIHN0YXJ0ZWQuXG4gICAgICpcbiAgICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBnZXQgYXZhaWxhYmxlQ29sb3IoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9hdmFpbGFibGVDb2xvcjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiBDYW1lcmEgRGVwdGggaXMgYXZhaWxhYmxlLiBUaGlzIGluZm9ybWF0aW9uIGJlY29tZXMgYXZhaWxhYmxlIG9ubHkgYWZ0ZXJcbiAgICAgKiBzZXNzaW9uIGhhcyBzdGFydGVkLlxuICAgICAqXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICovXG4gICAgZ2V0IGF2YWlsYWJsZURlcHRoKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fYXZhaWxhYmxlRGVwdGg7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgZ2V0IGRlcHRoVXNhZ2UoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZXB0aFVzYWdlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdoZXRoZXIgdGhlIGRlcHRoIHNlbnNpbmcgaXMgR1BVIG9wdGltaXplZC5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtib29sZWFufVxuICAgICAqL1xuICAgIGdldCBkZXB0aEdwdU9wdGltaXplZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RlcHRoVXNhZ2UgPT09IFhSREVQVEhTRU5TSU5HVVNBR0VfR1BVO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIGdldCBkZXB0aEZvcm1hdCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RlcHRoRm9ybWF0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoZSBkZXB0aCBzZW5zaW5nIHBpeGVsIGZvcm1hdC4gQ3VycmVudGx5IHN1cHBvcnRlZCBlaXRoZXI6XG4gICAgICoge0BsaW5rIFBJWEVMRk9STUFUX0xBOH0gb3Ige0BsaW5rIFBJWEVMRk9STUFUX1IzMkZ9XG4gICAgICpcbiAgICAgKiBAdHlwZSB7bnVtYmVyfG51bGx9XG4gICAgICovXG4gICAgZ2V0IGRlcHRoUGl4ZWxGb3JtYXQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZXB0aEZvcm1hdHNbdGhpcy5fZGVwdGhGb3JtYXRdID8/IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHsqfSBmcmFtZSAtIFhSRnJhbWUgZnJvbSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgY2FsbGJhY2suXG4gICAgICogQHBhcmFtIHtYUlZpZXd9IHhyVmlldyAtIFhSVmlldyBmcm9tIFdlYlhSIEFQSS5cbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgdXBkYXRlKGZyYW1lLCB4clZpZXdzKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgeHJWaWV3cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5faW5kZXhUbXAuc2V0KHhyVmlld3NbaV0uZXllLCB4clZpZXdzW2ldKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3QgW2V5ZSwgeHJWaWV3XSBvZiB0aGlzLl9pbmRleFRtcCkge1xuICAgICAgICAgICAgbGV0IHZpZXcgPSB0aGlzLl9pbmRleC5nZXQoZXllKTtcblxuICAgICAgICAgICAgaWYgKCF2aWV3KSB7XG4gICAgICAgICAgICAgICAgLy8gYWRkIG5ldyB2aWV3XG4gICAgICAgICAgICAgICAgdmlldyA9IG5ldyBYclZpZXcodGhpcy5fbWFuYWdlciwgeHJWaWV3LCB4clZpZXdzLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgdGhpcy5faW5kZXguc2V0KGV5ZSwgdmlldyk7XG4gICAgICAgICAgICAgICAgdGhpcy5fbGlzdC5wdXNoKHZpZXcpO1xuICAgICAgICAgICAgICAgIHZpZXcudXBkYXRlKGZyYW1lLCB4clZpZXcpO1xuICAgICAgICAgICAgICAgIHRoaXMuZmlyZSgnYWRkJywgdmlldyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBleGlzdGluZyB2aWV3MFxuICAgICAgICAgICAgICAgIHZpZXcudXBkYXRlKGZyYW1lLCB4clZpZXcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gcmVtb3ZlIHZpZXdzXG4gICAgICAgIGZvciAoY29uc3QgW2V5ZSwgdmlld10gb2YgdGhpcy5faW5kZXgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9pbmRleFRtcC5oYXMoZXllKSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICAgICAgdmlldy5kZXN0cm95KCk7XG4gICAgICAgICAgICB0aGlzLl9pbmRleC5kZWxldGUoZXllKTtcbiAgICAgICAgICAgIGNvbnN0IGluZCA9IHRoaXMuX2xpc3QuaW5kZXhPZih2aWV3KTtcbiAgICAgICAgICAgIGlmIChpbmQgIT09IC0xKSB0aGlzLl9saXN0LnNwbGljZShpbmQsIDEpO1xuICAgICAgICAgICAgdGhpcy5maXJlKCdyZW1vdmUnLCB2aWV3KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2luZGV4VG1wLmNsZWFyKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGFuIHtAbGluayBYclZpZXd9IGJ5IGl0cyBhc3NvY2lhdGVkIGV5ZSBjb25zdGFudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleWUgLSBBbiBYUkVZRV8qIHZpZXcgaXMgYXNzb2NpYXRlZCB3aXRoLiBDYW4gYmUgJ25vbmUnIGZvciBtb25vc2NvcGUgdmlld3MuXG4gICAgICogQHJldHVybnMge1hyVmlld3xudWxsfSBWaWV3IG9yIG51bGwgaWYgdmlldyBvZiBzdWNoIGV5ZSBpcyBub3QgYXZhaWxhYmxlLlxuICAgICAqL1xuICAgIGdldChleWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2luZGV4LmdldChleWUpIHx8IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBfb25TZXNzaW9uU3RhcnQoKSB7XG4gICAgICAgIGlmICh0aGlzLl9tYW5hZ2VyLnR5cGUgIT09IFhSVFlQRV9BUilcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB0aGlzLl9hdmFpbGFibGVDb2xvciA9IHRoaXMuX21hbmFnZXIuc2Vzc2lvbi5lbmFibGVkRmVhdHVyZXMuaW5kZXhPZignY2FtZXJhLWFjY2VzcycpICE9PSAtMTtcbiAgICAgICAgdGhpcy5fYXZhaWxhYmxlRGVwdGggPSB0aGlzLl9tYW5hZ2VyLnNlc3Npb24uZW5hYmxlZEZlYXR1cmVzLmluZGV4T2YoJ2RlcHRoLXNlbnNpbmcnKSAhPT0gLTE7XG5cbiAgICAgICAgaWYgKHRoaXMuX2F2YWlsYWJsZURlcHRoKSB7XG4gICAgICAgICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5fbWFuYWdlci5zZXNzaW9uO1xuICAgICAgICAgICAgdGhpcy5fZGVwdGhVc2FnZSA9IHNlc3Npb24uZGVwdGhVc2FnZTtcbiAgICAgICAgICAgIHRoaXMuX2RlcHRoRm9ybWF0ID0gc2Vzc2lvbi5kZXB0aERhdGFGb3JtYXQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9vblNlc3Npb25FbmQoKSB7XG4gICAgICAgIGZvciAoY29uc3QgdmlldyBvZiB0aGlzLl9pbmRleC52YWx1ZXMoKSkge1xuICAgICAgICAgICAgdmlldy5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5faW5kZXguY2xlYXIoKTtcbiAgICAgICAgdGhpcy5fYXZhaWxhYmxlQ29sb3IgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fYXZhaWxhYmxlRGVwdGggPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fZGVwdGhVc2FnZSA9ICcnO1xuICAgICAgICB0aGlzLl9kZXB0aEZvcm1hdCA9ICcnO1xuICAgICAgICB0aGlzLl9saXN0Lmxlbmd0aCA9IDA7XG4gICAgfVxufVxuXG5leHBvcnQgeyBYclZpZXdzIH07XG4iXSwibmFtZXMiOlsiWHJWaWV3cyIsIkV2ZW50SGFuZGxlciIsImNvbnN0cnVjdG9yIiwibWFuYWdlciIsIl9tYW5hZ2VyIiwiX2luZGV4IiwiTWFwIiwiX2luZGV4VG1wIiwiX2xpc3QiLCJfc3VwcG9ydGVkQ29sb3IiLCJwbGF0Zm9ybSIsImJyb3dzZXIiLCJ3aW5kb3ciLCJYUkNhbWVyYSIsIlhSV2ViR0xCaW5kaW5nIiwiX3N1cHBvcnRlZERlcHRoIiwiWFJEZXB0aEluZm9ybWF0aW9uIiwiX2F2YWlsYWJsZUNvbG9yIiwiX2F2YWlsYWJsZURlcHRoIiwiX2RlcHRoVXNhZ2UiLCJfZGVwdGhGb3JtYXQiLCJfZGVwdGhGb3JtYXRzIiwiWFJERVBUSFNFTlNJTkdGT1JNQVRfTDhBOCIsIlBJWEVMRk9STUFUX0xBOCIsIlhSREVQVEhTRU5TSU5HRk9STUFUX0YzMiIsIlBJWEVMRk9STUFUX1IzMkYiLCJvbiIsIl9vblNlc3Npb25TdGFydCIsIl9vblNlc3Npb25FbmQiLCJsaXN0Iiwic3VwcG9ydGVkQ29sb3IiLCJzdXBwb3J0ZWREZXB0aCIsImF2YWlsYWJsZUNvbG9yIiwiYXZhaWxhYmxlRGVwdGgiLCJkZXB0aFVzYWdlIiwiZGVwdGhHcHVPcHRpbWl6ZWQiLCJYUkRFUFRIU0VOU0lOR1VTQUdFX0dQVSIsImRlcHRoRm9ybWF0IiwiZGVwdGhQaXhlbEZvcm1hdCIsIl90aGlzJF9kZXB0aEZvcm1hdHMkdCIsInVwZGF0ZSIsImZyYW1lIiwieHJWaWV3cyIsImkiLCJsZW5ndGgiLCJzZXQiLCJleWUiLCJ4clZpZXciLCJ2aWV3IiwiZ2V0IiwiWHJWaWV3IiwicHVzaCIsImZpcmUiLCJoYXMiLCJkZXN0cm95IiwiZGVsZXRlIiwiaW5kIiwiaW5kZXhPZiIsInNwbGljZSIsImNsZWFyIiwidHlwZSIsIlhSVFlQRV9BUiIsInNlc3Npb24iLCJlbmFibGVkRmVhdHVyZXMiLCJkZXB0aERhdGFGb3JtYXQiLCJ2YWx1ZXMiLCJFVkVOVF9BREQiLCJFVkVOVF9SRU1PVkUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQU1BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1BLE9BQU8sU0FBU0MsWUFBWSxDQUFDO0FBK0YvQjtBQUNKO0FBQ0E7QUFDQTtFQUNJQyxXQUFXQSxDQUFDQyxPQUFPLEVBQUU7QUFDakIsSUFBQSxLQUFLLEVBQUUsQ0FBQTtBQTFFWDtBQUNKO0FBQ0E7QUFDQTtBQUhJLElBQUEsSUFBQSxDQUlBQyxRQUFRLEdBQUEsS0FBQSxDQUFBLENBQUE7QUFFUjtBQUNKO0FBQ0E7QUFDQTtBQUhJLElBQUEsSUFBQSxDQUlBQyxNQUFNLEdBQUcsSUFBSUMsR0FBRyxFQUFFLENBQUE7QUFFbEI7QUFDSjtBQUNBO0FBQ0E7QUFISSxJQUFB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
