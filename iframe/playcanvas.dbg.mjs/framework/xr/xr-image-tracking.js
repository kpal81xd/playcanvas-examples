import { EventHandler } from '../../core/event-handler.js';
import { platform } from '../../core/platform.js';
import { XrTrackedImage } from './xr-tracked-image.js';

/**
 * Image Tracking provides the ability to track real world images using provided image samples and
 * their estimated sizes. The underlying system will assume that tracked image can move and rotate
 * in the real world and will try to provide transformation estimates and its tracking state.
 *
 * @augments EventHandler
 * @category XR
 */
class XrImageTracking extends EventHandler {
  /**
   * Image Tracking provides the ability to track real world images by provided image samples and
   * their estimate sizes.
   *
   * @param {import('./xr-manager.js').XrManager} manager - WebXR Manager.
   * @hideconstructor
   */
  constructor(manager) {
    super();
    /**
     * @type {import('./xr-manager.js').XrManager}
     * @private
     */
    this._manager = void 0;
    /**
     * @type {boolean}
     * @private
     */
    this._supported = platform.browser && !!window.XRImageTrackingResult;
    /**
     * @type {boolean}
     * @private
     */
    this._available = false;
    /**
     * @type {XrTrackedImage[]}
     * @private
     */
    this._images = [];
    this._manager = manager;
    if (this._supported) {
      this._manager.on('start', this._onSessionStart, this);
      this._manager.on('end', this._onSessionEnd, this);
    }
  }

  /**
   * Add an image for image tracking. A width can also be provided to help the underlying system
   * estimate the appropriate transformation. Modifying the tracked images list is only possible
   * before an AR session is started.
   *
   * @param {HTMLCanvasElement|HTMLImageElement|SVGImageElement|HTMLVideoElement|Blob|ImageData|ImageBitmap} image - Image
   * that is matching real world image as close as possible. Resolution of images should be at
   * least 300x300. High resolution does NOT improve tracking performance. Color of image is
   * irrelevant, so grayscale images can be used. Images with too many geometric features or
   * repeating patterns will reduce tracking stability.
   * @param {number} width - Width (in meters) of image in the real world. Providing this value
   * as close to the real value will improve tracking quality.
   * @returns {XrTrackedImage|null} Tracked image object that will contain tracking information.
   * Returns null if image tracking is not supported or if the XR manager is not active.
   * @example
   * // image of a book cover that has width of 20cm (0.2m)
   * app.xr.imageTracking.add(bookCoverImg, 0.2);
   */
  add(image, width) {
    if (!this._supported || this._manager.active) return null;
    const trackedImage = new XrTrackedImage(image, width);
    this._images.push(trackedImage);
    return trackedImage;
  }

  /**
   * Remove an image from image tracking.
   *
   * @param {XrTrackedImage} trackedImage - Tracked image to be removed. Modifying the tracked
   * images list is only possible before an AR session is started.
   */
  remove(trackedImage) {
    if (this._manager.active) return;
    const ind = this._images.indexOf(trackedImage);
    if (ind !== -1) {
      trackedImage.destroy();
      this._images.splice(ind, 1);
    }
  }

  /** @private */
  _onSessionStart() {
    this._manager.session.getTrackedImageScores().then(images => {
      this._available = true;
      for (let i = 0; i < images.length; i++) {
        this._images[i]._trackable = images[i] === 'trackable';
      }
    }).catch(err => {
      this._available = false;
      this.fire('error', err);
    });
  }

  /** @private */
  _onSessionEnd() {
    this._available = false;
    for (let i = 0; i < this._images.length; i++) {
      const image = this._images[i];
      image._pose = null;
      image._measuredWidth = 0;
      if (image._tracking) {
        image._tracking = false;
        image.fire('untracked');
      }
    }
  }

  /**
   * @param {Function} callback - Function to call when all images have been prepared as image
   * bitmaps.
   * @ignore
   */
  prepareImages(callback) {
    if (this._images.length) {
      Promise.all(this._images.map(function (trackedImage) {
        return trackedImage.prepare();
      })).then(function (bitmaps) {
        callback(null, bitmaps);
      }).catch(function (err) {
        callback(err, null);
      });
    } else {
      callback(null, null);
    }
  }

  /**
   * @param {*} frame - XRFrame from requestAnimationFrame callback.
   * @ignore
   */
  update(frame) {
    if (!this._available) return;
    const results = frame.getImageTrackingResults();
    const index = {};
    for (let i = 0; i < results.length; i++) {
      index[results[i].index] = results[i];
      const trackedImage = this._images[results[i].index];
      trackedImage._emulated = results[i].trackingState === 'emulated';
      trackedImage._measuredWidth = results[i].measuredWidthInMeters;
      trackedImage._pose = frame.getPose(results[i].imageSpace, this._manager._referenceSpace);
    }
    for (let i = 0; i < this._images.length; i++) {
      if (this._images[i]._tracking && !index[i]) {
        this._images[i]._tracking = false;
        this._images[i].fire('untracked');
      } else if (!this._images[i]._tracking && index[i]) {
        this._images[i]._tracking = true;
        this._images[i].fire('tracked');
      }
    }
  }

  /**
   * True if Image Tracking is supported.
   *
   * @type {boolean}
   */
  get supported() {
    return this._supported;
  }

  /**
   * True if Image Tracking is available. This information is only available when the
   * XR session has started, and will be true if image tracking is supported and
   * images were provided and they have been processed successfully.
   *
   * @type {boolean}
   */
  get available() {
    return this._available;
  }

  /**
   * List of {@link XrTrackedImage} that contain tracking information.
   *
   * @type {XrTrackedImage[]}
   */
  get images() {
    return this._images;
  }
}
/**
 * Fired when the XR session is started, but image tracking failed to process the provided
 * images. The handler is passed the Error object.
 *
 * @event
 * @example
 * app.xr.imageTracking.on('error', (err) => {
 *     console.error(err.message);
 * });
 */
XrImageTracking.EVENT_ERROR = 'error';

export { XrImageTracking };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieHItaW1hZ2UtdHJhY2tpbmcuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9mcmFtZXdvcmsveHIveHItaW1hZ2UtdHJhY2tpbmcuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRIYW5kbGVyIH0gZnJvbSAnLi4vLi4vY29yZS9ldmVudC1oYW5kbGVyLmpzJztcbmltcG9ydCB7IHBsYXRmb3JtIH0gZnJvbSAnLi4vLi4vY29yZS9wbGF0Zm9ybS5qcyc7XG5cbmltcG9ydCB7IFhyVHJhY2tlZEltYWdlIH0gZnJvbSAnLi94ci10cmFja2VkLWltYWdlLmpzJztcblxuLyoqXG4gKiBJbWFnZSBUcmFja2luZyBwcm92aWRlcyB0aGUgYWJpbGl0eSB0byB0cmFjayByZWFsIHdvcmxkIGltYWdlcyB1c2luZyBwcm92aWRlZCBpbWFnZSBzYW1wbGVzIGFuZFxuICogdGhlaXIgZXN0aW1hdGVkIHNpemVzLiBUaGUgdW5kZXJseWluZyBzeXN0ZW0gd2lsbCBhc3N1bWUgdGhhdCB0cmFja2VkIGltYWdlIGNhbiBtb3ZlIGFuZCByb3RhdGVcbiAqIGluIHRoZSByZWFsIHdvcmxkIGFuZCB3aWxsIHRyeSB0byBwcm92aWRlIHRyYW5zZm9ybWF0aW9uIGVzdGltYXRlcyBhbmQgaXRzIHRyYWNraW5nIHN0YXRlLlxuICpcbiAqIEBhdWdtZW50cyBFdmVudEhhbmRsZXJcbiAqIEBjYXRlZ29yeSBYUlxuICovXG5jbGFzcyBYckltYWdlVHJhY2tpbmcgZXh0ZW5kcyBFdmVudEhhbmRsZXIge1xuICAgIC8qKlxuICAgICAqIEZpcmVkIHdoZW4gdGhlIFhSIHNlc3Npb24gaXMgc3RhcnRlZCwgYnV0IGltYWdlIHRyYWNraW5nIGZhaWxlZCB0byBwcm9jZXNzIHRoZSBwcm92aWRlZFxuICAgICAqIGltYWdlcy4gVGhlIGhhbmRsZXIgaXMgcGFzc2VkIHRoZSBFcnJvciBvYmplY3QuXG4gICAgICpcbiAgICAgKiBAZXZlbnRcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGFwcC54ci5pbWFnZVRyYWNraW5nLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgKiAgICAgY29uc29sZS5lcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICogfSk7XG4gICAgICovXG4gICAgc3RhdGljIEVWRU5UX0VSUk9SID0gJ2Vycm9yJztcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtpbXBvcnQoJy4veHItbWFuYWdlci5qcycpLlhyTWFuYWdlcn1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9tYW5hZ2VyO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBfc3VwcG9ydGVkID0gcGxhdGZvcm0uYnJvd3NlciAmJiAhIXdpbmRvdy5YUkltYWdlVHJhY2tpbmdSZXN1bHQ7XG5cbiAgICAgLyoqXG4gICAgICAqIEB0eXBlIHtib29sZWFufVxuICAgICAgKiBAcHJpdmF0ZVxuICAgICAgKi9cbiAgICBfYXZhaWxhYmxlID0gZmFsc2U7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7WHJUcmFja2VkSW1hZ2VbXX1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9pbWFnZXMgPSBbXTtcblxuICAgIC8qKlxuICAgICAqIEltYWdlIFRyYWNraW5nIHByb3ZpZGVzIHRoZSBhYmlsaXR5IHRvIHRyYWNrIHJlYWwgd29ybGQgaW1hZ2VzIGJ5IHByb3ZpZGVkIGltYWdlIHNhbXBsZXMgYW5kXG4gICAgICogdGhlaXIgZXN0aW1hdGUgc2l6ZXMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi94ci1tYW5hZ2VyLmpzJykuWHJNYW5hZ2VyfSBtYW5hZ2VyIC0gV2ViWFIgTWFuYWdlci5cbiAgICAgKiBAaGlkZWNvbnN0cnVjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobWFuYWdlcikge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuX21hbmFnZXIgPSBtYW5hZ2VyO1xuXG4gICAgICAgIGlmICh0aGlzLl9zdXBwb3J0ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX21hbmFnZXIub24oJ3N0YXJ0JywgdGhpcy5fb25TZXNzaW9uU3RhcnQsIHRoaXMpO1xuICAgICAgICAgICAgdGhpcy5fbWFuYWdlci5vbignZW5kJywgdGhpcy5fb25TZXNzaW9uRW5kLCB0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbiBpbWFnZSBmb3IgaW1hZ2UgdHJhY2tpbmcuIEEgd2lkdGggY2FuIGFsc28gYmUgcHJvdmlkZWQgdG8gaGVscCB0aGUgdW5kZXJseWluZyBzeXN0ZW1cbiAgICAgKiBlc3RpbWF0ZSB0aGUgYXBwcm9wcmlhdGUgdHJhbnNmb3JtYXRpb24uIE1vZGlmeWluZyB0aGUgdHJhY2tlZCBpbWFnZXMgbGlzdCBpcyBvbmx5IHBvc3NpYmxlXG4gICAgICogYmVmb3JlIGFuIEFSIHNlc3Npb24gaXMgc3RhcnRlZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR8SFRNTEltYWdlRWxlbWVudHxTVkdJbWFnZUVsZW1lbnR8SFRNTFZpZGVvRWxlbWVudHxCbG9ifEltYWdlRGF0YXxJbWFnZUJpdG1hcH0gaW1hZ2UgLSBJbWFnZVxuICAgICAqIHRoYXQgaXMgbWF0Y2hpbmcgcmVhbCB3b3JsZCBpbWFnZSBhcyBjbG9zZSBhcyBwb3NzaWJsZS4gUmVzb2x1dGlvbiBvZiBpbWFnZXMgc2hvdWxkIGJlIGF0XG4gICAgICogbGVhc3QgMzAweDMwMC4gSGlnaCByZXNvbHV0aW9uIGRvZXMgTk9UIGltcHJvdmUgdHJhY2tpbmcgcGVyZm9ybWFuY2UuIENvbG9yIG9mIGltYWdlIGlzXG4gICAgICogaXJyZWxldmFudCwgc28gZ3JheXNjYWxlIGltYWdlcyBjYW4gYmUgdXNlZC4gSW1hZ2VzIHdpdGggdG9vIG1hbnkgZ2VvbWV0cmljIGZlYXR1cmVzIG9yXG4gICAgICogcmVwZWF0aW5nIHBhdHRlcm5zIHdpbGwgcmVkdWNlIHRyYWNraW5nIHN0YWJpbGl0eS5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBXaWR0aCAoaW4gbWV0ZXJzKSBvZiBpbWFnZSBpbiB0aGUgcmVhbCB3b3JsZC4gUHJvdmlkaW5nIHRoaXMgdmFsdWVcbiAgICAgKiBhcyBjbG9zZSB0byB0aGUgcmVhbCB2YWx1ZSB3aWxsIGltcHJvdmUgdHJhY2tpbmcgcXVhbGl0eS5cbiAgICAgKiBAcmV0dXJucyB7WHJUcmFja2VkSW1hZ2V8bnVsbH0gVHJhY2tlZCBpbWFnZSBvYmplY3QgdGhhdCB3aWxsIGNvbnRhaW4gdHJhY2tpbmcgaW5mb3JtYXRpb24uXG4gICAgICogUmV0dXJucyBudWxsIGlmIGltYWdlIHRyYWNraW5nIGlzIG5vdCBzdXBwb3J0ZWQgb3IgaWYgdGhlIFhSIG1hbmFnZXIgaXMgbm90IGFjdGl2ZS5cbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIC8vIGltYWdlIG9mIGEgYm9vayBjb3ZlciB0aGF0IGhhcyB3aWR0aCBvZiAyMGNtICgwLjJtKVxuICAgICAqIGFwcC54ci5pbWFnZVRyYWNraW5nLmFkZChib29rQ292ZXJJbWcsIDAuMik7XG4gICAgICovXG4gICAgYWRkKGltYWdlLCB3aWR0aCkge1xuICAgICAgICBpZiAoIXRoaXMuX3N1cHBvcnRlZCB8fCB0aGlzLl9tYW5hZ2VyLmFjdGl2ZSkgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgY29uc3QgdHJhY2tlZEltYWdlID0gbmV3IFhyVHJhY2tlZEltYWdlKGltYWdlLCB3aWR0aCk7XG4gICAgICAgIHRoaXMuX2ltYWdlcy5wdXNoKHRyYWNrZWRJbWFnZSk7XG4gICAgICAgIHJldHVybiB0cmFja2VkSW1hZ2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGltYWdlIGZyb20gaW1hZ2UgdHJhY2tpbmcuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge1hyVHJhY2tlZEltYWdlfSB0cmFja2VkSW1hZ2UgLSBUcmFja2VkIGltYWdlIHRvIGJlIHJlbW92ZWQuIE1vZGlmeWluZyB0aGUgdHJhY2tlZFxuICAgICAqIGltYWdlcyBsaXN0IGlzIG9ubHkgcG9zc2libGUgYmVmb3JlIGFuIEFSIHNlc3Npb24gaXMgc3RhcnRlZC5cbiAgICAgKi9cbiAgICByZW1vdmUodHJhY2tlZEltYWdlKSB7XG4gICAgICAgIGlmICh0aGlzLl9tYW5hZ2VyLmFjdGl2ZSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IGluZCA9IHRoaXMuX2ltYWdlcy5pbmRleE9mKHRyYWNrZWRJbWFnZSk7XG4gICAgICAgIGlmIChpbmQgIT09IC0xKSB7XG4gICAgICAgICAgICB0cmFja2VkSW1hZ2UuZGVzdHJveSgpO1xuICAgICAgICAgICAgdGhpcy5faW1hZ2VzLnNwbGljZShpbmQsIDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIEBwcml2YXRlICovXG4gICAgX29uU2Vzc2lvblN0YXJ0KCkge1xuICAgICAgICB0aGlzLl9tYW5hZ2VyLnNlc3Npb24uZ2V0VHJhY2tlZEltYWdlU2NvcmVzKCkudGhlbigoaW1hZ2VzKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9hdmFpbGFibGUgPSB0cnVlO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGltYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHRoaXMuX2ltYWdlc1tpXS5fdHJhY2thYmxlID0gaW1hZ2VzW2ldID09PSAndHJhY2thYmxlJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgdGhpcy5fYXZhaWxhYmxlID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmZpcmUoJ2Vycm9yJywgZXJyKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqIEBwcml2YXRlICovXG4gICAgX29uU2Vzc2lvbkVuZCgpIHtcbiAgICAgICAgdGhpcy5fYXZhaWxhYmxlID0gZmFsc2U7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9pbWFnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGltYWdlID0gdGhpcy5faW1hZ2VzW2ldO1xuICAgICAgICAgICAgaW1hZ2UuX3Bvc2UgPSBudWxsO1xuICAgICAgICAgICAgaW1hZ2UuX21lYXN1cmVkV2lkdGggPSAwO1xuXG4gICAgICAgICAgICBpZiAoaW1hZ2UuX3RyYWNraW5nKSB7XG4gICAgICAgICAgICAgICAgaW1hZ2UuX3RyYWNraW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaW1hZ2UuZmlyZSgndW50cmFja2VkJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayAtIEZ1bmN0aW9uIHRvIGNhbGwgd2hlbiBhbGwgaW1hZ2VzIGhhdmUgYmVlbiBwcmVwYXJlZCBhcyBpbWFnZVxuICAgICAqIGJpdG1hcHMuXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIHByZXBhcmVJbWFnZXMoY2FsbGJhY2spIHtcbiAgICAgICAgaWYgKHRoaXMuX2ltYWdlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIFByb21pc2UuYWxsKHRoaXMuX2ltYWdlcy5tYXAoZnVuY3Rpb24gKHRyYWNrZWRJbWFnZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cmFja2VkSW1hZ2UucHJlcGFyZSgpO1xuICAgICAgICAgICAgfSkpLnRoZW4oZnVuY3Rpb24gKGJpdG1hcHMpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCBiaXRtYXBzKTtcbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIsIG51bGwpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBudWxsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7Kn0gZnJhbWUgLSBYUkZyYW1lIGZyb20gcmVxdWVzdEFuaW1hdGlvbkZyYW1lIGNhbGxiYWNrLlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICB1cGRhdGUoZnJhbWUpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9hdmFpbGFibGUpIHJldHVybjtcblxuICAgICAgICBjb25zdCByZXN1bHRzID0gZnJhbWUuZ2V0SW1hZ2VUcmFja2luZ1Jlc3VsdHMoKTtcbiAgICAgICAgY29uc3QgaW5kZXggPSB7IH07XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpbmRleFtyZXN1bHRzW2ldLmluZGV4XSA9IHJlc3VsdHNbaV07XG5cbiAgICAgICAgICAgIGNvbnN0IHRyYWNrZWRJbWFnZSA9IHRoaXMuX2ltYWdlc1tyZXN1bHRzW2ldLmluZGV4XTtcbiAgICAgICAgICAgIHRyYWNrZWRJbWFnZS5fZW11bGF0ZWQgPSByZXN1bHRzW2ldLnRyYWNraW5nU3RhdGUgPT09ICdlbXVsYXRlZCc7XG4gICAgICAgICAgICB0cmFja2VkSW1hZ2UuX21lYXN1cmVkV2lkdGggPSByZXN1bHRzW2ldLm1lYXN1cmVkV2lkdGhJbk1ldGVycztcbiAgICAgICAgICAgIHRyYWNrZWRJbWFnZS5fcG9zZSA9IGZyYW1lLmdldFBvc2UocmVzdWx0c1tpXS5pbWFnZVNwYWNlLCB0aGlzLl9tYW5hZ2VyLl9yZWZlcmVuY2VTcGFjZSk7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2ltYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2ltYWdlc1tpXS5fdHJhY2tpbmcgJiYgIWluZGV4W2ldKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5faW1hZ2VzW2ldLl90cmFja2luZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMuX2ltYWdlc1tpXS5maXJlKCd1bnRyYWNrZWQnKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX2ltYWdlc1tpXS5fdHJhY2tpbmcgJiYgaW5kZXhbaV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9pbWFnZXNbaV0uX3RyYWNraW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLl9pbWFnZXNbaV0uZmlyZSgndHJhY2tlZCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJ1ZSBpZiBJbWFnZSBUcmFja2luZyBpcyBzdXBwb3J0ZWQuXG4gICAgICpcbiAgICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBnZXQgc3VwcG9ydGVkKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc3VwcG9ydGVkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRydWUgaWYgSW1hZ2UgVHJhY2tpbmcgaXMgYXZhaWxhYmxlLiBUaGlzIGluZm9ybWF0aW9uIGlzIG9ubHkgYXZhaWxhYmxlIHdoZW4gdGhlXG4gICAgICogWFIgc2Vzc2lvbiBoYXMgc3RhcnRlZCwgYW5kIHdpbGwgYmUgdHJ1ZSBpZiBpbWFnZSB0cmFja2luZyBpcyBzdXBwb3J0ZWQgYW5kXG4gICAgICogaW1hZ2VzIHdlcmUgcHJvdmlkZWQgYW5kIHRoZXkgaGF2ZSBiZWVuIHByb2Nlc3NlZCBzdWNjZXNzZnVsbHkuXG4gICAgICpcbiAgICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBnZXQgYXZhaWxhYmxlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fYXZhaWxhYmxlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExpc3Qgb2Yge0BsaW5rIFhyVHJhY2tlZEltYWdlfSB0aGF0IGNvbnRhaW4gdHJhY2tpbmcgaW5mb3JtYXRpb24uXG4gICAgICpcbiAgICAgKiBAdHlwZSB7WHJUcmFja2VkSW1hZ2VbXX1cbiAgICAgKi9cbiAgICBnZXQgaW1hZ2VzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgWHJJbWFnZVRyYWNraW5nIH07XG4iXSwibmFtZXMiOlsiWHJJbWFnZVRyYWNraW5nIiwiRXZlbnRIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJtYW5hZ2VyIiwiX21hbmFnZXIiLCJfc3VwcG9ydGVkIiwicGxhdGZvcm0iLCJicm93c2VyIiwid2luZG93IiwiWFJJbWFnZVRyYWNraW5nUmVzdWx0IiwiX2F2YWlsYWJsZSIsIl9pbWFnZXMiLCJvbiIsIl9vblNlc3Npb25TdGFydCIsIl9vblNlc3Npb25FbmQiLCJhZGQiLCJpbWFnZSIsIndpZHRoIiwiYWN0aXZlIiwidHJhY2tlZEltYWdlIiwiWHJUcmFja2VkSW1hZ2UiLCJwdXNoIiwicmVtb3ZlIiwiaW5kIiwiaW5kZXhPZiIsImRlc3Ryb3kiLCJzcGxpY2UiLCJzZXNzaW9uIiwiZ2V0VHJhY2tlZEltYWdlU2NvcmVzIiwidGhlbiIsImltYWdlcyIsImkiLCJsZW5ndGgiLCJfdHJhY2thYmxlIiwiY2F0Y2giLCJlcnIiLCJmaXJlIiwiX3Bvc2UiLCJfbWVhc3VyZWRXaWR0aCIsIl90cmFja2luZyIsInByZXBhcmVJbWFnZXMiLCJjYWxsYmFjayIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJwcmVwYXJlIiwiYml0bWFwcyIsInVwZGF0ZSIsImZyYW1lIiwicmVzdWx0cyIsImdldEltYWdlVHJhY2tpbmdSZXN1bHRzIiwiaW5kZXgiLCJfZW11bGF0ZWQiLCJ0cmFja2luZ1N0YXRlIiwibWVhc3VyZWRXaWR0aEluTWV0ZXJzIiwiZ2V0UG9zZSIsImltYWdlU3BhY2UiLCJfcmVmZXJlbmNlU3BhY2UiLCJzdXBwb3J0ZWQiLCJhdmFpbGFibGUiLCJFVkVOVF9FUlJPUiJdLCJtYXBwaW5ncyI6Ijs7OztBQUtBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQSxlQUFlLFNBQVNDLFlBQVksQ0FBQztBQXFDdkM7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFD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
