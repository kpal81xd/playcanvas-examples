import { Debug } from '../../core/debug.js';
import { EventHandler } from '../../core/event-handler.js';
import { script } from '../script.js';
import { AppBase } from '../app-base.js';
import { ScriptAttributes } from './script-attributes.js';
import { ScriptType } from './script-type.js';
import { ScriptTypes } from './script-types.js';

const reservedScriptNames = new Set(['system', 'entity', 'create', 'destroy', 'swap', 'move', 'data', 'scripts', '_scripts', '_scriptsIndex', '_scriptsData', 'enabled', '_oldState', 'onEnable', 'onDisable', 'onPostStateChange', '_onSetEnabled', '_checkState', '_onBeforeRemove', '_onInitializeAttributes', '_onInitialize', '_onPostInitialize', '_onUpdate', '_onPostUpdate', '_callbacks', '_callbackActive', 'has', 'get', 'on', 'off', 'fire', 'once', 'hasEvent']);
function getReservedScriptNames() {
  return reservedScriptNames;
}

/**
 * Create and register a new {@link ScriptType}. It returns new class type (constructor function),
 * which is auto-registered to {@link ScriptRegistry} using its name. This is the main interface to
 * create Script Types, to define custom logic using JavaScript, that is used to create interaction
 * for entities.
 *
 * @param {string} name - Unique Name of a Script Type. If a Script Type with the same name has
 * already been registered and the new one has a `swap` method defined in its prototype, then it
 * will perform hot swapping of existing Script Instances on entities using this new Script Type.
 * Note: There is a reserved list of names that cannot be used, such as list below as well as some
 * starting from `_` (underscore): system, entity, create, destroy, swap, move, scripts, onEnable,
 * onDisable, onPostStateChange, has, on, off, fire, once, hasEvent.
 * @param {AppBase} [app] - Optional application handler, to choose which {@link ScriptRegistry}
 * to add a script to. By default it will use `Application.getApplication()` to get current
 * {@link AppBase}.
 * @returns {Class<ScriptType>|null} A class type (constructor function) that inherits {@link ScriptType},
 * which the developer is meant to further extend by adding attributes and prototype methods.
 * Returns null if there was an error.
 * @example
 * var Turning = pc.createScript('turn');
 *
 * // define 'speed' attribute that is available in Editor UI
 * Turning.attributes.add('speed', {
 *     type: 'number',
 *     default: 180,
 *     placeholder: 'deg/s'
 * });
 *
 * // runs every tick
 * Turning.prototype.update = function (dt) {
 *     this.entity.rotate(0, this.speed * dt, 0);
 * };
 * @category Script
 */
function createScript(name, app) {
  if (script.legacy) {
    Debug.error('This project is using the legacy script system. You cannot call pc.createScript().');
    return null;
  }
  if (reservedScriptNames.has(name)) throw new Error(`Script name '${name}' is reserved, please rename the script`);
  const scriptType = function scriptType(args) {
    EventHandler.prototype.initEventHandler.call(this);
    ScriptType.prototype.initScriptType.call(this, args);
  };
  scriptType.prototype = Object.create(ScriptType.prototype);
  scriptType.prototype.constructor = scriptType;
  scriptType.extend = ScriptType.extend;
  scriptType.attributes = new ScriptAttributes(scriptType);
  registerScript(scriptType, name, app);
  return scriptType;
}

// Editor uses this - migrate to ScriptAttributes.reservedNames and delete this
const reservedAttributes = {};
ScriptAttributes.reservedNames.forEach((value, value2, set) => {
  reservedAttributes[value] = 1;
});
createScript.reservedAttributes = reservedAttributes;

/* eslint-disable jsdoc/check-examples */
/**
 * Register a existing class type as a Script Type to {@link ScriptRegistry}. Useful when defining
 * a ES6 script class that extends {@link ScriptType} (see example).
 *
 * @param {Class<ScriptType>} script - The existing class type (constructor function) to be
 * registered as a Script Type. Class must extend {@link ScriptType} (see example). Please note: A
 * class created using {@link createScript} is auto-registered, and should therefore not be pass
 * into {@link registerScript} (which would result in swapping out all related script instances).
 * @param {string} [name] - Optional unique name of the Script Type. By default it will use the
 * same name as the existing class. If a Script Type with the same name has already been registered
 * and the new one has a `swap` method defined in its prototype, then it will perform hot swapping
 * of existing Script Instances on entities using this new Script Type. Note: There is a reserved
 * list of names that cannot be used, such as list below as well as some starting from `_`
 * (underscore): system, entity, create, destroy, swap, move, scripts, onEnable, onDisable,
 * onPostStateChange, has, on, off, fire, once, hasEvent.
 * @param {AppBase} [app] - Optional application handler, to choose which {@link ScriptRegistry}
 * to register the script type to. By default it will use `Application.getApplication()` to get
 * current {@link AppBase}.
 * @example
 * // define a ES6 script class
 * class PlayerController extends pc.ScriptType {
 *
 *     initialize() {
 *         // called once on initialize
 *     }
 *
 *     update(dt) {
 *         // called each tick
 *     }
 * }
 *
 * // register the class as a script
 * pc.registerScript(PlayerController);
 *
 * // declare script attributes (Must be after pc.registerScript())
 * PlayerController.attributes.add('attribute1', {type: 'number'});
 * @category Script
 */
function registerScript(script, name, app) {
  if (script.legacy) {
    Debug.error('This project is using the legacy script system. You cannot call pc.registerScript().');
    return;
  }
  if (typeof script !== 'function') throw new Error(`script class: '${script}' must be a constructor function (i.e. class).`);
  if (!(script.prototype instanceof ScriptType)) throw new Error(`script class: '${ScriptType.__getScriptName(script)}' does not extend pc.ScriptType.`);
  name = name || script.__name || ScriptType.__getScriptName(script);
  if (reservedScriptNames.has(name)) throw new Error(`script name: '${name}' is reserved, please change script name`);
  script.__name = name;

  // add to scripts registry
  const registry = app ? app.scripts : AppBase.getApplication().scripts;
  registry.add(script);
  ScriptTypes.push(script, script.legacy);
}

export { createScript, getReservedScriptNames, registerScript };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyaXB0LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL3NjcmlwdC9zY3JpcHQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVidWcgfSBmcm9tICcuLi8uLi9jb3JlL2RlYnVnLmpzJztcbmltcG9ydCB7IEV2ZW50SGFuZGxlciB9IGZyb20gJy4uLy4uL2NvcmUvZXZlbnQtaGFuZGxlci5qcyc7XG5cbmltcG9ydCB7IHNjcmlwdCB9IGZyb20gJy4uL3NjcmlwdC5qcyc7XG5pbXBvcnQgeyBBcHBCYXNlIH0gZnJvbSAnLi4vYXBwLWJhc2UuanMnO1xuXG5pbXBvcnQgeyBTY3JpcHRBdHRyaWJ1dGVzIH0gZnJvbSAnLi9zY3JpcHQtYXR0cmlidXRlcy5qcyc7XG5pbXBvcnQgeyBTY3JpcHRUeXBlIH0gZnJvbSAnLi9zY3JpcHQtdHlwZS5qcyc7XG5pbXBvcnQgeyBTY3JpcHRUeXBlcyB9IGZyb20gJy4vc2NyaXB0LXR5cGVzLmpzJztcblxuY29uc3QgcmVzZXJ2ZWRTY3JpcHROYW1lcyA9IG5ldyBTZXQoW1xuICAgICdzeXN0ZW0nLCAnZW50aXR5JywgJ2NyZWF0ZScsICdkZXN0cm95JywgJ3N3YXAnLCAnbW92ZScsICdkYXRhJyxcbiAgICAnc2NyaXB0cycsICdfc2NyaXB0cycsICdfc2NyaXB0c0luZGV4JywgJ19zY3JpcHRzRGF0YScsXG4gICAgJ2VuYWJsZWQnLCAnX29sZFN0YXRlJywgJ29uRW5hYmxlJywgJ29uRGlzYWJsZScsICdvblBvc3RTdGF0ZUNoYW5nZScsXG4gICAgJ19vblNldEVuYWJsZWQnLCAnX2NoZWNrU3RhdGUnLCAnX29uQmVmb3JlUmVtb3ZlJyxcbiAgICAnX29uSW5pdGlhbGl6ZUF0dHJpYnV0ZXMnLCAnX29uSW5pdGlhbGl6ZScsICdfb25Qb3N0SW5pdGlhbGl6ZScsXG4gICAgJ19vblVwZGF0ZScsICdfb25Qb3N0VXBkYXRlJyxcbiAgICAnX2NhbGxiYWNrcycsICdfY2FsbGJhY2tBY3RpdmUnLCAnaGFzJywgJ2dldCcsICdvbicsICdvZmYnLCAnZmlyZScsICdvbmNlJywgJ2hhc0V2ZW50J1xuXSk7XG5cbmZ1bmN0aW9uIGdldFJlc2VydmVkU2NyaXB0TmFtZXMoKSB7XG4gICAgcmV0dXJuIHJlc2VydmVkU2NyaXB0TmFtZXM7XG59XG5cbi8qKlxuICogQ3JlYXRlIGFuZCByZWdpc3RlciBhIG5ldyB7QGxpbmsgU2NyaXB0VHlwZX0uIEl0IHJldHVybnMgbmV3IGNsYXNzIHR5cGUgKGNvbnN0cnVjdG9yIGZ1bmN0aW9uKSxcbiAqIHdoaWNoIGlzIGF1dG8tcmVnaXN0ZXJlZCB0byB7QGxpbmsgU2NyaXB0UmVnaXN0cnl9IHVzaW5nIGl0cyBuYW1lLiBUaGlzIGlzIHRoZSBtYWluIGludGVyZmFjZSB0b1xuICogY3JlYXRlIFNjcmlwdCBUeXBlcywgdG8gZGVmaW5lIGN1c3RvbSBsb2dpYyB1c2luZyBKYXZhU2NyaXB0LCB0aGF0IGlzIHVzZWQgdG8gY3JlYXRlIGludGVyYWN0aW9uXG4gKiBmb3IgZW50aXRpZXMuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBVbmlxdWUgTmFtZSBvZiBhIFNjcmlwdCBUeXBlLiBJZiBhIFNjcmlwdCBUeXBlIHdpdGggdGhlIHNhbWUgbmFtZSBoYXNcbiAqIGFscmVhZHkgYmVlbiByZWdpc3RlcmVkIGFuZCB0aGUgbmV3IG9uZSBoYXMgYSBgc3dhcGAgbWV0aG9kIGRlZmluZWQgaW4gaXRzIHByb3RvdHlwZSwgdGhlbiBpdFxuICogd2lsbCBwZXJmb3JtIGhvdCBzd2FwcGluZyBvZiBleGlzdGluZyBTY3JpcHQgSW5zdGFuY2VzIG9uIGVudGl0aWVzIHVzaW5nIHRoaXMgbmV3IFNjcmlwdCBUeXBlLlxuICogTm90ZTogVGhlcmUgaXMgYSByZXNlcnZlZCBsaXN0IG9mIG5hbWVzIHRoYXQgY2Fubm90IGJlIHVzZWQsIHN1Y2ggYXMgbGlzdCBiZWxvdyBhcyB3ZWxsIGFzIHNvbWVcbiAqIHN0YXJ0aW5nIGZyb20gYF9gICh1bmRlcnNjb3JlKTogc3lzdGVtLCBlbnRpdHksIGNyZWF0ZSwgZGVzdHJveSwgc3dhcCwgbW92ZSwgc2NyaXB0cywgb25FbmFibGUsXG4gKiBvbkRpc2FibGUsIG9uUG9zdFN0YXRlQ2hhbmdlLCBoYXMsIG9uLCBvZmYsIGZpcmUsIG9uY2UsIGhhc0V2ZW50LlxuICogQHBhcmFtIHtBcHBCYXNlfSBbYXBwXSAtIE9wdGlvbmFsIGFwcGxpY2F0aW9uIGhhbmRsZXIsIHRvIGNob29zZSB3aGljaCB7QGxpbmsgU2NyaXB0UmVnaXN0cnl9XG4gKiB0byBhZGQgYSBzY3JpcHQgdG8uIEJ5IGRlZmF1bHQgaXQgd2lsbCB1c2UgYEFwcGxpY2F0aW9uLmdldEFwcGxpY2F0aW9uKClgIHRvIGdldCBjdXJyZW50XG4gKiB7QGxpbmsgQXBwQmFzZX0uXG4gKiBAcmV0dXJucyB7Q2xhc3M8U2NyaXB0VHlwZT58bnVsbH0gQSBjbGFzcyB0eXBlIChjb25zdHJ1Y3RvciBmdW5jdGlvbikgdGhhdCBpbmhlcml0cyB7QGxpbmsgU2NyaXB0VHlwZX0sXG4gKiB3aGljaCB0aGUgZGV2ZWxvcGVyIGlzIG1lYW50IHRvIGZ1cnRoZXIgZXh0ZW5kIGJ5IGFkZGluZyBhdHRyaWJ1dGVzIGFuZCBwcm90b3R5cGUgbWV0aG9kcy5cbiAqIFJldHVybnMgbnVsbCBpZiB0aGVyZSB3YXMgYW4gZXJyb3IuXG4gKiBAZXhhbXBsZVxuICogdmFyIFR1cm5pbmcgPSBwYy5jcmVhdGVTY3JpcHQoJ3R1cm4nKTtcbiAqXG4gKiAvLyBkZWZpbmUgJ3NwZWVkJyBhdHRyaWJ1dGUgdGhhdCBpcyBhdmFpbGFibGUgaW4gRWRpdG9yIFVJXG4gKiBUdXJuaW5nLmF0dHJpYnV0ZXMuYWRkKCdzcGVlZCcsIHtcbiAqICAgICB0eXBlOiAnbnVtYmVyJyxcbiAqICAgICBkZWZhdWx0OiAxODAsXG4gKiAgICAgcGxhY2Vob2xkZXI6ICdkZWcvcydcbiAqIH0pO1xuICpcbiAqIC8vIHJ1bnMgZXZlcnkgdGlja1xuICogVHVybmluZy5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKGR0KSB7XG4gKiAgICAgdGhpcy5lbnRpdHkucm90YXRlKDAsIHRoaXMuc3BlZWQgKiBkdCwgMCk7XG4gKiB9O1xuICogQGNhdGVnb3J5IFNjcmlwdFxuICovXG5mdW5jdGlvbiBjcmVhdGVTY3JpcHQobmFtZSwgYXBwKSB7XG4gICAgaWYgKHNjcmlwdC5sZWdhY3kpIHtcbiAgICAgICAgRGVidWcuZXJyb3IoJ1RoaXMgcHJvamVjdCBpcyB1c2luZyB0aGUgbGVnYWN5IHNjcmlwdCBzeXN0ZW0uIFlvdSBjYW5ub3QgY2FsbCBwYy5jcmVhdGVTY3JpcHQoKS4nKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHJlc2VydmVkU2NyaXB0TmFtZXMuaGFzKG5hbWUpKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFNjcmlwdCBuYW1lICcke25hbWV9JyBpcyByZXNlcnZlZCwgcGxlYXNlIHJlbmFtZSB0aGUgc2NyaXB0YCk7XG5cbiAgICBjb25zdCBzY3JpcHRUeXBlID0gZnVuY3Rpb24gKGFyZ3MpIHtcbiAgICAgICAgRXZlbnRIYW5kbGVyLnByb3RvdHlwZS5pbml0RXZlbnRIYW5kbGVyLmNhbGwodGhpcyk7XG4gICAgICAgIFNjcmlwdFR5cGUucHJvdG90eXBlLmluaXRTY3JpcHRUeXBlLmNhbGwodGhpcywgYXJncyk7XG4gICAgfTtcblxuICAgIHNjcmlwdFR5cGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTY3JpcHRUeXBlLnByb3RvdHlwZSk7XG4gICAgc2NyaXB0VHlwZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBzY3JpcHRUeXBlO1xuXG4gICAgc2NyaXB0VHlwZS5leHRlbmQgPSBTY3JpcHRUeXBlLmV4dGVuZDtcbiAgICBzY3JpcHRUeXBlLmF0dHJpYnV0ZXMgPSBuZXcgU2NyaXB0QXR0cmlidXRlcyhzY3JpcHRUeXBlKTtcblxuICAgIHJlZ2lzdGVyU2NyaXB0KHNjcmlwdFR5cGUsIG5hbWUsIGFwcCk7XG4gICAgcmV0dXJuIHNjcmlwdFR5cGU7XG59XG5cbi8vIEVkaXRvciB1c2VzIHRoaXMgLSBtaWdyYXRlIHRvIFNjcmlwdEF0dHJpYnV0ZXMucmVzZXJ2ZWROYW1lcyBhbmQgZGVsZXRlIHRoaXNcbmNvbnN0IHJlc2VydmVkQXR0cmlidXRlcyA9IHt9O1xuU2NyaXB0QXR0cmlidXRlcy5yZXNlcnZlZE5hbWVzLmZvckVhY2goKHZhbHVlLCB2YWx1ZTIsIHNldCkgPT4ge1xuICAgIHJlc2VydmVkQXR0cmlidXRlc1t2YWx1ZV0gPSAxO1xufSk7XG5jcmVhdGVTY3JpcHQucmVzZXJ2ZWRBdHRyaWJ1dGVzID0gcmVzZXJ2ZWRBdHRyaWJ1dGVzO1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBqc2RvYy9jaGVjay1leGFtcGxlcyAqL1xuLyoqXG4gKiBSZWdpc3RlciBhIGV4aXN0aW5nIGNsYXNzIHR5cGUgYXMgYSBTY3JpcHQgVHlwZSB0byB7QGxpbmsgU2NyaXB0UmVnaXN0cnl9LiBVc2VmdWwgd2hlbiBkZWZpbmluZ1xuICogYSBFUzYgc2NyaXB0IGNsYXNzIHRoYXQgZXh0ZW5kcyB7QGxpbmsgU2NyaXB0VHlwZX0gKHNlZSBleGFtcGxlKS5cbiAqXG4gKiBAcGFyYW0ge0NsYXNzPFNjcmlwdFR5cGU+fSBzY3JpcHQgLSBUaGUgZXhpc3RpbmcgY2xhc3MgdHlwZSAoY29uc3RydWN0b3IgZnVuY3Rpb24pIHRvIGJlXG4gKiByZWdpc3RlcmVkIGFzIGEgU2NyaXB0IFR5cGUuIENsYXNzIG11c3QgZXh0ZW5kIHtAbGluayBTY3JpcHRUeXBlfSAoc2VlIGV4YW1wbGUpLiBQbGVhc2Ugbm90ZTogQVxuICogY2xhc3MgY3JlYXRlZCB1c2luZyB7QGxpbmsgY3JlYXRlU2NyaXB0fSBpcyBhdXRvLXJlZ2lzdGVyZWQsIGFuZCBzaG91bGQgdGhlcmVmb3JlIG5vdCBiZSBwYXNzXG4gKiBpbnRvIHtAbGluayByZWdpc3RlclNjcmlwdH0gKHdoaWNoIHdvdWxkIHJlc3VsdCBpbiBzd2FwcGluZyBvdXQgYWxsIHJlbGF0ZWQgc2NyaXB0IGluc3RhbmNlcykuXG4gKiBAcGFyYW0ge3N0cmluZ30gW25hbWVdIC0gT3B0aW9uYWwgdW5pcXVlIG5hbWUgb2YgdGhlIFNjcmlwdCBUeXBlLiBCeSBkZWZhdWx0IGl0IHdpbGwgdXNlIHRoZVxuICogc2FtZSBuYW1lIGFzIHRoZSBleGlzdGluZyBjbGFzcy4gSWYgYSBTY3JpcHQgVHlwZSB3aXRoIHRoZSBzYW1lIG5hbWUgaGFzIGFscmVhZHkgYmVlbiByZWdpc3RlcmVkXG4gKiBhbmQgdGhlIG5ldyBvbmUgaGFzIGEgYHN3YXBgIG1ldGhvZCBkZWZpbmVkIGluIGl0cyBwcm90b3R5cGUsIHRoZW4gaXQgd2lsbCBwZXJmb3JtIGhvdCBzd2FwcGluZ1xuICogb2YgZXhpc3RpbmcgU2NyaXB0IEluc3RhbmNlcyBvbiBlbnRpdGllcyB1c2luZyB0aGlzIG5ldyBTY3JpcHQgVHlwZS4gTm90ZTogVGhlcmUgaXMgYSByZXNlcnZlZFxuICogbGlzdCBvZiBuYW1lcyB0aGF0IGNhbm5vdCBiZSB1c2VkLCBzdWNoIGFzIGxpc3QgYmVsb3cgYXMgd2VsbCBhcyBzb21lIHN0YXJ0aW5nIGZyb20gYF9gXG4gKiAodW5kZXJzY29yZSk6IHN5c3RlbSwgZW50aXR5LCBjcmVhdGUsIGRlc3Ryb3ksIHN3YXAsIG1vdmUsIHNjcmlwdHMsIG9uRW5hYmxlLCBvbkRpc2FibGUsXG4gKiBvblBvc3RTdGF0ZUNoYW5nZSwgaGFzLCBvbiwgb2ZmLCBmaXJlLCBvbmNlLCBoYXNFdmVudC5cbiAqIEBwYXJhbSB7QXBwQmFzZX0gW2FwcF0gLSBPcHRpb25hbCBhcHBsaWNhdGlvbiBoYW5kbGVyLCB0byBjaG9vc2Ugd2hpY2gge0BsaW5rIFNjcmlwdFJlZ2lzdHJ5fVxuICogdG8gcmVnaXN0ZXIgdGhlIHNjcmlwdCB0eXBlIHRvLiBCeSBkZWZhdWx0IGl0IHdpbGwgdXNlIGBBcHBsaWNhdGlvbi5nZXRBcHBsaWNhdGlvbigpYCB0byBnZXRcbiAqIGN1cnJlbnQge0BsaW5rIEFwcEJhc2V9LlxuICogQGV4YW1wbGVcbiAqIC8vIGRlZmluZSBhIEVTNiBzY3JpcHQgY2xhc3NcbiAqIGNsYXNzIFBsYXllckNvbnRyb2xsZXIgZXh0ZW5kcyBwYy5TY3JpcHRUeXBlIHtcbiAqXG4gKiAgICAgaW5pdGlhbGl6ZSgpIHtcbiAqICAgICAgICAgLy8gY2FsbGVkIG9uY2Ugb24gaW5pdGlhbGl6ZVxuICogICAgIH1cbiAqXG4gKiAgICAgdXBkYXRlKGR0KSB7XG4gKiAgICAgICAgIC8vIGNhbGxlZCBlYWNoIHRpY2tcbiAqICAgICB9XG4gKiB9XG4gKlxuICogLy8gcmVnaXN0ZXIgdGhlIGNsYXNzIGFzIGEgc2NyaXB0XG4gKiBwYy5yZWdpc3RlclNjcmlwdChQbGF5ZXJDb250cm9sbGVyKTtcbiAqXG4gKiAvLyBkZWNsYXJlIHNjcmlwdCBhdHRyaWJ1dGVzIChNdXN0IGJlIGFmdGVyIHBjLnJlZ2lzdGVyU2NyaXB0KCkpXG4gKiBQbGF5ZXJDb250cm9sbGVyLmF0dHJpYnV0ZXMuYWRkKCdhdHRyaWJ1dGUxJywge3R5cGU6ICdudW1iZXInfSk7XG4gKiBAY2F0ZWdvcnkgU2NyaXB0XG4gKi9cbmZ1bmN0aW9uIHJlZ2lzdGVyU2NyaXB0KHNjcmlwdCwgbmFtZSwgYXBwKSB7XG4gICAgaWYgKHNjcmlwdC5sZWdhY3kpIHtcbiAgICAgICAgRGVidWcuZXJyb3IoJ1RoaXMgcHJvamVjdCBpcyB1c2luZyB0aGUgbGVnYWN5IHNjcmlwdCBzeXN0ZW0uIFlvdSBjYW5ub3QgY2FsbCBwYy5yZWdpc3RlclNjcmlwdCgpLicpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBzY3JpcHQgIT09ICdmdW5jdGlvbicpXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgc2NyaXB0IGNsYXNzOiAnJHtzY3JpcHR9JyBtdXN0IGJlIGEgY29uc3RydWN0b3IgZnVuY3Rpb24gKGkuZS4gY2xhc3MpLmApO1xuXG4gICAgaWYgKCEoc2NyaXB0LnByb3RvdHlwZSBpbnN0YW5jZW9mIFNjcmlwdFR5cGUpKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHNjcmlwdCBjbGFzczogJyR7U2NyaXB0VHlwZS5fX2dldFNjcmlwdE5hbWUoc2NyaXB0KX0nIGRvZXMgbm90IGV4dGVuZCBwYy5TY3JpcHRUeXBlLmApO1xuXG4gICAgbmFtZSA9IG5hbWUgfHwgc2NyaXB0Ll9fbmFtZSB8fCBTY3JpcHRUeXBlLl9fZ2V0U2NyaXB0TmFtZShzY3JpcHQpO1xuXG4gICAgaWYgKHJlc2VydmVkU2NyaXB0TmFtZXMuaGFzKG5hbWUpKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHNjcmlwdCBuYW1lOiAnJHtuYW1lfScgaXMgcmVzZXJ2ZWQsIHBsZWFzZSBjaGFuZ2Ugc2NyaXB0IG5hbWVgKTtcblxuICAgIHNjcmlwdC5fX25hbWUgPSBuYW1lO1xuXG4gICAgLy8gYWRkIHRvIHNjcmlwdHMgcmVnaXN0cnlcbiAgICBjb25zdCByZWdpc3RyeSA9IGFwcCA/IGFwcC5zY3JpcHRzIDogQXBwQmFzZS5nZXRBcHBsaWNhdGlvbigpLnNjcmlwdHM7XG4gICAgcmVnaXN0cnkuYWRkKHNjcmlwdCk7XG5cbiAgICBTY3JpcHRUeXBlcy5wdXNoKHNjcmlwdCwgc2NyaXB0LmxlZ2FjeSk7XG59XG4vKiBlc2xpbnQtZW5hYmxlIGpzZG9jL2NoZWNrLWV4YW1wbGVzICovXG5cbmV4cG9ydCB7IGNyZWF0ZVNjcmlwdCwgcmVnaXN0ZXJTY3JpcHQsIGdldFJlc2VydmVkU2NyaXB0TmFtZXMgfTtcbiJdLCJuYW1lcyI6WyJyZXNlcnZlZFNjcmlwdE5hbWVzIiwiU2V0IiwiZ2V0UmVzZXJ2ZWRTY3JpcHROYW1lcyIsImNyZWF0ZVNjcmlwdCIsIm5hbWUiLCJhcHAiLCJzY3JpcHQiLCJsZWdhY3kiLCJEZWJ1ZyIsImVycm9yIiwiaGFzIiwiRXJyb3IiLCJzY3JpcHRUeXBlIiwiYXJncyIsIkV2ZW50SGFuZGxlciIsInByb3RvdHlwZSIsImluaXRFdmVudEhhbmRsZXIiLCJjYWxsIiwiU2NyaXB0VHlwZSIsImluaXRTY3JpcHRUeXBlIiwiT2JqZWN0IiwiY3JlYXRlIiwiY29uc3RydWN0b3IiLCJleHRlbmQiLCJhdHRyaWJ1dGVzIiwiU2NyaXB0QXR0cmlidXRlcyIsInJlZ2lzdGVyU2NyaXB0IiwicmVzZXJ2ZWRBdHRyaWJ1dGVzIiwicmVzZXJ2ZWROYW1lcyIsImZvckVhY2giLCJ2YWx1ZSIsInZhbHVlMiIsInNldCIsIl9fZ2V0U2NyaXB0TmFtZSIsIl9fbmFtZSIsInJlZ2lzdHJ5Iiwic2NyaXB0cyIsIkFwcEJhc2UiLCJnZXRBcHBsaWNhdGlvbiIsImFkZCIsIlNjcmlwdFR5cGVzIiwicHVzaCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFVQSxNQUFNQSxtQkFBbUIsR0FBRyxJQUFJQyxHQUFHLENBQUMsQ0FDaEMsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUMvRCxTQUFTLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQ3RELFNBQVMsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxtQkFBbUIsRUFDcEUsZUFBZSxFQUFFLGFBQWEsRUFBRSxpQkFBaUIsRUFDakQseUJBQXlCLEVBQUUsZUFBZSxFQUFFLG1CQUFtQixFQUMvRCxXQUFXLEVBQUUsZUFBZSxFQUM1QixZQUFZLEVBQUUsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsVUFBVSxDQUN6RixDQUFDLENBQUE7QUFFRixTQUFTQyxzQkFBc0JBLEdBQUc7QUFDOUIsRUFBQSxPQUFPRixtQkFBbUIsQ0FBQTtBQUM5QixDQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBU0csWUFBWUEsQ0FBQ0MsSUFBSSxFQUFFQyxHQUFHLEVBQUU7RUFDN0IsSUFBSUMsTUFBTSxDQUFDQyxNQUFNLEVBQUU7QUFDZkMsSUFBQUEsS0FBSyxDQUFDQyxLQUFLLENBQUMsb0ZBQW9GLENBQUMsQ0FBQTtBQUNqRyxJQUFBLE9BQU8sSUFBSSxDQUFBO0FBQ2YsR0FBQTtBQUVBLEVBQUEsSUFBSVQsbUJBQW1CLENBQUNVLEdBQUcsQ0FBQ04sSUFBSSxDQUFDLEVBQzdCLE1BQU0sSUFBSU8sS0FBSyxDQUFFLENBQWVQLGFBQUFBLEVBQUFBLElBQUsseUNBQXdDLENBQUMsQ0FBQTtBQUVsRixFQUFBLE1BQU1RLFVBQVUsR0FBRyxTQUFiQSxVQUFVQSxDQUFhQyxJQUFJLEVBQUU7SUFDL0JDLFlBQVksQ0FBQ0MsU0FBUyxDQUFDQyxnQkFBZ0IsQ0FBQ0MsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ2xEQyxVQUFVLENBQUNILFNBQVMsQ0FBQ0ksY0FBYyxDQUFDRixJQUFJLENBQUMsSUFBSSxFQUFFSixJQUFJLENBQUMsQ0FBQTtHQUN2RCxDQUFBO0VBRURELFVBQVUsQ0FBQ0csU0FBUyxHQUFHSyxNQUFNLENBQUNDLE1BQU0sQ0FBQ0gsVUFBVSxDQUFDSCxTQUFTLENBQUMsQ0FBQTtBQUMxREgsRUFBQUEsVUFBVSxDQUFDRyxTQUFTLENBQUNPLFdBQVcsR0FBR1YsVUFBVSxDQUFBO0FBRTdDQSxFQUFBQSxVQUFVLENBQUNXLE1BQU0sR0FBR0wsVUFBVSxDQUFDSyxNQUFNLENBQUE7QUFDckNYLEVBQUFBLFVBQVUsQ0FBQ1ksVUFBVSxHQUFHLElBQUlDLGdCQUFnQixDQUFDYixVQUFVLENBQUMsQ0FBQTtBQUV4RGMsRUFBQUEsY0FBYyxDQUFDZCxVQUFVLEVBQUVSLElBQUksRUFBRUMsR0FBRyxDQUFDLENBQUE7QUFDckMsRUFBQSxPQUFPTyxVQUFVLENBQUE7QUFDckIsQ0FBQTs7QUFFQTtBQUNBLE1BQU1lLGtCQUFrQixHQUFHLEVBQUUsQ0FBQTtBQUM3QkYsZ0JBQWdCLENBQUNHLGFBQWEsQ0FBQ0MsT0FBTyxDQUFDLENBQUNDLEtBQUssRUFBRUMsTUFBTSxFQUFFQyxHQUFHLEtBQUs7QUFDM0RMLEVBQUFBLGtCQUFrQixDQUFDRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDakMsQ0FBQyxDQUFDLENBQUE7QUFDRjNCLFlBQVksQ0FBQ3dCLGtCQUFrQixHQUFHQSxrQkFBa0IsQ0FBQTs7QUFFcEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBU0QsY0FBY0EsQ0FBQ3BCLE1BQU0sRUFBRUYsSUFBSSxFQUFFQyxHQUFHLEVBQUU7RUFDdkMsSUFBSUMsTUFBTSxDQUFDQyxNQUFNLEVBQUU7QUFDZkMsSUFBQUEsS0FBSyxDQUFDQyxLQUFLLENBQUMsc0ZBQXNGLENBQUMsQ0FBQTtBQUNuRyxJQUFBLE9BQUE7QUFDSixHQUFBO0FBRUEsRUFBQSxJQUFJLE9BQU9ILE1BQU0sS0FBSyxVQUFVLEVBQzVCLE1BQU0sSUFBSUssS0FBSyxDQUFFLENBQUEsZUFBQSxFQUFpQkwsTUFBTyxDQUFBLDhDQUFBLENBQStDLENBQUMsQ0FBQTtFQUU3RixJQUFJLEVBQUVBLE1BQU0sQ0FBQ1MsU0FBUyxZQUFZRyxVQUFVLENBQUMsRUFDekMsTUFBTSxJQUFJUCxLQUFLLENBQUUsQ0FBQSxlQUFBLEVBQWlCTyxVQUFVLENBQUNlLGVBQWUsQ0FBQzNCLE1BQU0sQ0FBRSxrQ0FBaUMsQ0FBQyxDQUFBO0FBRTNHRixFQUFBQSxJQUFJLEdBQUdBLElBQUksSUFBSUUsTUFBTSxDQUFDNEIsTUFBTSxJQUFJaEIsVUFBVSxDQUFDZSxlQUFlLENBQUMzQixNQUFNLENBQUMsQ0FBQTtBQUVsRSxFQUFBLElBQUlOLG1CQUFtQixDQUFDVSxHQUFHLENBQUNOLElBQUksQ0FBQyxFQUM3QixNQUFNLElBQUlPLEtBQUssQ0FBRSxDQUFnQlAsY0FBQUEsRUFBQUEsSUFBSywwQ0FBeUMsQ0FBQyxDQUFBO0VBRXBGRSxNQUFNLENBQUM0QixNQUFNLEdBQUc5QixJQUFJLENBQUE7O0FBRXBCO0FBQ0EsRUFBQSxNQUFNK0IsUUFBUSxHQUFHOUIsR0FBRyxHQUFHQSxHQUFHLENBQUMrQixPQUFPLEdBQUdDLE9BQU8sQ0FBQ0MsY0FBYyxFQUFFLENBQUNGLE9BQU8sQ0FBQTtBQUNyRUQsRUFBQUEsUUFBUSxDQUFDSSxHQUFHLENBQUNqQyxNQUFNLENBQUMsQ0FBQTtFQUVwQmtDLFdBQVcsQ0FBQ0MsSUFBSSxDQUFDbkMsTUFBTSxFQUFFQSxNQUFNLENBQUNDLE1BQU0sQ0FBQyxDQUFBO0FBQzNDOzs7OyJ9
