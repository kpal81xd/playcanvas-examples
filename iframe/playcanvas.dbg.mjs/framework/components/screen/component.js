import { Debug } from '../../../core/debug.js';
import { Mat4 } from '../../../core/math/mat4.js';
import { Vec2 } from '../../../core/math/vec2.js';
import { Entity } from '../../entity.js';
import { SCALEMODE_NONE, SCALEMODE_BLEND } from './constants.js';
import { Component } from '../component.js';

const _transform = new Mat4();

/**
 * A ScreenComponent enables the Entity to render child {@link ElementComponent}s using anchors and
 * positions in the ScreenComponent's space.
 *
 * @augments Component
 * @category User Interface
 */
class ScreenComponent extends Component {
  /**
   * Create a new ScreenComponent.
   *
   * @param {import('./system.js').ScreenComponentSystem} system - The ComponentSystem that
   * created this Component.
   * @param {Entity} entity - The Entity that this Component is attached to.
   */
  constructor(system, entity) {
    super(system, entity);
    this._resolution = new Vec2(640, 320);
    this._referenceResolution = new Vec2(640, 320);
    this._scaleMode = SCALEMODE_NONE;
    this.scale = 1;
    this._scaleBlend = 0.5;
    this._priority = 0;
    this._screenSpace = false;

    /**
     * If true then elements inside this screen will be not be rendered when outside of the
     * screen (only valid when screenSpace is true).
     *
     * @type {boolean}
     */
    this.cull = this._screenSpace;
    this._screenMatrix = new Mat4();
    this._elements = new Set();
    system.app.graphicsDevice.on('resizecanvas', this._onResize, this);
  }

  /**
   * Set the drawOrder of each child {@link ElementComponent} so that ElementComponents which are
   * last in the hierarchy are rendered on top. Draw Order sync is queued and will be updated by
   * the next update loop.
   */
  syncDrawOrder() {
    this.system.queueDrawOrderSync(this.entity.getGuid(), this._processDrawOrderSync, this);
  }
  _recurseDrawOrderSync(e, i) {
    if (!(e instanceof Entity)) {
      return i;
    }
    if (e.element) {
      const prevDrawOrder = e.element.drawOrder;
      e.element.drawOrder = i++;
      if (e.element._batchGroupId >= 0 && prevDrawOrder !== e.element.drawOrder) {
        var _this$system$app$batc;
        (_this$system$app$batc = this.system.app.batcher) == null || _this$system$app$batc.markGroupDirty(e.element._batchGroupId);
      }
    }

    // child particle system inside 2D screen sub-hierarchy gets sorted along other 2D elements
    if (e.particlesystem) {
      e.particlesystem.drawOrder = i++;
    }
    const children = e.children;
    for (let j = 0; j < children.length; j++) {
      i = this._recurseDrawOrderSync(children[j], i);
    }
    return i;
  }
  _processDrawOrderSync() {
    const i = 1;
    this._recurseDrawOrderSync(this.entity, i);

    // fire internal event after all screen hierarchy is synced
    this.fire('syncdraworder');
  }
  _calcProjectionMatrix() {
    const w = this._resolution.x / this.scale;
    const h = this._resolution.y / this.scale;
    const left = 0;
    const right = w;
    const bottom = -h;
    const top = 0;
    const near = 1;
    const far = -1;
    this._screenMatrix.setOrtho(left, right, bottom, top, near, far);
    if (!this._screenSpace) {
      _transform.setScale(0.5 * w, 0.5 * h, 1);
      this._screenMatrix.mul2(_transform, this._screenMatrix);
    }
  }
  _updateScale() {
    this.scale = this._calcScale(this._resolution, this.referenceResolution);
  }
  _calcScale(resolution, referenceResolution) {
    // Using log of scale values
    // This produces a nicer outcome where if you have a xscale = 2 and yscale = 0.5
    // the combined scale is 1 for an even blend
    const lx = Math.log2((resolution.x || 1) / referenceResolution.x);
    const ly = Math.log2((resolution.y || 1) / referenceResolution.y);
    return Math.pow(2, lx * (1 - this._scaleBlend) + ly * this._scaleBlend);
  }
  _onResize(width, height) {
    if (this._screenSpace) {
      this._resolution.set(width, height);
      this.resolution = this._resolution; // force update
    }
  }

  _bindElement(element) {
    this._elements.add(element);
  }
  _unbindElement(element) {
    this._elements.delete(element);
  }
  onRemove() {
    this.system.app.graphicsDevice.off('resizecanvas', this._onResize, this);
    this.fire('remove');
    this._elements.forEach(element => element._onScreenRemove());
    this._elements.clear();

    // remove all events
    this.off();
  }

  /**
   * The width and height of the ScreenComponent. When screenSpace is true the resolution will
   * always be equal to {@link GraphicsDevice#width} x {@link GraphicsDevice#height}.
   *
   * @type {Vec2}
   */
  set resolution(value) {
    if (!this._screenSpace) {
      this._resolution.set(value.x, value.y);
    } else {
      // ignore input when using screen space.
      this._resolution.set(this.system.app.graphicsDevice.width, this.system.app.graphicsDevice.height);
    }
    this._updateScale();
    this._calcProjectionMatrix();
    if (!this.entity._dirtyLocal) this.entity._dirtifyLocal();
    this.fire('set:resolution', this._resolution);
    this._elements.forEach(element => element._onScreenResize(this._resolution));
  }
  get resolution() {
    return this._resolution;
  }

  /**
   * The resolution that the ScreenComponent is designed for. This is only taken into account
   * when screenSpace is true and scaleMode is {@link SCALEMODE_BLEND}. If the actual resolution
   * is different then the ScreenComponent will be scaled according to the scaleBlend value.
   *
   * @type {Vec2}
   */
  set referenceResolution(value) {
    this._referenceResolution.set(value.x, value.y);
    this._updateScale();
    this._calcProjectionMatrix();
    if (!this.entity._dirtyLocal) this.entity._dirtifyLocal();
    this.fire('set:referenceresolution', this._resolution);
    this._elements.forEach(element => element._onScreenResize(this._resolution));
  }
  get referenceResolution() {
    if (this._scaleMode === SCALEMODE_NONE) {
      return this._resolution;
    }
    return this._referenceResolution;
  }

  /**
   * If true then the ScreenComponent will render its child {@link ElementComponent}s in screen
   * space instead of world space. Enable this to create 2D user interfaces.
   *
   * @type {boolean}
   */
  set screenSpace(value) {
    this._screenSpace = value;
    if (this._screenSpace) {
      this._resolution.set(this.system.app.graphicsDevice.width, this.system.app.graphicsDevice.height);
    }
    this.resolution = this._resolution; // force update either way

    if (!this.entity._dirtyLocal) this.entity._dirtifyLocal();
    this.fire('set:screenspace', this._screenSpace);
    this._elements.forEach(element => element._onScreenSpaceChange());
  }
  get screenSpace() {
    return this._screenSpace;
  }

  /**
   * Can either be {@link SCALEMODE_NONE} or {@link SCALEMODE_BLEND}. See the description of
   * referenceResolution for more information.
   *
   * @type {string}
   */
  set scaleMode(value) {
    if (value !== SCALEMODE_NONE && value !== SCALEMODE_BLEND) {
      value = SCALEMODE_NONE;
    }

    // world space screens do not support scale modes
    if (!this._screenSpace && value !== SCALEMODE_NONE) {
      value = SCALEMODE_NONE;
    }
    this._scaleMode = value;
    this.resolution = this._resolution; // force update
    this.fire('set:scalemode', this._scaleMode);
  }
  get scaleMode() {
    return this._scaleMode;
  }

  /**
   * A value between 0 and 1 that is used when scaleMode is equal to {@link SCALEMODE_BLEND}.
   * Scales the ScreenComponent with width as a reference (when value is 0), the height as a
   * reference (when value is 1) or anything in between.
   *
   * @type {number}
   */
  set scaleBlend(value) {
    this._scaleBlend = value;
    this._updateScale();
    this._calcProjectionMatrix();
    if (!this.entity._dirtyLocal) this.entity._dirtifyLocal();
    this.fire('set:scaleblend', this._scaleBlend);
    this._elements.forEach(element => element._onScreenResize(this._resolution));
  }
  get scaleBlend() {
    return this._scaleBlend;
  }

  /**
   * Priority determines the order in which Screen components in the same layer are rendered.
   * Number must be an integer between 0 and 255. Priority is set into the top 8 bits of the
   * drawOrder property in an element.
   *
   * @type {number}
   */
  set priority(value) {
    if (value > 0xFF) {
      Debug.warn(`Clamping screen priority from ${value} to 255`);
      value = 0xFF;
    }
    if (this._priority === value) {
      return;
    }
    this._priority = value;
    this.syncDrawOrder();
  }
  get priority() {
    return this._priority;
  }
}

export { ScreenComponent };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL2NvbXBvbmVudHMvc2NyZWVuL2NvbXBvbmVudC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEZWJ1ZyB9IGZyb20gJy4uLy4uLy4uL2NvcmUvZGVidWcuanMnO1xuXG5pbXBvcnQgeyBNYXQ0IH0gZnJvbSAnLi4vLi4vLi4vY29yZS9tYXRoL21hdDQuanMnO1xuaW1wb3J0IHsgVmVjMiB9IGZyb20gJy4uLy4uLy4uL2NvcmUvbWF0aC92ZWMyLmpzJztcblxuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnLi4vLi4vZW50aXR5LmpzJztcblxuaW1wb3J0IHsgU0NBTEVNT0RFX0JMRU5ELCBTQ0FMRU1PREVfTk9ORSB9IGZyb20gJy4vY29uc3RhbnRzLmpzJztcbmltcG9ydCB7IENvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudC5qcyc7XG5cbmNvbnN0IF90cmFuc2Zvcm0gPSBuZXcgTWF0NCgpO1xuXG4vKipcbiAqIEEgU2NyZWVuQ29tcG9uZW50IGVuYWJsZXMgdGhlIEVudGl0eSB0byByZW5kZXIgY2hpbGQge0BsaW5rIEVsZW1lbnRDb21wb25lbnR9cyB1c2luZyBhbmNob3JzIGFuZFxuICogcG9zaXRpb25zIGluIHRoZSBTY3JlZW5Db21wb25lbnQncyBzcGFjZS5cbiAqXG4gKiBAYXVnbWVudHMgQ29tcG9uZW50XG4gKiBAY2F0ZWdvcnkgVXNlciBJbnRlcmZhY2VcbiAqL1xuY2xhc3MgU2NyZWVuQ29tcG9uZW50IGV4dGVuZHMgQ29tcG9uZW50IHtcbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgU2NyZWVuQ29tcG9uZW50LlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vc3lzdGVtLmpzJykuU2NyZWVuQ29tcG9uZW50U3lzdGVtfSBzeXN0ZW0gLSBUaGUgQ29tcG9uZW50U3lzdGVtIHRoYXRcbiAgICAgKiBjcmVhdGVkIHRoaXMgQ29tcG9uZW50LlxuICAgICAqIEBwYXJhbSB7RW50aXR5fSBlbnRpdHkgLSBUaGUgRW50aXR5IHRoYXQgdGhpcyBDb21wb25lbnQgaXMgYXR0YWNoZWQgdG8uXG4gICAgICovXG4gICAgY29uc3RydWN0b3Ioc3lzdGVtLCBlbnRpdHkpIHtcbiAgICAgICAgc3VwZXIoc3lzdGVtLCBlbnRpdHkpO1xuXG4gICAgICAgIHRoaXMuX3Jlc29sdXRpb24gPSBuZXcgVmVjMig2NDAsIDMyMCk7XG4gICAgICAgIHRoaXMuX3JlZmVyZW5jZVJlc29sdXRpb24gPSBuZXcgVmVjMig2NDAsIDMyMCk7XG4gICAgICAgIHRoaXMuX3NjYWxlTW9kZSA9IFNDQUxFTU9ERV9OT05FO1xuICAgICAgICB0aGlzLnNjYWxlID0gMTtcbiAgICAgICAgdGhpcy5fc2NhbGVCbGVuZCA9IDAuNTtcblxuICAgICAgICB0aGlzLl9wcmlvcml0eSA9IDA7XG5cbiAgICAgICAgdGhpcy5fc2NyZWVuU3BhY2UgPSBmYWxzZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogSWYgdHJ1ZSB0aGVuIGVsZW1lbnRzIGluc2lkZSB0aGlzIHNjcmVlbiB3aWxsIGJlIG5vdCBiZSByZW5kZXJlZCB3aGVuIG91dHNpZGUgb2YgdGhlXG4gICAgICAgICAqIHNjcmVlbiAob25seSB2YWxpZCB3aGVuIHNjcmVlblNwYWNlIGlzIHRydWUpLlxuICAgICAgICAgKlxuICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuY3VsbCA9IHRoaXMuX3NjcmVlblNwYWNlO1xuICAgICAgICB0aGlzLl9zY3JlZW5NYXRyaXggPSBuZXcgTWF0NCgpO1xuXG4gICAgICAgIHRoaXMuX2VsZW1lbnRzID0gbmV3IFNldCgpO1xuXG4gICAgICAgIHN5c3RlbS5hcHAuZ3JhcGhpY3NEZXZpY2Uub24oJ3Jlc2l6ZWNhbnZhcycsIHRoaXMuX29uUmVzaXplLCB0aGlzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXQgdGhlIGRyYXdPcmRlciBvZiBlYWNoIGNoaWxkIHtAbGluayBFbGVtZW50Q29tcG9uZW50fSBzbyB0aGF0IEVsZW1lbnRDb21wb25lbnRzIHdoaWNoIGFyZVxuICAgICAqIGxhc3QgaW4gdGhlIGhpZXJhcmNoeSBhcmUgcmVuZGVyZWQgb24gdG9wLiBEcmF3IE9yZGVyIHN5bmMgaXMgcXVldWVkIGFuZCB3aWxsIGJlIHVwZGF0ZWQgYnlcbiAgICAgKiB0aGUgbmV4dCB1cGRhdGUgbG9vcC5cbiAgICAgKi9cbiAgICBzeW5jRHJhd09yZGVyKCkge1xuICAgICAgICB0aGlzLnN5c3RlbS5xdWV1ZURyYXdPcmRlclN5bmModGhpcy5lbnRpdHkuZ2V0R3VpZCgpLCB0aGlzLl9wcm9jZXNzRHJhd09yZGVyU3luYywgdGhpcyk7XG4gICAgfVxuXG4gICAgX3JlY3Vyc2VEcmF3T3JkZXJTeW5jKGUsIGkpIHtcbiAgICAgICAgaWYgKCEoZSBpbnN0YW5jZW9mIEVudGl0eSkpIHtcbiAgICAgICAgICAgIHJldHVybiBpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGUuZWxlbWVudCkge1xuICAgICAgICAgICAgY29uc3QgcHJldkRyYXdPcmRlciA9IGUuZWxlbWVudC5kcmF3T3JkZXI7XG4gICAgICAgICAgICBlLmVsZW1lbnQuZHJhd09yZGVyID0gaSsrO1xuXG4gICAgICAgICAgICBpZiAoZS5lbGVtZW50Ll9iYXRjaEdyb3VwSWQgPj0gMCAmJiBwcmV2RHJhd09yZGVyICE9PSBlLmVsZW1lbnQuZHJhd09yZGVyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zeXN0ZW0uYXBwLmJhdGNoZXI/Lm1hcmtHcm91cERpcnR5KGUuZWxlbWVudC5fYmF0Y2hHcm91cElkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGNoaWxkIHBhcnRpY2xlIHN5c3RlbSBpbnNpZGUgMkQgc2NyZWVuIHN1Yi1oaWVyYXJjaHkgZ2V0cyBzb3J0ZWQgYWxvbmcgb3RoZXIgMkQgZWxlbWVudHNcbiAgICAgICAgaWYgKGUucGFydGljbGVzeXN0ZW0pIHtcbiAgICAgICAgICAgIGUucGFydGljbGVzeXN0ZW0uZHJhd09yZGVyID0gaSsrO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBlLmNoaWxkcmVuO1xuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGNoaWxkcmVuLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICBpID0gdGhpcy5fcmVjdXJzZURyYXdPcmRlclN5bmMoY2hpbGRyZW5bal0sIGkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGk7XG4gICAgfVxuXG4gICAgX3Byb2Nlc3NEcmF3T3JkZXJTeW5jKCkge1xuICAgICAgICBjb25zdCBpID0gMTtcblxuICAgICAgICB0aGlzLl9yZWN1cnNlRHJhd09yZGVyU3luYyh0aGlzLmVudGl0eSwgaSk7XG5cbiAgICAgICAgLy8gZmlyZSBpbnRlcm5hbCBldmVudCBhZnRlciBhbGwgc2NyZWVuIGhpZXJhcmNoeSBpcyBzeW5jZWRcbiAgICAgICAgdGhpcy5maXJlKCdzeW5jZHJhd29yZGVyJyk7XG4gICAgfVxuXG4gICAgX2NhbGNQcm9qZWN0aW9uTWF0cml4KCkge1xuICAgICAgICBjb25zdCB3ID0gdGhpcy5fcmVzb2x1dGlvbi54IC8gdGhpcy5zY2FsZTtcbiAgICAgICAgY29uc3QgaCA9IHRoaXMuX3Jlc29sdXRpb24ueSAvIHRoaXMuc2NhbGU7XG5cbiAgICAgICAgY29uc3QgbGVmdCA9IDA7XG4gICAgICAgIGNvbnN0IHJpZ2h0ID0gdztcbiAgICAgICAgY29uc3QgYm90dG9tID0gLWg7XG4gICAgICAgIGNvbnN0IHRvcCA9IDA7XG4gICAgICAgIGNvbnN0IG5lYXIgPSAxO1xuICAgICAgICBjb25zdCBmYXIgPSAtMTtcblxuICAgICAgICB0aGlzLl9zY3JlZW5NYXRyaXguc2V0T3J0aG8obGVmdCwgcmlnaHQsIGJvdHRvbSwgdG9wLCBuZWFyLCBmYXIpO1xuXG4gICAgICAgIGlmICghdGhpcy5fc2NyZWVuU3BhY2UpIHtcbiAgICAgICAgICAgIF90cmFuc2Zvcm0uc2V0U2NhbGUoMC41ICogdywgMC41ICogaCwgMSk7XG4gICAgICAgICAgICB0aGlzLl9zY3JlZW5NYXRyaXgubXVsMihfdHJhbnNmb3JtLCB0aGlzLl9zY3JlZW5NYXRyaXgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX3VwZGF0ZVNjYWxlKCkge1xuICAgICAgICB0aGlzLnNjYWxlID0gdGhpcy5fY2FsY1NjYWxlKHRoaXMuX3Jlc29sdXRpb24sIHRoaXMucmVmZXJlbmNlUmVzb2x1dGlvbik7XG4gICAgfVxuXG4gICAgX2NhbGNTY2FsZShyZXNvbHV0aW9uLCByZWZlcmVuY2VSZXNvbHV0aW9uKSB7XG4gICAgICAgIC8vIFVzaW5nIGxvZyBvZiBzY2FsZSB2YWx1ZXNcbiAgICAgICAgLy8gVGhpcyBwcm9kdWNlcyBhIG5pY2VyIG91dGNvbWUgd2hlcmUgaWYgeW91IGhhdmUgYSB4c2NhbGUgPSAyIGFuZCB5c2NhbGUgPSAwLjVcbiAgICAgICAgLy8gdGhlIGNvbWJpbmVkIHNjYWxlIGlzIDEgZm9yIGFuIGV2ZW4gYmxlbmRcbiAgICAgICAgY29uc3QgbHggPSBNYXRoLmxvZzIoKHJlc29sdXRpb24ueCB8fCAxKSAvIHJlZmVyZW5jZVJlc29sdXRpb24ueCk7XG4gICAgICAgIGNvbnN0IGx5ID0gTWF0aC5sb2cyKChyZXNvbHV0aW9uLnkgfHwgMSkgLyByZWZlcmVuY2VSZXNvbHV0aW9uLnkpO1xuICAgICAgICByZXR1cm4gTWF0aC5wb3coMiwgKGx4ICogKDEgLSB0aGlzLl9zY2FsZUJsZW5kKSArIGx5ICogdGhpcy5fc2NhbGVCbGVuZCkpO1xuICAgIH1cblxuICAgIF9vblJlc2l6ZSh3aWR0aCwgaGVpZ2h0KSB7XG4gICAgICAgIGlmICh0aGlzLl9zY3JlZW5TcGFjZSkge1xuICAgICAgICAgICAgdGhpcy5fcmVzb2x1dGlvbi5zZXQod2lkdGgsIGhlaWdodCk7XG4gICAgICAgICAgICB0aGlzLnJlc29sdXRpb24gPSB0aGlzLl9yZXNvbHV0aW9uOyAvLyBmb3JjZSB1cGRhdGVcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9iaW5kRWxlbWVudChlbGVtZW50KSB7XG4gICAgICAgIHRoaXMuX2VsZW1lbnRzLmFkZChlbGVtZW50KTtcbiAgICB9XG5cbiAgICBfdW5iaW5kRWxlbWVudChlbGVtZW50KSB7XG4gICAgICAgIHRoaXMuX2VsZW1lbnRzLmRlbGV0ZShlbGVtZW50KTtcbiAgICB9XG5cbiAgICBvblJlbW92ZSgpIHtcbiAgICAgICAgdGhpcy5zeXN0ZW0uYXBwLmdyYXBoaWNzRGV2aWNlLm9mZigncmVzaXplY2FudmFzJywgdGhpcy5fb25SZXNpemUsIHRoaXMpO1xuICAgICAgICB0aGlzLmZpcmUoJ3JlbW92ZScpO1xuXG4gICAgICAgIHRoaXMuX2VsZW1lbnRzLmZvckVhY2goZWxlbWVudCA9PiBlbGVtZW50Ll9vblNjcmVlblJlbW92ZSgpKTtcbiAgICAgICAgdGhpcy5fZWxlbWVudHMuY2xlYXIoKTtcblxuICAgICAgICAvLyByZW1vdmUgYWxsIGV2ZW50c1xuICAgICAgICB0aGlzLm9mZigpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhlIHdpZHRoIGFuZCBoZWlnaHQgb2YgdGhlIFNjcmVlbkNvbXBvbmVudC4gV2hlbiBzY3JlZW5TcGFjZSBpcyB0cnVlIHRoZSByZXNvbHV0aW9uIHdpbGxcbiAgICAgKiBhbHdheXMgYmUgZXF1YWwgdG8ge0BsaW5rIEdyYXBoaWNzRGV2aWNlI3dpZHRofSB4IHtAbGluayBHcmFwaGljc0RldmljZSNoZWlnaHR9LlxuICAgICAqXG4gICAgICogQHR5cGUge1ZlYzJ9XG4gICAgICovXG4gICAgc2V0IHJlc29sdXRpb24odmFsdWUpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9zY3JlZW5TcGFjZSkge1xuICAgICAgICAgICAgdGhpcy5fcmVzb2x1dGlvbi5zZXQodmFsdWUueCwgdmFsdWUueSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBpZ25vcmUgaW5wdXQgd2hlbiB1c2luZyBzY3JlZW4gc3BhY2UuXG4gICAgICAgICAgICB0aGlzLl9yZXNvbHV0aW9uLnNldCh0aGlzLnN5c3RlbS5hcHAuZ3JhcGhpY3NEZXZpY2Uud2lkdGgsIHRoaXMuc3lzdGVtLmFwcC5ncmFwaGljc0RldmljZS5oZWlnaHQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fdXBkYXRlU2NhbGUoKTtcblxuICAgICAgICB0aGlzLl9jYWxjUHJvamVjdGlvbk1hdHJpeCgpO1xuXG4gICAgICAgIGlmICghdGhpcy5lbnRpdHkuX2RpcnR5TG9jYWwpXG4gICAgICAgICAgICB0aGlzLmVudGl0eS5fZGlydGlmeUxvY2FsKCk7XG5cbiAgICAgICAgdGhpcy5maXJlKCdzZXQ6cmVzb2x1dGlvbicsIHRoaXMuX3Jlc29sdXRpb24pO1xuICAgICAgICB0aGlzLl9lbGVtZW50cy5mb3JFYWNoKGVsZW1lbnQgPT4gZWxlbWVudC5fb25TY3JlZW5SZXNpemUodGhpcy5fcmVzb2x1dGlvbikpO1xuICAgIH1cblxuICAgIGdldCByZXNvbHV0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcmVzb2x1dGlvbjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgcmVzb2x1dGlvbiB0aGF0IHRoZSBTY3JlZW5Db21wb25lbnQgaXMgZGVzaWduZWQgZm9yLiBUaGlzIGlzIG9ubHkgdGFrZW4gaW50byBhY2NvdW50XG4gICAgICogd2hlbiBzY3JlZW5TcGFjZSBpcyB0cnVlIGFuZCBzY2FsZU1vZGUgaXMge0BsaW5rIFNDQUxFTU9ERV9CTEVORH0uIElmIHRoZSBhY3R1YWwgcmVzb2x1dGlvblxuICAgICAqIGlzIGRpZmZlcmVudCB0aGVuIHRoZSBTY3JlZW5Db21wb25lbnQgd2lsbCBiZSBzY2FsZWQgYWNjb3JkaW5nIHRvIHRoZSBzY2FsZUJsZW5kIHZhbHVlLlxuICAgICAqXG4gICAgICogQHR5cGUge1ZlYzJ9XG4gICAgICovXG4gICAgc2V0IHJlZmVyZW5jZVJlc29sdXRpb24odmFsdWUpIHtcbiAgICAgICAgdGhpcy5fcmVmZXJlbmNlUmVzb2x1dGlvbi5zZXQodmFsdWUueCwgdmFsdWUueSk7XG4gICAgICAgIHRoaXMuX3VwZGF0ZVNjYWxlKCk7XG4gICAgICAgIHRoaXMuX2NhbGNQcm9qZWN0aW9uTWF0cml4KCk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmVudGl0eS5fZGlydHlMb2NhbClcbiAgICAgICAgICAgIHRoaXMuZW50aXR5Ll9kaXJ0aWZ5TG9jYWwoKTtcblxuICAgICAgICB0aGlzLmZpcmUoJ3NldDpyZWZlcmVuY2VyZXNvbHV0aW9uJywgdGhpcy5fcmVzb2x1dGlvbik7XG4gICAgICAgIHRoaXMuX2VsZW1lbnRzLmZvckVhY2goZWxlbWVudCA9PiBlbGVtZW50Ll9vblNjcmVlblJlc2l6ZSh0aGlzLl9yZXNvbHV0aW9uKSk7XG4gICAgfVxuXG4gICAgZ2V0IHJlZmVyZW5jZVJlc29sdXRpb24oKSB7XG4gICAgICAgIGlmICh0aGlzLl9zY2FsZU1vZGUgPT09IFNDQUxFTU9ERV9OT05FKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVzb2x1dGlvbjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5fcmVmZXJlbmNlUmVzb2x1dGlvbjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJZiB0cnVlIHRoZW4gdGhlIFNjcmVlbkNvbXBvbmVudCB3aWxsIHJlbmRlciBpdHMgY2hpbGQge0BsaW5rIEVsZW1lbnRDb21wb25lbnR9cyBpbiBzY3JlZW5cbiAgICAgKiBzcGFjZSBpbnN0ZWFkIG9mIHdvcmxkIHNwYWNlLiBFbmFibGUgdGhpcyB0byBjcmVhdGUgMkQgdXNlciBpbnRlcmZhY2VzLlxuICAgICAqXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICovXG4gICAgc2V0IHNjcmVlblNwYWNlKHZhbHVlKSB7XG4gICAgICAgIHRoaXMuX3NjcmVlblNwYWNlID0gdmFsdWU7XG4gICAgICAgIGlmICh0aGlzLl9zY3JlZW5TcGFjZSkge1xuICAgICAgICAgICAgdGhpcy5fcmVzb2x1dGlvbi5zZXQodGhpcy5zeXN0ZW0uYXBwLmdyYXBoaWNzRGV2aWNlLndpZHRoLCB0aGlzLnN5c3RlbS5hcHAuZ3JhcGhpY3NEZXZpY2UuaGVpZ2h0KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlc29sdXRpb24gPSB0aGlzLl9yZXNvbHV0aW9uOyAvLyBmb3JjZSB1cGRhdGUgZWl0aGVyIHdheVxuXG4gICAgICAgIGlmICghdGhpcy5lbnRpdHkuX2RpcnR5TG9jYWwpXG4gICAgICAgICAgICB0aGlzLmVudGl0eS5fZGlydGlmeUxvY2FsKCk7XG5cbiAgICAgICAgdGhpcy5maXJlKCdzZXQ6c2NyZWVuc3BhY2UnLCB0aGlzLl9zY3JlZW5TcGFjZSk7XG5cbiAgICAgICAgdGhpcy5fZWxlbWVudHMuZm9yRWFjaChlbGVtZW50ID0+IGVsZW1lbnQuX29uU2NyZWVuU3BhY2VDaGFuZ2UoKSk7XG4gICAgfVxuXG4gICAgZ2V0IHNjcmVlblNwYWNlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2NyZWVuU3BhY2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FuIGVpdGhlciBiZSB7QGxpbmsgU0NBTEVNT0RFX05PTkV9IG9yIHtAbGluayBTQ0FMRU1PREVfQkxFTkR9LiBTZWUgdGhlIGRlc2NyaXB0aW9uIG9mXG4gICAgICogcmVmZXJlbmNlUmVzb2x1dGlvbiBmb3IgbW9yZSBpbmZvcm1hdGlvbi5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICovXG4gICAgc2V0IHNjYWxlTW9kZSh2YWx1ZSkge1xuICAgICAgICBpZiAodmFsdWUgIT09IFNDQUxFTU9ERV9OT05FICYmIHZhbHVlICE9PSBTQ0FMRU1PREVfQkxFTkQpIHtcbiAgICAgICAgICAgIHZhbHVlID0gU0NBTEVNT0RFX05PTkU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB3b3JsZCBzcGFjZSBzY3JlZW5zIGRvIG5vdCBzdXBwb3J0IHNjYWxlIG1vZGVzXG4gICAgICAgIGlmICghdGhpcy5fc2NyZWVuU3BhY2UgJiYgdmFsdWUgIT09IFNDQUxFTU9ERV9OT05FKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IFNDQUxFTU9ERV9OT05FO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc2NhbGVNb2RlID0gdmFsdWU7XG4gICAgICAgIHRoaXMucmVzb2x1dGlvbiA9IHRoaXMuX3Jlc29sdXRpb247IC8vIGZvcmNlIHVwZGF0ZVxuICAgICAgICB0aGlzLmZpcmUoJ3NldDpzY2FsZW1vZGUnLCB0aGlzLl9zY2FsZU1vZGUpO1xuICAgIH1cblxuICAgIGdldCBzY2FsZU1vZGUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zY2FsZU1vZGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDEgdGhhdCBpcyB1c2VkIHdoZW4gc2NhbGVNb2RlIGlzIGVxdWFsIHRvIHtAbGluayBTQ0FMRU1PREVfQkxFTkR9LlxuICAgICAqIFNjYWxlcyB0aGUgU2NyZWVuQ29tcG9uZW50IHdpdGggd2lkdGggYXMgYSByZWZlcmVuY2UgKHdoZW4gdmFsdWUgaXMgMCksIHRoZSBoZWlnaHQgYXMgYVxuICAgICAqIHJlZmVyZW5jZSAod2hlbiB2YWx1ZSBpcyAxKSBvciBhbnl0aGluZyBpbiBiZXR3ZWVuLlxuICAgICAqXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBzZXQgc2NhbGVCbGVuZCh2YWx1ZSkge1xuICAgICAgICB0aGlzLl9zY2FsZUJsZW5kID0gdmFsdWU7XG4gICAgICAgIHRoaXMuX3VwZGF0ZVNjYWxlKCk7XG4gICAgICAgIHRoaXMuX2NhbGNQcm9qZWN0aW9uTWF0cml4KCk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmVudGl0eS5fZGlydHlMb2NhbClcbiAgICAgICAgICAgIHRoaXMuZW50aXR5Ll9kaXJ0aWZ5TG9jYWwoKTtcblxuICAgICAgICB0aGlzLmZpcmUoJ3NldDpzY2FsZWJsZW5kJywgdGhpcy5fc2NhbGVCbGVuZCk7XG5cbiAgICAgICAgdGhpcy5fZWxlbWVudHMuZm9yRWFjaChlbGVtZW50ID0+IGVsZW1lbnQuX29uU2NyZWVuUmVzaXplKHRoaXMuX3Jlc29sdXRpb24pKTtcbiAgICB9XG5cbiAgICBnZXQgc2NhbGVCbGVuZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NjYWxlQmxlbmQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJpb3JpdHkgZGV0ZXJtaW5lcyB0aGUgb3JkZXIgaW4gd2hpY2ggU2NyZWVuIGNvbXBvbmVudHMgaW4gdGhlIHNhbWUgbGF5ZXIgYXJlIHJlbmRlcmVkLlxuICAgICAqIE51bWJlciBtdXN0IGJlIGFuIGludGVnZXIgYmV0d2VlbiAwIGFuZCAyNTUuIFByaW9yaXR5IGlzIHNldCBpbnRvIHRoZSB0b3AgOCBiaXRzIG9mIHRoZVxuICAgICAqIGRyYXdPcmRlciBwcm9wZXJ0eSBpbiBhbiBlbGVtZW50LlxuICAgICAqXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBzZXQgcHJpb3JpdHkodmFsdWUpIHtcbiAgICAgICAgaWYgKHZhbHVlID4gMHhGRikge1xuICAgICAgICAgICAgRGVidWcud2FybihgQ2xhbXBpbmcgc2NyZWVuIHByaW9yaXR5IGZyb20gJHt2YWx1ZX0gdG8gMjU1YCk7XG4gICAgICAgICAgICB2YWx1ZSA9IDB4RkY7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuX3ByaW9yaXR5ID09PSB2YWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fcHJpb3JpdHkgPSB2YWx1ZTtcbiAgICAgICAgdGhpcy5zeW5jRHJhd09yZGVyKCk7XG4gICAgfVxuXG4gICAgZ2V0IHByaW9yaXR5KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcHJpb3JpdHk7XG4gICAgfVxufVxuXG5leHBvcnQgeyBTY3JlZW5Db21wb25lbnQgfTtcbiJdLCJuYW1lcyI6WyJfdHJhbnNmb3JtIiwiTWF0NCIsIlNjcmVlbkNvbXBvbmVudCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwic3lzdGVtIiwiZW50aXR5IiwiX3Jlc29sdXRpb24iLCJWZWMyIiwiX3JlZmVyZW5jZVJlc29sdXRpb24iLCJfc2NhbGVNb2RlIiwiU0NBTEVNT0RFX05PTkUiLCJzY2FsZSIsIl9zY2FsZUJsZW5kIiwiX3ByaW9yaXR5IiwiX3NjcmVlblNwYWNlIiwiY3VsbCIsIl9zY3JlZW5NYXRyaXgiLCJfZWxlbWVudHMiLCJTZXQiLCJhcHAiLCJncmFwaGljc0RldmljZSIsIm9uIiwiX29uUmVzaXplIiwic3luY0RyYXdPcmRlciIsInF1ZXVlRHJhd09yZGVyU3luYyIsImdldEd1aWQiLCJfcHJvY2Vzc0RyYXdPcmRlclN5bmMiLCJfcmVjdXJzZURyYXdPcmRlclN5bmMiLCJlIiwiaSIsIkVudGl0eSIsImVsZW1lbnQiLCJwcmV2RHJhd09yZGVyIiwiZHJhd09yZGVyIiwiX2JhdGNoR3JvdXBJZCIsIl90aGlzJHN5c3RlbSRhcHAkYmF0YyIsImJhdGNoZXIiLCJtYXJrR3JvdXBEaXJ0eSIsInBhcnRpY2xlc3lzdGVtIiwiY2hpbGRyZW4iLCJqIiwibGVuZ3RoIiwiZmlyZSIsIl9jYWxjUHJvamVjdGlvbk1hdHJpeCIsInciLCJ4IiwiaCIsInkiLCJsZWZ0IiwicmlnaHQiLCJib3R0b20iLCJ0b3AiLCJuZWFyIiwiZmFyIiwic2V0T3J0aG8iLCJzZXRTY2FsZSIsIm11bDIiLCJfdXBkYXRlU2NhbGUiLCJfY2FsY1NjYWxlIiwicmVmZXJlbmNlUmVzb2x1dGlvbiIsInJlc29sdXRpb24iLCJseCIsIk1hdGgiLCJsb2cyIiwibHkiLCJwb3ciLCJ3aWR0aCIsImhlaWdodCIsInNldCIsIl9iaW5kRWxlbWVudCIsImFkZCIsIl91bmJpbmRFbGVtZW50IiwiZGVsZXRlIiwib25SZW1vdmUiLCJvZmYiLCJmb3JFYWNoIiwiX29uU2NyZWVuUmVtb3ZlIiwiY2xlYXIiLCJ2YWx1ZSIsIl9kaXJ0eUxvY2FsIiwiX2RpcnRpZnlMb2NhbCIsIl9vblNjcmVlblJlc2l6ZSIsInNjcmVlblNwYWNlIiwiX29uU2NyZWVuU3BhY2VDaGFuZ2UiLCJzY2FsZU1vZGUiLCJTQ0FMRU1PREVfQkxFTkQiLCJzY2FsZUJsZW5kIiwicHJpb3JpdHkiLCJEZWJ1ZyIsIndhcm4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFVQSxNQUFNQSxVQUFVLEdBQUcsSUFBSUMsSUFBSSxFQUFFLENBQUE7O0FBRTdCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTUMsZUFBZSxTQUFTQyxTQUFTLENBQUM7QUFDcEM7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsV0FBV0EsQ0FBQ0MsTUFBTSxFQUFFQyxNQUFNLEVBQUU7QUFDeEIsSUFBQSxLQUFLLENBQUNELE1BQU0sRUFBRUMsTUFBTSxDQUFDLENBQUE7SUFFckIsSUFBSSxDQUFDQyxXQUFXLEdBQUcsSUFBSUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQTtJQUNyQyxJQUFJLENBQUNDLG9CQUFvQixHQUFHLElBQUlELElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFDOUMsSUFBSSxDQUFDRSxVQUFVLEdBQUdDLGNBQWMsQ0FBQTtJQUNoQyxJQUFJLENBQUNDLEtBQUssR0FBRyxDQUFDLENBQUE7SUFDZCxJQUFJLENBQUNDLFdBQVcsR0FBRyxHQUFHLENBQUE7SUFFdEIsSUFBSSxDQUFDQyxTQUFTLEdBQUcsQ0FBQyxDQUFBO0lBRWxCLElBQUksQ0FBQ0MsWUFBWSxHQUFHLEtBQUssQ0FBQTs7QUFFekI7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ1EsSUFBQSxJQUFJLENBQUNDLElBQUksR0FBRyxJQUFJLENBQUNELFlBQVksQ0FBQTtBQUM3QixJQUFBLElBQUksQ0FBQ0UsYUFBYSxHQUFHLElBQUloQixJQUFJLEVBQUUsQ0FBQTtBQUUvQixJQUFBLElBQUksQ0FBQ2lCLFNBQVMsR0FBRyxJQUFJQyxHQUFHLEVBQUUsQ0FBQTtBQUUxQmQsSUFBQUEsTUFBTSxDQUFDZSxHQUFHLENBQUNDLGNBQWMsQ0FBQ0MsRUFBRSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUNDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUN0RSxHQUFBOztBQUVBO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYUEsR0FBRztBQUNaLElBQUEsSUFBSSxDQUFDbkIsTUFBTSxDQUFDb0Isa0JBQWtCLENBQUMsSUFBSSxDQUFDbkIsTUFBTSxDQUFDb0IsT0FBTyxFQUFFLEVBQUUsSUFBSSxDQUFDQyxxQkFBcUIsRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUMzRixHQUFBO0FBRUFDLEVBQUFBLHFCQUFxQkEsQ0FBQ0MsQ0FBQyxFQUFFQyxDQUFDLEVBQUU7QUFDeEIsSUFBQSxJQUFJLEVBQUVELENBQUMsWUFBWUUsTUFBTSxDQUFDLEVBQUU7QUFDeEIsTUFBQSxPQUFPRCxDQUFDLENBQUE7QUFDWixLQUFBO0lBRUEsSUFBSUQsQ0FBQyxDQUFDRyxPQUFPLEVBQUU7QUFDWCxNQUFBLE1BQU1DLGFBQWEsR0FBR0osQ0FBQyxDQUFDRyxPQUFPLENBQUNFLFNBQVMsQ0FBQTtBQUN6Q0wsTUFBQUEsQ0FBQyxDQUFDRyxPQUFPLENBQUNFLFNBQVMsR0FBR0osQ0FBQyxFQUFFLENBQUE7QUFFekIsTUFBQSxJQUFJRCxDQUFDLENBQUNHLE9BQU8sQ0FBQ0csYUFBYSxJQUFJLENBQUMsSUFBSUYsYUFBYSxLQUFLSixDQUFDLENBQUNHLE9BQU8sQ0FBQ0UsU0FBUyxFQUFFO0FBQUEsUUFBQSxJQUFBRSxxQkFBQSxDQUFBO0FBQ3ZFLFFBQUEsQ0FBQUEscUJBQUEsR0FBSSxJQUFBLENBQUMvQixNQUFNLENBQUNlLEdBQUcsQ0FBQ2lCLE9BQU8sS0FBQSxJQUFBLElBQXZCRCxxQkFBQSxDQUF5QkUsY0FBYyxDQUFDVCxDQUFDLENBQUNHLE9BQU8sQ0FBQ0csYUFBYSxDQUFDLENBQUE7QUFDcEUsT0FBQTtBQUNKLEtBQUE7O0FBRUE7SUFDQSxJQUFJTixDQUFDLENBQUNVLGNBQWMsRUFBRTtBQUNsQlYsTUFBQUEsQ0FBQyxDQUFDVSxjQUFjLENBQUNMLFNBQVMsR0FBR0osQ0FBQyxFQUFFLENBQUE7QUFDcEMsS0FBQTtBQUVBLElBQUEsTUFBTVUsUUFBUSxHQUFHWCxDQUFDLENBQUNXLFFBQVEsQ0FBQTtBQUMzQixJQUFBLEtBQUssSUFBSUMsQ0FBQyxHQUFHLENBQUMsRUFBRUEsQ0FBQyxHQUFHRCxRQUFRLENBQUNFLE1BQU0sRUFBRUQsQ0FBQyxFQUFFLEVBQUU7TUFDdENYLENBQUMsR0FBRyxJQUFJLENBQUNGLHFCQUFxQixDQUFDWSxRQUFRLENBQUNDLENBQUMsQ0FBQyxFQUFFWCxDQUFDLENBQUMsQ0FBQTtBQUNsRCxLQUFBO0FBRUEsSUFBQSxPQUFPQSxDQUFDLENBQUE7QUFDWixHQUFBO0FBRUFILEVBQUFBLHFCQUFxQkEsR0FBRztJQUNwQixNQUFNRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBRVgsSUFBSSxDQUFDRixxQkFBcUIsQ0FBQyxJQUFJLENBQUN0QixNQUFNLEVBQUV3QixDQUFDLENBQUMsQ0FBQTs7QUFFMUM7QUFDQSxJQUFBLElBQUksQ0FBQ2EsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFBO0FBQzlCLEdBQUE7QUFFQUMsRUFBQUEscUJBQXFCQSxHQUFHO0lBQ3BCLE1BQU1DLENBQUMsR0FBRyxJQUFJLENBQUN0QyxXQUFXLENBQUN1QyxDQUFDLEdBQUcsSUFBSSxDQUFDbEMsS0FBSyxDQUFBO0lBQ3pDLE1BQU1tQyxDQUFDLEdBQUcsSUFBSSxDQUFDeEMsV0FBVyxDQUFDeUMsQ0FBQyxHQUFHLElBQUksQ0FBQ3BDLEtBQUssQ0FBQTtJQUV6QyxNQUFNcUMsSUFBSSxHQUFHLENBQUMsQ0FBQTtJQUNkLE1BQU1DLEtBQUssR0FBR0wsQ0FBQyxDQUFBO0lBQ2YsTUFBTU0sTUFBTSxHQUFHLENBQUNKLENBQUMsQ0FBQTtJQUNqQixNQUFNSyxHQUFHLEdBQUcsQ0FBQyxDQUFBO0lBQ2IsTUFBTUMsSUFBSSxHQUFHLENBQUMsQ0FBQTtJQUNkLE1BQU1DLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUVkLElBQUEsSUFBSSxDQUFDckMsYUFBYSxDQUFDc0MsUUFBUSxDQUFDTixJQUFJLEVBQUVDLEtBQUssRUFBRUMsTUFBTSxFQUFFQyxHQUFHLEVBQUVDLElBQUksRUFBRUMsR0FBRyxDQUFDLENBQUE7QUFFaEUsSUFBQSxJQUFJLENBQUMsSUFBSSxDQUFDdkMsWUFBWSxFQUFFO0FBQ3BCZixNQUFBQSxVQUFVLENBQUN3RCxRQUFRLENBQUMsR0FBRyxHQUFHWCxDQUFDLEVBQUUsR0FBRyxHQUFHRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7TUFDeEMsSUFBSSxDQUFDOUIsYUFBYSxDQUFDd0MsSUFBSSxDQUFDekQsVUFBVSxFQUFFLElBQUksQ0FBQ2lCLGFBQWEsQ0FBQyxDQUFBO0FBQzNELEtBQUE7QUFDSixHQUFBO0FBRUF5QyxFQUFBQSxZQUFZQSxHQUFHO0FBQ1gsSUFBQSxJQUFJLENBQUM5QyxLQUFLLEdBQUcsSUFBSSxDQUFDK0MsVUFBVSxDQUFDLElBQUksQ0FBQ3BELFdBQVcsRUFBRSxJQUFJLENBQUNxRCxtQkFBbUIsQ0FBQyxDQUFBO0FBQzVFLEdBQUE7QUFFQUQsRUFBQUEsVUFBVUEsQ0FBQ0UsVUFBVSxFQUFFRCxtQkFBbUIsRUFBRTtBQUN4QztBQUNBO0FBQ0E7QUFDQSxJQUFBLE1BQU1FLEVBQUUsR0FBR0MsSUFBSSxDQUFDQyxJQUFJLENBQUMsQ0FBQ0gsVUFBVSxDQUFDZixDQUFDLElBQUksQ0FBQyxJQUFJYyxtQkFBbUIsQ0FBQ2QsQ0FBQyxDQUFDLENBQUE7QUFDakUsSUFBQSxNQUFNbUIsRUFBRSxHQUFHRixJQUFJLENBQUNDLElBQUksQ0FBQyxDQUFDSCxVQUFVLENBQUNiLENBQUMsSUFBSSxDQUFDLElBQUlZLG1CQUFtQixDQUFDWixDQUFDLENBQUMsQ0FBQTtJQUNqRSxPQUFPZSxJQUFJLENBQUNHLEdBQUcsQ0FBQyxDQUFDLEVBQUdKLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDakQsV0FBVyxDQUFDLEdBQUdvRCxFQUFFLEdBQUcsSUFBSSxDQUFDcEQsV0FBWSxDQUFDLENBQUE7QUFDN0UsR0FBQTtBQUVBVSxFQUFBQSxTQUFTQSxDQUFDNEMsS0FBSyxFQUFFQyxNQUFNLEVBQUU7SUFDckIsSUFBSSxJQUFJLENBQUNyRCxZQUFZLEVBQUU7TUFDbkIsSUFBSSxDQUFDUixXQUFXLENBQUM4RCxHQUFHLENBQUNGLEtBQUssRUFBRUMsTUFBTSxDQUFDLENBQUE7QUFDbkMsTUFBQSxJQUFJLENBQUNQLFVBQVUsR0FBRyxJQUFJLENBQUN0RCxXQUFXLENBQUM7QUFDdkMsS0FBQTtBQUNKLEdBQUE7O0VBRUErRCxZQUFZQSxDQUFDdEMsT0FBTyxFQUFFO0FBQ2xCLElBQUEsSUFBSSxDQUFDZCxTQUFTLENBQUNxRCxHQUFHLENBQUN2QyxPQUFPLENBQUMsQ0FBQTtBQUMvQixHQUFBO0VBRUF3QyxjQUFjQSxDQUFDeEMsT0FBTyxFQUFFO0FBQ3BCLElBQUEsSUFBSSxDQUFDZCxTQUFTLENBQUN1RCxNQUFNLENBQUN6QyxPQUFPLENBQUMsQ0FBQTtBQUNsQyxHQUFBO0FBRUEwQyxFQUFBQSxRQUFRQSxHQUFHO0FBQ1AsSUFBQSxJQUFJLENBQUNyRSxNQUFNLENBQUNlLEdBQUcsQ0FBQ0MsY0FBYyxDQUFDc0QsR0FBRyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUNwRCxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUE7QUFDeEUsSUFBQSxJQUFJLENBQUNvQixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7QUFFbkIsSUFBQSxJQUFJLENBQUN6QixTQUFTLENBQUMwRCxPQUFPLENBQUM1QyxPQUFPLElBQUlBLE9BQU8sQ0FBQzZDLGVBQWUsRUFBRSxDQUFDLENBQUE7QUFDNUQsSUFBQSxJQUFJLENBQUMzRCxTQUFTLENBQUM0RCxLQUFLLEVBQUUsQ0FBQTs7QUFFdEI7SUFDQSxJQUFJLENBQUNILEdBQUcsRUFBRSxDQUFBO0FBRWQsR0FBQTs7QUFFQTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDSSxJQUFJZCxVQUFVQSxDQUFDa0IsS0FBSyxFQUFFO0FBQ2xCLElBQUEsSUFBSSxDQUFDLElBQUksQ0FBQ2hFLFlBQVksRUFBRTtBQUNwQixNQUFBLElBQUksQ0FBQ1IsV0FBVyxDQUFDOEQsR0FBRyxDQUFDVSxLQUFLLENBQUNqQyxDQUFDLEVBQUVpQyxLQUFLLENBQUMvQixDQUFDLENBQUMsQ0FBQTtBQUMxQyxLQUFDLE1BQU07QUFDSDtNQUNBLElBQUksQ0FBQ3pDLFdBQVcsQ0FBQzhELEdBQUcsQ0FBQyxJQUFJLENBQUNoRSxNQUFNLENBQUNlLEdBQUcsQ0FBQ0MsY0FBYyxDQUFDOEMsS0FBSyxFQUFFLElBQUksQ0FBQzlELE1BQU0sQ0FBQ2UsR0FBRyxDQUFDQyxjQUFjLENBQUMrQyxNQUFNLENBQUMsQ0FBQTtBQUNyRyxLQUFBO0lBRUEsSUFBSSxDQUFDVixZQUFZLEVBQUUsQ0FBQTtJQUVuQixJQUFJLENBQUNkLHFCQUFxQixFQUFFLENBQUE7QUFFNUIsSUFBQSxJQUFJLENBQUMsSUFBSSxDQUFDdEMsTUFBTSxDQUFDMEUsV0FBVyxFQUN4QixJQUFJLENBQUMxRSxNQUFNLENBQUMyRSxhQUFhLEVBQUUsQ0FBQTtJQUUvQixJQUFJLENBQUN0QyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDcEMsV0FBVyxDQUFDLENBQUE7QUFDN0MsSUFBQSxJQUFJLENBQUNXLFNBQVMsQ0FBQzBELE9BQU8sQ0FBQzVDLE9BQU8sSUFBSUEsT0FBTyxDQUFDa0QsZUFBZSxDQUFDLElBQUksQ0FBQzNFLFdBQVcsQ0FBQyxDQUFDLENBQUE7QUFDaEYsR0FBQTtFQUVBLElBQUlzRCxVQUFVQSxHQUFHO0lBQ2IsT0FBTyxJQUFJLENBQUN0RCxXQUFXLENBQUE7QUFDM0IsR0FBQTs7QUFFQTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNJLElBQUlxRCxtQkFBbUJBLENBQUNtQixLQUFLLEVBQUU7QUFDM0IsSUFBQSxJQUFJLENBQUN0RSxvQkFBb0IsQ0FBQzRELEdBQUcsQ0FBQ1UsS0FBSyxDQUFDakMsQ0FBQyxFQUFFaUMsS0FBSyxDQUFDL0IsQ0FBQyxDQUFDLENBQUE7SUFDL0MsSUFBSSxDQUFDVSxZQUFZLEVBQUUsQ0FBQTtJQUNuQixJQUFJLENBQUNkLHFCQUFxQixFQUFFLENBQUE7QUFFNUIsSUFBQSxJQUFJLENBQUMsSUFBSSxDQUFDdEMsTUFBTSxDQUFDMEUsV0FBVyxFQUN4QixJQUFJLENBQUMxRSxNQUFNLENBQUMyRSxhQUFhLEVBQUUsQ0FBQTtJQUUvQixJQUFJLENBQUN0QyxJQUFJLENBQUMseUJBQXlCLEVBQUUsSUFBSSxDQUFDcEMsV0FBVyxDQUFDLENBQUE7QUFDdEQsSUFBQSxJQUFJLENBQUNXLFNBQVMsQ0FBQzBELE9BQU8sQ0FBQzVDLE9BQU8sSUFBSUEsT0FBTyxDQUFDa0QsZUFBZSxDQUFDLElBQUksQ0FBQzNFLFdBQVcsQ0FBQyxDQUFDLENBQUE7QUFDaEYsR0FBQTtFQUVBLElBQUlxRCxtQkFBbUJBLEdBQUc7QUFDdEIsSUFBQSxJQUFJLElBQUksQ0FBQ2xELFVBQVUsS0FBS0MsY0FBYyxFQUFFO01BQ3BDLE9BQU8sSUFBSSxDQUFDSixXQUFXLENBQUE7QUFDM0IsS0FBQTtJQUNBLE9BQU8sSUFBSSxDQUFDRSxvQkFBb0IsQ0FBQTtBQUNwQyxHQUFBOztBQUVBO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNJLElBQUkwRSxXQUFXQSxDQUFDSixLQUFLLEVBQUU7SUFDbkIsSUFBSSxDQUFDaEUsWUFBWSxHQUFHZ0UsS0FBSyxDQUFBO0lBQ3pCLElBQUksSUFBSSxDQUFDaEUsWUFBWSxFQUFFO01BQ25CLElBQUksQ0FBQ1IsV0FBVyxDQUFDOEQsR0FBRyxDQUFDLElBQUksQ0FBQ2hFLE1BQU0sQ0FBQ2UsR0FBRyxDQUFDQyxjQUFjLENBQUM4QyxLQUFLLEVBQUUsSUFBSSxDQUFDOUQsTUFBTSxDQUFDZSxHQUFHLENBQUNDLGNBQWMsQ0FBQytDLE1BQU0sQ0FBQyxDQUFBO0FBQ3JHLEtBQUE7QUFDQSxJQUFBLElBQUksQ0FBQ1AsVUFBVSxHQUFHLElBQUksQ0FBQ3RELFdBQVcsQ0FBQzs7QUFFbkMsSUFBQSxJQUFJLENBQUMsSUFBSSxDQUFDRCxNQUFNLENBQUMwRSxXQUFXLEVBQ3hCLElBQUksQ0FBQzFFLE1BQU0sQ0FBQzJFLGFBQWEsRUFBRSxDQUFBO0lBRS9CLElBQUksQ0FBQ3RDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUM1QixZQUFZLENBQUMsQ0FBQTtBQUUvQyxJQUFBLElBQUksQ0FBQ0csU0FBUyxDQUFDMEQsT0FBTyxDQUFDNUMsT0FBTyxJQUFJQSxPQUFPLENBQUNvRCxvQkFBb0IsRUFBRSxDQUFDLENBQUE7QUFDckUsR0FBQTtFQUVBLElBQUlELFdBQVdBLEdBQUc7SUFDZCxPQUFPLElBQUksQ0FBQ3BFLFlBQVksQ0FBQTtBQUM1QixHQUFBOztBQUVBO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNJLElBQUlzRSxTQUFTQSxDQUFDTixLQUFLLEVBQUU7QUFDakIsSUFBQSxJQUFJQSxLQUFLLEtBQUtwRSxjQUFjLElBQUlvRSxLQUFLLEtBQUtPLGVBQWUsRUFBRTtBQUN2RFAsTUFBQUEsS0FBSyxHQUFHcEUsY0FBYyxDQUFBO0FBQzFCLEtBQUE7O0FBRUE7SUFDQSxJQUFJLENBQUMsSUFBSSxDQUFDSSxZQUFZLElBQUlnRSxLQUFLLEtBQUtwRSxjQUFjLEVBQUU7QUFDaERvRSxNQUFBQSxLQUFLLEdBQUdwRSxjQUFjLENBQUE7QUFDMUIsS0FBQTtJQUVBLElBQUksQ0FBQ0QsVUFBVSxHQUFHcUUsS0FBSyxDQUFBO0FBQ3ZCLElBQUEsSUFBSSxDQUFDbEIsVUFBVSxHQUFHLElBQUksQ0FBQ3RELFdBQVcsQ0FBQztJQUNuQyxJQUFJLENBQUNvQyxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQ2pDLFVBQVUsQ0FBQyxDQUFBO0FBQy9DLEdBQUE7RUFFQSxJQUFJMkUsU0FBU0EsR0FBRztJQUNaLE9BQU8sSUFBSSxDQUFDM0UsVUFBVSxDQUFBO0FBQzFCLEdBQUE7O0FBRUE7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDSSxJQUFJNkUsVUFBVUEsQ0FBQ1IsS0FBSyxFQUFFO0lBQ2xCLElBQUksQ0FBQ2xFLFdBQVcsR0FBR2tFLEtBQUssQ0FBQTtJQUN4QixJQUFJLENBQUNyQixZQUFZLEVBQUUsQ0FBQTtJQUNuQixJQUFJLENBQUNkLHFCQUFxQixFQUFFLENBQUE7QUFFNUIsSUFBQSxJQUFJLENBQUMsSUFBSSxDQUFDdEMsTUFBTSxDQUFDMEUsV0FBVyxFQUN4QixJQUFJLENBQUMxRSxNQUFNLENBQUMyRSxhQUFhLEVBQUUsQ0FBQTtJQUUvQixJQUFJLENBQUN0QyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDOUIsV0FBVyxDQUFDLENBQUE7QUFFN0MsSUFBQSxJQUFJLENBQUNLLFNBQVMsQ0FBQzBELE9BQU8sQ0FBQzVDLE9BQU8sSUFBSUEsT0FBTyxDQUFDa0QsZUFBZSxDQUFDLElBQUksQ0FBQzNFLFdBQVcsQ0FBQyxDQUFDLENBQUE7QUFDaEYsR0FBQTtFQUVBLElBQUlnRixVQUFVQSxHQUFHO0lBQ2IsT0FBTyxJQUFJLENBQUMxRSxXQUFXLENBQUE7QUFDM0IsR0FBQTs7QUFFQTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNJLElBQUkyRSxRQUFRQSxDQUFDVCxLQUFLLEVBQUU7SUFDaEIsSUFBSUEsS0FBSyxHQUFHLElBQUksRUFBRTtBQUNkVSxNQUFBQSxLQUFLLENBQUNDLElBQUksQ0FBRSxDQUFnQ1gsOEJBQUFBLEVBQUFBLEtBQU0sU0FBUSxDQUFDLENBQUE7QUFDM0RBLE1BQUFBLEtBQUssR0FBRyxJQUFJLENBQUE7QUFDaEIsS0FBQTtBQUNBLElBQUEsSUFBSSxJQUFJLENBQUNqRSxTQUFTLEtBQUtpRSxLQUFLLEVBQUU7QUFDMUIsTUFBQSxPQUFBO0FBQ0osS0FBQTtJQUVBLElBQUksQ0FBQ2pFLFNBQVMsR0FBR2lFLEtBQUssQ0FBQTtJQUN0QixJQUFJLENBQUN2RCxhQUFhLEVBQUUsQ0FBQTtBQUN4QixHQUFBO0VBRUEsSUFBSWdFLFFBQVFBLEdBQUc7SUFDWCxPQUFPLElBQUksQ0FBQzFFLFNBQVMsQ0FBQTtBQUN6QixHQUFBO0FBQ0o7Ozs7In0=
