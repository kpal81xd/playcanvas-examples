import { platform } from '../../core/platform.js';
import { script } from '../script.js';
import { ScriptType } from '../script/script-type.js';
import { ScriptTypes } from '../script/script-types.js';
import { registerScript } from '../script/script.js';
import { ResourceLoader } from './loader.js';
import { ResourceHandler } from './handler.js';

/**
 * Resource handler for loading JavaScript files dynamically.  Two types of JavaScript files can be
 * loaded, PlayCanvas scripts which contain calls to {@link createScript}, or regular JavaScript
 * files, such as third-party libraries.
 *
 * @category Script
 */
class ScriptHandler extends ResourceHandler {
  /**
   * Create a new ScriptHandler instance.
   *
   * @param {import('../app-base.js').AppBase} app - The running {@link AppBase}.
   * @ignore
   */
  constructor(app) {
    super(app, 'script');
    this._scripts = {};
    this._cache = {};
  }
  clearCache() {
    for (const key in this._cache) {
      const element = this._cache[key];
      const parent = element.parentNode;
      if (parent) parent.removeChild(element);
    }
    this._cache = {};
  }
  load(url, callback) {
    // Scripts don't support bundling since we concatenate them. Below is for consistency.
    if (typeof url === 'string') {
      url = {
        load: url,
        original: url
      };
    }
    const self = this;
    script.app = this._app;
    const onScriptLoad = (url.load, (err, url, extra) => {
      if (!err) {
        if (script.legacy) {
          let Type = null;
          // pop the type from the loading stack
          if (ScriptTypes._types.length) {
            Type = ScriptTypes._types.pop();
          }
          if (Type) {
            // store indexed by URL
            this._scripts[url] = Type;
          } else {
            Type = null;
          }

          // return the resource
          callback(null, Type, extra);
        } else {
          const obj = {};
          for (let i = 0; i < ScriptTypes._types.length; i++) obj[ScriptTypes._types[i].name] = ScriptTypes._types[i];
          ScriptTypes._types.length = 0;
          callback(null, obj, extra);

          // no cache for scripts
          delete self._loader._cache[ResourceLoader.makeKey(url, 'script')];
        }
      } else {
        callback(err);
      }
    });

    // check if we're loading a module or a classic script
    const [basePath, search] = url.load.split('?');
    const isEsmScript = basePath.endsWith('.mjs');
    if (isEsmScript) {
      // The browser will hold its own cache of the script, so we need to bust it
      let path = url.load;
      if (path.startsWith(this._app.assets.prefix)) {
        path = path.replace(this._app.assets.prefix, '');
      }
      const hash = this._app.assets.getByUrl(path).file.hash;
      const searchParams = new URLSearchParams(search);
      searchParams.set('hash', hash);
      const urlWithHash = `${basePath}?${searchParams.toString()}`;
      this._loadModule(urlWithHash, onScriptLoad);
    } else {
      this._loadScript(url.load, onScriptLoad);
    }
  }
  open(url, data) {
    return data;
  }
  patch(asset, assets) {}
  _loadScript(url, callback) {
    const head = document.head;
    const element = document.createElement('script');
    this._cache[url] = element;

    // use async=false to force scripts to execute in order
    element.async = false;
    element.addEventListener('error', function (e) {
      callback(`Script: ${e.target.src} failed to load`);
    }, false);
    let done = false;
    element.onload = element.onreadystatechange = function () {
      if (!done && (!this.readyState || this.readyState === 'loaded' || this.readyState === 'complete')) {
        done = true; // prevent double event firing
        callback(null, url, element);
      }
    };
    // set the src attribute after the onload callback is set, to avoid an instant loading failing to fire the callback
    element.src = url;
    head.appendChild(element);
  }
  _loadModule(url, callback) {
    // if we're in the browser, we need to use the full URL
    const baseUrl = platform.browser ? window.location.origin : import.meta.url;
    const importUrl = new URL(url, baseUrl);

    // @ts-ignore
    import(importUrl.toString()).then(module => {
      for (const key in module) {
        const scriptClass = module[key];
        const extendsScriptType = scriptClass.prototype instanceof ScriptType;
        if (extendsScriptType) {
          if (script.attributesDefinition) {
            for (const _key in script.attributesDefinition) {
              scriptClass.attributes.add(_key, script.attributesDefinition[_key]);
            }
          }
          registerScript(scriptClass, scriptClass.name.toLowerCase());
        }
      }
      callback(null, url, null);
    }).catch(err => {
      callback(err);
    });
  }
}

export { ScriptHandler };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyaXB0LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL2hhbmRsZXJzL3NjcmlwdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwbGF0Zm9ybSB9IGZyb20gJy4uLy4uL2NvcmUvcGxhdGZvcm0uanMnO1xuaW1wb3J0IHsgc2NyaXB0IH0gZnJvbSAnLi4vc2NyaXB0LmpzJztcbmltcG9ydCB7IFNjcmlwdFR5cGUgfSBmcm9tICcuLi9zY3JpcHQvc2NyaXB0LXR5cGUuanMnO1xuaW1wb3J0IHsgU2NyaXB0VHlwZXMgfSBmcm9tICcuLi9zY3JpcHQvc2NyaXB0LXR5cGVzLmpzJztcbmltcG9ydCB7IHJlZ2lzdGVyU2NyaXB0IH0gZnJvbSAnLi4vc2NyaXB0L3NjcmlwdC5qcyc7XG5pbXBvcnQgeyBSZXNvdXJjZUxvYWRlciB9IGZyb20gJy4vbG9hZGVyLmpzJztcblxuaW1wb3J0IHsgUmVzb3VyY2VIYW5kbGVyIH0gZnJvbSAnLi9oYW5kbGVyLmpzJztcblxuLyoqXG4gKiBSZXNvdXJjZSBoYW5kbGVyIGZvciBsb2FkaW5nIEphdmFTY3JpcHQgZmlsZXMgZHluYW1pY2FsbHkuICBUd28gdHlwZXMgb2YgSmF2YVNjcmlwdCBmaWxlcyBjYW4gYmVcbiAqIGxvYWRlZCwgUGxheUNhbnZhcyBzY3JpcHRzIHdoaWNoIGNvbnRhaW4gY2FsbHMgdG8ge0BsaW5rIGNyZWF0ZVNjcmlwdH0sIG9yIHJlZ3VsYXIgSmF2YVNjcmlwdFxuICogZmlsZXMsIHN1Y2ggYXMgdGhpcmQtcGFydHkgbGlicmFyaWVzLlxuICpcbiAqIEBjYXRlZ29yeSBTY3JpcHRcbiAqL1xuY2xhc3MgU2NyaXB0SGFuZGxlciBleHRlbmRzIFJlc291cmNlSGFuZGxlciB7XG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IFNjcmlwdEhhbmRsZXIgaW5zdGFuY2UuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi4vYXBwLWJhc2UuanMnKS5BcHBCYXNlfSBhcHAgLSBUaGUgcnVubmluZyB7QGxpbmsgQXBwQmFzZX0uXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGFwcCkge1xuICAgICAgICBzdXBlcihhcHAsICdzY3JpcHQnKTtcblxuICAgICAgICB0aGlzLl9zY3JpcHRzID0geyB9O1xuICAgICAgICB0aGlzLl9jYWNoZSA9IHsgfTtcbiAgICB9XG5cbiAgICBjbGVhckNhY2hlKCkge1xuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLl9jYWNoZSkge1xuICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuX2NhY2hlW2tleV07XG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7XG4gICAgICAgICAgICBpZiAocGFyZW50KVxuICAgICAgICAgICAgICAgIHBhcmVudC5yZW1vdmVDaGlsZChlbGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9jYWNoZSA9IHt9O1xuICAgIH1cblxuICAgIGxvYWQodXJsLCBjYWxsYmFjaykge1xuICAgICAgICAvLyBTY3JpcHRzIGRvbid0IHN1cHBvcnQgYnVuZGxpbmcgc2luY2Ugd2UgY29uY2F0ZW5hdGUgdGhlbS4gQmVsb3cgaXMgZm9yIGNvbnNpc3RlbmN5LlxuICAgICAgICBpZiAodHlwZW9mIHVybCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHVybCA9IHtcbiAgICAgICAgICAgICAgICBsb2FkOiB1cmwsXG4gICAgICAgICAgICAgICAgb3JpZ2luYWw6IHVybFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICBzY3JpcHQuYXBwID0gdGhpcy5fYXBwO1xuXG4gICAgICAgIGNvbnN0IG9uU2NyaXB0TG9hZCA9ICh1cmwubG9hZCwgKGVyciwgdXJsLCBleHRyYSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2NyaXB0LmxlZ2FjeSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgVHlwZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIC8vIHBvcCB0aGUgdHlwZSBmcm9tIHRoZSBsb2FkaW5nIHN0YWNrXG4gICAgICAgICAgICAgICAgICAgIGlmIChTY3JpcHRUeXBlcy5fdHlwZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBUeXBlID0gU2NyaXB0VHlwZXMuX3R5cGVzLnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKFR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIGluZGV4ZWQgYnkgVVJMXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zY3JpcHRzW3VybF0gPSBUeXBlO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgVHlwZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm4gdGhlIHJlc291cmNlXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIFR5cGUsIGV4dHJhKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmogPSB7IH07XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBTY3JpcHRUeXBlcy5fdHlwZXMubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmpbU2NyaXB0VHlwZXMuX3R5cGVzW2ldLm5hbWVdID0gU2NyaXB0VHlwZXMuX3R5cGVzW2ldO1xuXG4gICAgICAgICAgICAgICAgICAgIFNjcmlwdFR5cGVzLl90eXBlcy5sZW5ndGggPSAwO1xuXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG9iaiwgZXh0cmEpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIG5vIGNhY2hlIGZvciBzY3JpcHRzXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBzZWxmLl9sb2FkZXIuX2NhY2hlW1Jlc291cmNlTG9hZGVyLm1ha2VLZXkodXJsLCAnc2NyaXB0JyldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gY2hlY2sgaWYgd2UncmUgbG9hZGluZyBhIG1vZHVsZSBvciBhIGNsYXNzaWMgc2NyaXB0XG4gICAgICAgIGNvbnN0IFtiYXNlUGF0aCwgc2VhcmNoXSA9IHVybC5sb2FkLnNwbGl0KCc/Jyk7XG4gICAgICAgIGNvbnN0IGlzRXNtU2NyaXB0ID0gYmFzZVBhdGguZW5kc1dpdGgoJy5tanMnKTtcblxuICAgICAgICBpZiAoaXNFc21TY3JpcHQpIHtcblxuICAgICAgICAgICAgLy8gVGhlIGJyb3dzZXIgd2lsbCBob2xkIGl0cyBvd24gY2FjaGUgb2YgdGhlIHNjcmlwdCwgc28gd2UgbmVlZCB0byBidXN0IGl0XG4gICAgICAgICAgICBsZXQgcGF0aCA9IHVybC5sb2FkO1xuICAgICAgICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCh0aGlzLl9hcHAuYXNzZXRzLnByZWZpeCkpIHtcbiAgICAgICAgICAgICAgICBwYXRoID0gcGF0aC5yZXBsYWNlKHRoaXMuX2FwcC5hc3NldHMucHJlZml4LCAnJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGhhc2ggPSB0aGlzLl9hcHAuYXNzZXRzLmdldEJ5VXJsKHBhdGgpLmZpbGUuaGFzaDtcbiAgICAgICAgICAgIGNvbnN0IHNlYXJjaFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMoc2VhcmNoKTtcbiAgICAgICAgICAgIHNlYXJjaFBhcmFtcy5zZXQoJ2hhc2gnLCBoYXNoKTtcbiAgICAgICAgICAgIGNvbnN0IHVybFdpdGhIYXNoID0gYCR7YmFzZVBhdGh9PyR7c2VhcmNoUGFyYW1zLnRvU3RyaW5nKCl9YDtcblxuICAgICAgICAgICAgdGhpcy5fbG9hZE1vZHVsZSh1cmxXaXRoSGFzaCwgb25TY3JpcHRMb2FkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2xvYWRTY3JpcHQodXJsLmxvYWQsIG9uU2NyaXB0TG9hZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvcGVuKHVybCwgZGF0YSkge1xuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG5cbiAgICBwYXRjaChhc3NldCwgYXNzZXRzKSB7IH1cblxuICAgIF9sb2FkU2NyaXB0KHVybCwgY2FsbGJhY2spIHtcbiAgICAgICAgY29uc3QgaGVhZCA9IGRvY3VtZW50LmhlYWQ7XG4gICAgICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgICAgdGhpcy5fY2FjaGVbdXJsXSA9IGVsZW1lbnQ7XG5cbiAgICAgICAgLy8gdXNlIGFzeW5jPWZhbHNlIHRvIGZvcmNlIHNjcmlwdHMgdG8gZXhlY3V0ZSBpbiBvcmRlclxuICAgICAgICBlbGVtZW50LmFzeW5jID0gZmFsc2U7XG5cbiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhgU2NyaXB0OiAke2UudGFyZ2V0LnNyY30gZmFpbGVkIHRvIGxvYWRgKTtcbiAgICAgICAgfSwgZmFsc2UpO1xuXG4gICAgICAgIGxldCBkb25lID0gZmFsc2U7XG4gICAgICAgIGVsZW1lbnQub25sb2FkID0gZWxlbWVudC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoIWRvbmUgJiYgKCF0aGlzLnJlYWR5U3RhdGUgfHwgKHRoaXMucmVhZHlTdGF0ZSA9PT0gJ2xvYWRlZCcgfHwgdGhpcy5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSkpIHtcbiAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsgLy8gcHJldmVudCBkb3VibGUgZXZlbnQgZmlyaW5nXG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgdXJsLCBlbGVtZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgLy8gc2V0IHRoZSBzcmMgYXR0cmlidXRlIGFmdGVyIHRoZSBvbmxvYWQgY2FsbGJhY2sgaXMgc2V0LCB0byBhdm9pZCBhbiBpbnN0YW50IGxvYWRpbmcgZmFpbGluZyB0byBmaXJlIHRoZSBjYWxsYmFja1xuICAgICAgICBlbGVtZW50LnNyYyA9IHVybDtcblxuICAgICAgICBoZWFkLmFwcGVuZENoaWxkKGVsZW1lbnQpO1xuICAgIH1cblxuICAgIF9sb2FkTW9kdWxlKHVybCwgY2FsbGJhY2spIHtcblxuICAgICAgICAvLyBpZiB3ZSdyZSBpbiB0aGUgYnJvd3Nlciwgd2UgbmVlZCB0byB1c2UgdGhlIGZ1bGwgVVJMXG4gICAgICAgIGNvbnN0IGJhc2VVcmwgPSBwbGF0Zm9ybS5icm93c2VyID8gd2luZG93LmxvY2F0aW9uLm9yaWdpbiA6IGltcG9ydC5tZXRhLnVybDtcbiAgICAgICAgY29uc3QgaW1wb3J0VXJsID0gbmV3IFVSTCh1cmwsIGJhc2VVcmwpO1xuXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgaW1wb3J0KGltcG9ydFVybC50b1N0cmluZygpKS50aGVuKChtb2R1bGUpID0+IHtcblxuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gbW9kdWxlKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2NyaXB0Q2xhc3MgPSBtb2R1bGVba2V5XTtcbiAgICAgICAgICAgICAgICBjb25zdCBleHRlbmRzU2NyaXB0VHlwZSA9IHNjcmlwdENsYXNzLnByb3RvdHlwZSBpbnN0YW5jZW9mIFNjcmlwdFR5cGU7XG5cbiAgICAgICAgICAgICAgICBpZiAoZXh0ZW5kc1NjcmlwdFR5cGUpIHtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc2NyaXB0LmF0dHJpYnV0ZXNEZWZpbml0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBzY3JpcHQuYXR0cmlidXRlc0RlZmluaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRDbGFzcy5hdHRyaWJ1dGVzLmFkZChrZXksIHNjcmlwdC5hdHRyaWJ1dGVzRGVmaW5pdGlvbltrZXldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHJlZ2lzdGVyU2NyaXB0KHNjcmlwdENsYXNzLCBzY3JpcHRDbGFzcy5uYW1lLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgdXJsLCBudWxsKTtcblxuICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IFNjcmlwdEhhbmRsZXIgfTtcbiJdLCJuYW1lcyI6WyJTY3JpcHRIYW5kbGVyIiwiUmVzb3VyY2VIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJhcHAiLCJfc2NyaXB0cyIsIl9jYWNoZSIsImNsZWFyQ2FjaGUiLCJrZXkiLCJlbGVtZW50IiwicGFyZW50IiwicGFyZW50Tm9kZSIsInJlbW92ZUNoaWxkIiwibG9hZCIsInVybCIsImNhbGxiYWNrIiwib3JpZ2luYWwiLCJzZWxmIiwic2NyaXB0IiwiX2FwcCIsIm9uU2NyaXB0TG9hZCIsImVyciIsImV4dHJhIiwibGVnYWN5IiwiVHlwZSIsIlNjcmlwdFR5cGVzIiwiX3R5cGVzIiwibGVuZ3RoIiwicG9wIiwib2JqIiwiaSIsIm5hbWUiLCJfbG9hZGVyIiwiUmVzb3VyY2VMb2FkZXIiLCJtYWtlS2V5IiwiYmFzZVBhdGgiLCJzZWFyY2giLCJzcGxpdCIsImlzRXNtU2NyaXB0IiwiZW5kc1dpdGgiLCJwYXRoIiwic3RhcnRzV2l0aCIsImFzc2V0cyIsInByZWZpeCIsInJlcGxhY2UiLCJoYXNoIiwiZ2V0QnlVcmwiLCJmaWxlIiwic2VhcmNoUGFyYW1zIiwiVVJMU2VhcmNoUGFyYW1zIiwic2V0IiwidXJsV2l0aEhhc2giLCJ0b1N0cmluZyIsIl9sb2FkTW9kdWxlIiwiX2xvYWRTY3JpcHQiLCJvcGVuIiwiZGF0YSIsInBhdGNoIiwiYXNzZXQiLCJoZWFkIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwiYXN5bmMiLCJhZGRFdmVudExpc3RlbmVyIiwiZSIsInRhcmdldCIsInNyYyIsImRvbmUiLCJvbmxvYWQiLCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCJyZWFkeVN0YXRlIiwiYXBwZW5kQ2hpbGQiLCJiYXNlVXJsIiwicGxhdGZvcm0iLCJicm93c2VyIiwid2luZG93IiwibG9jYXRpb24iLCJvcmlnaW4iLCJpbXBvcnQiLCJtZXRhIiwiaW1wb3J0VXJsIiwiVVJMIiwidGhlbiIsIm1vZHVsZSIsInNjcmlwdENsYXNzIiwiZXh0ZW5kc1NjcmlwdFR5cGUiLCJwcm90b3R5cGUiLCJTY3JpcHRUeXBlIiwiYXR0cmlidXRlc0RlZmluaXRpb24iLCJhdHRyaWJ1dGVzIiwiYWRkIiwicmVnaXN0ZXJTY3JpcHQiLCJ0b0xvd2VyQ2FzZSIsImNhdGNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQVNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTUEsYUFBYSxTQUFTQyxlQUFlLENBQUM7QUFDeEM7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0lDLFdBQVdBLENBQUNDLEdBQUcsRUFBRTtBQUNiLElBQUEsS0FBSyxDQUFDQSxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUE7QUFFcEIsSUFBQSxJQUFJLENBQUNDLFFBQVEsR0FBRyxFQUFHLENBQUE7QUFD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
