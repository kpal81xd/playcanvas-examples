import { Debug } from '../../core/debug.js';
import { TRACEID_BINDGROUP_ALLOC } from '../../core/constants.js';
import { UNIFORM_BUFFER_DEFAULT_SLOT_NAME } from './constants.js';
import { DebugGraphics } from './debug-graphics.js';

let id = 0;

/**
 * A bind group represents an collection of {@link UniformBuffer} and {@link Texture} instance,
 * which can be bind on a GPU for rendering.
 *
 * @ignore
 */
class BindGroup {
  /**
   * Create a new Bind Group.
   *
   * @param {import('./graphics-device.js').GraphicsDevice} graphicsDevice - The graphics device
   * used to manage this uniform buffer.
   * @param {import('./bind-group-format.js').BindGroupFormat} format - Format of the bind group.
   * @param {import('./uniform-buffer.js').UniformBuffer} [defaultUniformBuffer] - The default
   * uniform buffer. Typically a bind group only has a single uniform buffer, and this allows
   * easier access.
   */
  constructor(graphicsDevice, format, defaultUniformBuffer) {
    /**
     * A render version the bind group was last updated on.
     *
     * @type {number}
     * @ignore
     */
    this.renderVersionUpdated = -1;
    /** @type {import('./uniform-buffer.js').UniformBuffer[]} */
    this.uniformBuffers = void 0;
    /**
     * An array of offsets for each uniform buffer in the bind group. This is the offset in the
     * buffer where the uniform buffer data starts.
     *
     * @type {number[]}
     */
    this.uniformBufferOffsets = [];
    this.id = id++;
    this.device = graphicsDevice;
    this.format = format;
    this.dirty = true;
    this.impl = graphicsDevice.createBindGroupImpl(this);
    this.textures = [];
    this.storageTextures = [];
    this.uniformBuffers = [];

    /** @type {import('./uniform-buffer.js').UniformBuffer} */
    this.defaultUniformBuffer = defaultUniformBuffer;
    if (defaultUniformBuffer) {
      this.setUniformBuffer(UNIFORM_BUFFER_DEFAULT_SLOT_NAME, defaultUniformBuffer);
    }
    Debug.trace(TRACEID_BINDGROUP_ALLOC, `Alloc: Id ${this.id}`, this, format);
  }

  /**
   * Frees resources associated with this bind group.
   */
  destroy() {
    this.impl.destroy();
    this.impl = null;
    this.format = null;
    this.defaultUniformBuffer = null;
  }

  /**
   * Assign a uniform buffer to a slot.
   *
   * @param {string} name - The name of the uniform buffer slot
   * @param {import('./uniform-buffer.js').UniformBuffer} uniformBuffer - The Uniform buffer to
   * assign to the slot.
   */
  setUniformBuffer(name, uniformBuffer) {
    const index = this.format.bufferFormatsMap.get(name);
    Debug.assert(index !== undefined, `Setting a uniform [${name}] on a bind group with id ${this.id} which does not contain in, while rendering [${DebugGraphics.toString()}]`, this);
    if (this.uniformBuffers[index] !== uniformBuffer) {
      this.uniformBuffers[index] = uniformBuffer;
      this.dirty = true;
    }
  }

  /**
   * Assign a texture to a named slot.
   *
   * @param {string} name - The name of the texture slot.
   * @param {import('./texture.js').Texture} texture - Texture to assign to the slot.
   */
  setTexture(name, texture) {
    const index = this.format.textureFormatsMap.get(name);
    Debug.assert(index !== undefined, `Setting a texture [${name}] on a bind group with id: ${this.id} which does not contain in, while rendering [${DebugGraphics.toString()}]`, this);
    if (this.textures[index] !== texture) {
      this.textures[index] = texture;
      this.dirty = true;
    } else if (this.renderVersionUpdated < texture.renderVersionDirty) {
      // if the texture properties have changed
      this.dirty = true;
    }
  }

  /**
   * Assign a storage texture to a named slot.
   *
   * @param {string} name - The name of the texture slot.
   * @param {import('./texture.js').Texture} texture - Texture to assign to the slot.
   */
  setStorageTexture(name, texture) {
    const index = this.format.storageTextureFormatsMap.get(name);
    Debug.assert(index !== undefined, `Setting a storage texture [${name}] on a bind group with id: ${this.id} which does not contain in, while rendering [${DebugGraphics.toString()}]`, this);
    if (this.storageTextures[index] !== texture) {
      this.storageTextures[index] = texture;
      this.dirty = true;
    } else if (this.renderVersionUpdated < texture.renderVersionDirty) {
      // if the texture properties have changed
      this.dirty = true;
    }
  }

  /**
   * Applies any changes made to the bind group's properties.
   */
  update() {
    // TODO: implement faster version of this, which does not call SetTexture, which does a map lookup
    const {
      textureFormats,
      storageTextureFormats
    } = this.format;
    for (let i = 0; i < textureFormats.length; i++) {
      const textureFormat = textureFormats[i];
      const value = textureFormat.scopeId.value;
      Debug.assert(value, `Value was not set when assigning texture slot [${textureFormat.name}] to a bind group, while rendering [${DebugGraphics.toString()}]`, this);
      this.setTexture(textureFormat.name, value);
    }
    for (let i = 0; i < storageTextureFormats.length; i++) {
      const storageTextureFormat = storageTextureFormats[i];
      const value = storageTextureFormat.scopeId.value;
      Debug.assert(value, `Value was not set when assigning storage texture slot [${storageTextureFormat.name}] to a bind group, while rendering [${DebugGraphics.toString()}]`, this);
      this.setStorageTexture(storageTextureFormat.name, value);
    }

    // update uniform buffer offsets
    this.uniformBufferOffsets.length = this.uniformBuffers.length;
    for (let i = 0; i < this.uniformBuffers.length; i++) {
      const uniformBuffer = this.uniformBuffers[i];

      // offset
      this.uniformBufferOffsets[i] = uniformBuffer.offset;

      // test if any of the uniform buffers have changed (not their content, but the buffer container itself)
      if (this.renderVersionUpdated < uniformBuffer.renderVersionDirty) {
        this.dirty = true;
      }
    }
    if (this.dirty) {
      this.dirty = false;
      this.renderVersionUpdated = this.device.renderVersion;
      this.impl.update(this);
    }
  }
}

export { BindGroup };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZC1ncm91cC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL3BsYXRmb3JtL2dyYXBoaWNzL2JpbmQtZ3JvdXAuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVidWcgfSBmcm9tICcuLi8uLi9jb3JlL2RlYnVnLmpzJztcbmltcG9ydCB7IFRSQUNFSURfQklOREdST1VQX0FMTE9DIH0gZnJvbSAnLi4vLi4vY29yZS9jb25zdGFudHMuanMnO1xuaW1wb3J0IHsgVU5JRk9STV9CVUZGRVJfREVGQVVMVF9TTE9UX05BTUUgfSBmcm9tICcuL2NvbnN0YW50cy5qcyc7XG5pbXBvcnQgeyBEZWJ1Z0dyYXBoaWNzIH0gZnJvbSAnLi9kZWJ1Zy1ncmFwaGljcy5qcyc7XG5cbmxldCBpZCA9IDA7XG5cbi8qKlxuICogQSBiaW5kIGdyb3VwIHJlcHJlc2VudHMgYW4gY29sbGVjdGlvbiBvZiB7QGxpbmsgVW5pZm9ybUJ1ZmZlcn0gYW5kIHtAbGluayBUZXh0dXJlfSBpbnN0YW5jZSxcbiAqIHdoaWNoIGNhbiBiZSBiaW5kIG9uIGEgR1BVIGZvciByZW5kZXJpbmcuXG4gKlxuICogQGlnbm9yZVxuICovXG5jbGFzcyBCaW5kR3JvdXAge1xuICAgIC8qKlxuICAgICAqIEEgcmVuZGVyIHZlcnNpb24gdGhlIGJpbmQgZ3JvdXAgd2FzIGxhc3QgdXBkYXRlZCBvbi5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIHJlbmRlclZlcnNpb25VcGRhdGVkID0gLTE7XG5cbiAgICAvKiogQHR5cGUge2ltcG9ydCgnLi91bmlmb3JtLWJ1ZmZlci5qcycpLlVuaWZvcm1CdWZmZXJbXX0gKi9cbiAgICB1bmlmb3JtQnVmZmVycztcblxuICAgIC8qKlxuICAgICAqIEFuIGFycmF5IG9mIG9mZnNldHMgZm9yIGVhY2ggdW5pZm9ybSBidWZmZXIgaW4gdGhlIGJpbmQgZ3JvdXAuIFRoaXMgaXMgdGhlIG9mZnNldCBpbiB0aGVcbiAgICAgKiBidWZmZXIgd2hlcmUgdGhlIHVuaWZvcm0gYnVmZmVyIGRhdGEgc3RhcnRzLlxuICAgICAqXG4gICAgICogQHR5cGUge251bWJlcltdfVxuICAgICAqL1xuICAgIHVuaWZvcm1CdWZmZXJPZmZzZXRzID0gW107XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgQmluZCBHcm91cC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW1wb3J0KCcuL2dyYXBoaWNzLWRldmljZS5qcycpLkdyYXBoaWNzRGV2aWNlfSBncmFwaGljc0RldmljZSAtIFRoZSBncmFwaGljcyBkZXZpY2VcbiAgICAgKiB1c2VkIHRvIG1hbmFnZSB0aGlzIHVuaWZvcm0gYnVmZmVyLlxuICAgICAqIEBwYXJhbSB7aW1wb3J0KCcuL2JpbmQtZ3JvdXAtZm9ybWF0LmpzJykuQmluZEdyb3VwRm9ybWF0fSBmb3JtYXQgLSBGb3JtYXQgb2YgdGhlIGJpbmQgZ3JvdXAuXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vdW5pZm9ybS1idWZmZXIuanMnKS5Vbmlmb3JtQnVmZmVyfSBbZGVmYXVsdFVuaWZvcm1CdWZmZXJdIC0gVGhlIGRlZmF1bHRcbiAgICAgKiB1bmlmb3JtIGJ1ZmZlci4gVHlwaWNhbGx5IGEgYmluZCBncm91cCBvbmx5IGhhcyBhIHNpbmdsZSB1bmlmb3JtIGJ1ZmZlciwgYW5kIHRoaXMgYWxsb3dzXG4gICAgICogZWFzaWVyIGFjY2Vzcy5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihncmFwaGljc0RldmljZSwgZm9ybWF0LCBkZWZhdWx0VW5pZm9ybUJ1ZmZlcikge1xuICAgICAgICB0aGlzLmlkID0gaWQrKztcbiAgICAgICAgdGhpcy5kZXZpY2UgPSBncmFwaGljc0RldmljZTtcbiAgICAgICAgdGhpcy5mb3JtYXQgPSBmb3JtYXQ7XG4gICAgICAgIHRoaXMuZGlydHkgPSB0cnVlO1xuICAgICAgICB0aGlzLmltcGwgPSBncmFwaGljc0RldmljZS5jcmVhdGVCaW5kR3JvdXBJbXBsKHRoaXMpO1xuXG4gICAgICAgIHRoaXMudGV4dHVyZXMgPSBbXTtcbiAgICAgICAgdGhpcy5zdG9yYWdlVGV4dHVyZXMgPSBbXTtcbiAgICAgICAgdGhpcy51bmlmb3JtQnVmZmVycyA9IFtdO1xuXG4gICAgICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuL3VuaWZvcm0tYnVmZmVyLmpzJykuVW5pZm9ybUJ1ZmZlcn0gKi9cbiAgICAgICAgdGhpcy5kZWZhdWx0VW5pZm9ybUJ1ZmZlciA9IGRlZmF1bHRVbmlmb3JtQnVmZmVyO1xuICAgICAgICBpZiAoZGVmYXVsdFVuaWZvcm1CdWZmZXIpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0VW5pZm9ybUJ1ZmZlcihVTklGT1JNX0JVRkZFUl9ERUZBVUxUX1NMT1RfTkFNRSwgZGVmYXVsdFVuaWZvcm1CdWZmZXIpO1xuICAgICAgICB9XG5cbiAgICAgICAgRGVidWcudHJhY2UoVFJBQ0VJRF9CSU5ER1JPVVBfQUxMT0MsIGBBbGxvYzogSWQgJHt0aGlzLmlkfWAsIHRoaXMsIGZvcm1hdCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRnJlZXMgcmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCB0aGlzIGJpbmQgZ3JvdXAuXG4gICAgICovXG4gICAgZGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5pbXBsLmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5pbXBsID0gbnVsbDtcbiAgICAgICAgdGhpcy5mb3JtYXQgPSBudWxsO1xuICAgICAgICB0aGlzLmRlZmF1bHRVbmlmb3JtQnVmZmVyID0gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBc3NpZ24gYSB1bmlmb3JtIGJ1ZmZlciB0byBhIHNsb3QuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSB1bmlmb3JtIGJ1ZmZlciBzbG90XG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vdW5pZm9ybS1idWZmZXIuanMnKS5Vbmlmb3JtQnVmZmVyfSB1bmlmb3JtQnVmZmVyIC0gVGhlIFVuaWZvcm0gYnVmZmVyIHRvXG4gICAgICogYXNzaWduIHRvIHRoZSBzbG90LlxuICAgICAqL1xuICAgIHNldFVuaWZvcm1CdWZmZXIobmFtZSwgdW5pZm9ybUJ1ZmZlcikge1xuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuZm9ybWF0LmJ1ZmZlckZvcm1hdHNNYXAuZ2V0KG5hbWUpO1xuICAgICAgICBEZWJ1Zy5hc3NlcnQoaW5kZXggIT09IHVuZGVmaW5lZCwgYFNldHRpbmcgYSB1bmlmb3JtIFske25hbWV9XSBvbiBhIGJpbmQgZ3JvdXAgd2l0aCBpZCAke3RoaXMuaWR9IHdoaWNoIGRvZXMgbm90IGNvbnRhaW4gaW4sIHdoaWxlIHJlbmRlcmluZyBbJHtEZWJ1Z0dyYXBoaWNzLnRvU3RyaW5nKCl9XWAsIHRoaXMpO1xuICAgICAgICBpZiAodGhpcy51bmlmb3JtQnVmZmVyc1tpbmRleF0gIT09IHVuaWZvcm1CdWZmZXIpIHtcbiAgICAgICAgICAgIHRoaXMudW5pZm9ybUJ1ZmZlcnNbaW5kZXhdID0gdW5pZm9ybUJ1ZmZlcjtcbiAgICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXNzaWduIGEgdGV4dHVyZSB0byBhIG5hbWVkIHNsb3QuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSB0ZXh0dXJlIHNsb3QuXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vdGV4dHVyZS5qcycpLlRleHR1cmV9IHRleHR1cmUgLSBUZXh0dXJlIHRvIGFzc2lnbiB0byB0aGUgc2xvdC5cbiAgICAgKi9cbiAgICBzZXRUZXh0dXJlKG5hbWUsIHRleHR1cmUpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmZvcm1hdC50ZXh0dXJlRm9ybWF0c01hcC5nZXQobmFtZSk7XG4gICAgICAgIERlYnVnLmFzc2VydChpbmRleCAhPT0gdW5kZWZpbmVkLCBgU2V0dGluZyBhIHRleHR1cmUgWyR7bmFtZX1dIG9uIGEgYmluZCBncm91cCB3aXRoIGlkOiAke3RoaXMuaWR9IHdoaWNoIGRvZXMgbm90IGNvbnRhaW4gaW4sIHdoaWxlIHJlbmRlcmluZyBbJHtEZWJ1Z0dyYXBoaWNzLnRvU3RyaW5nKCl9XWAsIHRoaXMpO1xuICAgICAgICBpZiAodGhpcy50ZXh0dXJlc1tpbmRleF0gIT09IHRleHR1cmUpIHtcbiAgICAgICAgICAgIHRoaXMudGV4dHVyZXNbaW5kZXhdID0gdGV4dHVyZTtcbiAgICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMucmVuZGVyVmVyc2lvblVwZGF0ZWQgPCB0ZXh0dXJlLnJlbmRlclZlcnNpb25EaXJ0eSkge1xuICAgICAgICAgICAgLy8gaWYgdGhlIHRleHR1cmUgcHJvcGVydGllcyBoYXZlIGNoYW5nZWRcbiAgICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXNzaWduIGEgc3RvcmFnZSB0ZXh0dXJlIHRvIGEgbmFtZWQgc2xvdC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHRleHR1cmUgc2xvdC5cbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi90ZXh0dXJlLmpzJykuVGV4dHVyZX0gdGV4dHVyZSAtIFRleHR1cmUgdG8gYXNzaWduIHRvIHRoZSBzbG90LlxuICAgICAqL1xuICAgIHNldFN0b3JhZ2VUZXh0dXJlKG5hbWUsIHRleHR1cmUpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmZvcm1hdC5zdG9yYWdlVGV4dHVyZUZvcm1hdHNNYXAuZ2V0KG5hbWUpO1xuICAgICAgICBEZWJ1Zy5hc3NlcnQoaW5kZXggIT09IHVuZGVmaW5lZCwgYFNldHRpbmcgYSBzdG9yYWdlIHRleHR1cmUgWyR7bmFtZX1dIG9uIGEgYmluZCBncm91cCB3aXRoIGlkOiAke3RoaXMuaWR9IHdoaWNoIGRvZXMgbm90IGNvbnRhaW4gaW4sIHdoaWxlIHJlbmRlcmluZyBbJHtEZWJ1Z0dyYXBoaWNzLnRvU3RyaW5nKCl9XWAsIHRoaXMpO1xuICAgICAgICBpZiAodGhpcy5zdG9yYWdlVGV4dHVyZXNbaW5kZXhdICE9PSB0ZXh0dXJlKSB7XG4gICAgICAgICAgICB0aGlzLnN0b3JhZ2VUZXh0dXJlc1tpbmRleF0gPSB0ZXh0dXJlO1xuICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5yZW5kZXJWZXJzaW9uVXBkYXRlZCA8IHRleHR1cmUucmVuZGVyVmVyc2lvbkRpcnR5KSB7XG4gICAgICAgICAgICAvLyBpZiB0aGUgdGV4dHVyZSBwcm9wZXJ0aWVzIGhhdmUgY2hhbmdlZFxuICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBcHBsaWVzIGFueSBjaGFuZ2VzIG1hZGUgdG8gdGhlIGJpbmQgZ3JvdXAncyBwcm9wZXJ0aWVzLlxuICAgICAqL1xuICAgIHVwZGF0ZSgpIHtcblxuICAgICAgICAvLyBUT0RPOiBpbXBsZW1lbnQgZmFzdGVyIHZlcnNpb24gb2YgdGhpcywgd2hpY2ggZG9lcyBub3QgY2FsbCBTZXRUZXh0dXJlLCB3aGljaCBkb2VzIGEgbWFwIGxvb2t1cFxuICAgICAgICBjb25zdCB7IHRleHR1cmVGb3JtYXRzLCBzdG9yYWdlVGV4dHVyZUZvcm1hdHMgfSA9IHRoaXMuZm9ybWF0O1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGV4dHVyZUZvcm1hdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHRleHR1cmVGb3JtYXQgPSB0ZXh0dXJlRm9ybWF0c1tpXTtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGV4dHVyZUZvcm1hdC5zY29wZUlkLnZhbHVlO1xuICAgICAgICAgICAgRGVidWcuYXNzZXJ0KHZhbHVlLCBgVmFsdWUgd2FzIG5vdCBzZXQgd2hlbiBhc3NpZ25pbmcgdGV4dHVyZSBzbG90IFske3RleHR1cmVGb3JtYXQubmFtZX1dIHRvIGEgYmluZCBncm91cCwgd2hpbGUgcmVuZGVyaW5nIFske0RlYnVnR3JhcGhpY3MudG9TdHJpbmcoKX1dYCwgdGhpcyk7XG4gICAgICAgICAgICB0aGlzLnNldFRleHR1cmUodGV4dHVyZUZvcm1hdC5uYW1lLCB2YWx1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0b3JhZ2VUZXh0dXJlRm9ybWF0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3Qgc3RvcmFnZVRleHR1cmVGb3JtYXQgPSBzdG9yYWdlVGV4dHVyZUZvcm1hdHNbaV07XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHN0b3JhZ2VUZXh0dXJlRm9ybWF0LnNjb3BlSWQudmFsdWU7XG4gICAgICAgICAgICBEZWJ1Zy5hc3NlcnQodmFsdWUsIGBWYWx1ZSB3YXMgbm90IHNldCB3aGVuIGFzc2lnbmluZyBzdG9yYWdlIHRleHR1cmUgc2xvdCBbJHtzdG9yYWdlVGV4dHVyZUZvcm1hdC5uYW1lfV0gdG8gYSBiaW5kIGdyb3VwLCB3aGlsZSByZW5kZXJpbmcgWyR7RGVidWdHcmFwaGljcy50b1N0cmluZygpfV1gLCB0aGlzKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RvcmFnZVRleHR1cmUoc3RvcmFnZVRleHR1cmVGb3JtYXQubmFtZSwgdmFsdWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gdXBkYXRlIHVuaWZvcm0gYnVmZmVyIG9mZnNldHNcbiAgICAgICAgdGhpcy51bmlmb3JtQnVmZmVyT2Zmc2V0cy5sZW5ndGggPSB0aGlzLnVuaWZvcm1CdWZmZXJzLmxlbmd0aDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnVuaWZvcm1CdWZmZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCB1bmlmb3JtQnVmZmVyID0gdGhpcy51bmlmb3JtQnVmZmVyc1tpXTtcblxuICAgICAgICAgICAgLy8gb2Zmc2V0XG4gICAgICAgICAgICB0aGlzLnVuaWZvcm1CdWZmZXJPZmZzZXRzW2ldID0gdW5pZm9ybUJ1ZmZlci5vZmZzZXQ7XG5cbiAgICAgICAgICAgIC8vIHRlc3QgaWYgYW55IG9mIHRoZSB1bmlmb3JtIGJ1ZmZlcnMgaGF2ZSBjaGFuZ2VkIChub3QgdGhlaXIgY29udGVudCwgYnV0IHRoZSBidWZmZXIgY29udGFpbmVyIGl0c2VsZilcbiAgICAgICAgICAgIGlmICh0aGlzLnJlbmRlclZlcnNpb25VcGRhdGVkIDwgdW5pZm9ybUJ1ZmZlci5yZW5kZXJWZXJzaW9uRGlydHkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmRpcnR5KSB7XG4gICAgICAgICAgICB0aGlzLmRpcnR5ID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLnJlbmRlclZlcnNpb25VcGRhdGVkID0gdGhpcy5kZXZpY2UucmVuZGVyVmVyc2lvbjtcbiAgICAgICAgICAgIHRoaXMuaW1wbC51cGRhdGUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCB7IEJpbmRHcm91cCB9O1xuIl0sIm5hbWVzIjpbImlkIiwiQmluZEdyb3VwIiwiY29uc3RydWN0b3IiLCJncmFwaGljc0RldmljZSIsImZvcm1hdCIsImRlZmF1bHRVbmlmb3JtQnVmZmVyIiwicmVuZGVyVmVyc2lvblVwZGF0ZWQiLCJ1bmlmb3JtQnVmZmVycyIsInVuaWZvcm1CdWZmZXJPZmZzZXRzIiwiZGV2aWNlIiwiZGlydHkiLCJpbXBsIiwiY3JlYXRlQmluZEdyb3VwSW1wbCIsInRleHR1cmVzIiwic3RvcmFnZVRleHR1cmVzIiwic2V0VW5pZm9ybUJ1ZmZlciIsIlVOSUZPUk1fQlVGRkVSX0RFRkFVTFRfU0xPVF9OQU1FIiwiRGVidWciLCJ0cmFjZSIsIlRSQUNFSURfQklOREdST1VQX0FMTE9DIiwiZGVzdHJveSIsIm5hbWUiLCJ1bmlmb3JtQnVmZmVyIiwiaW5kZXgiLCJidWZmZXJGb3JtYXRzTWFwIiwiZ2V0IiwiYXNzZXJ0IiwidW5kZWZpbmVkIiwiRGVidWdHcmFwaGljcyIsInRvU3RyaW5nIiwic2V0VGV4dHVyZSIsInRleHR1cmUiLCJ0ZXh0dXJlRm9ybWF0c01hcCIsInJlbmRlclZlcnNpb25EaXJ0eSIsInNldFN0b3JhZ2VUZXh0dXJlIiwic3RvcmFnZVRleHR1cmVGb3JtYXRzTWFwIiwidXBkYXRlIiwidGV4dHVyZUZvcm1hdHMiLCJzdG9yYWdlVGV4dHVyZUZvcm1hdHMiLCJpIiwibGVuZ3RoIiwidGV4dHVyZUZvcm1hdCIsInZhbHVlIiwic2NvcGVJZCIsInN0b3JhZ2VUZXh0dXJlRm9ybWF0Iiwib2Zmc2V0IiwicmVuZGVyVmVyc2lvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFLQSxJQUFJQSxFQUFFLEdBQUcsQ0FBQyxDQUFBOztBQUVWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1DLFNBQVMsQ0FBQztBQW9CWjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxXQUFXQSxDQUFDQyxjQUFjLEVBQUVDLE1BQU0sRUFBRUMsb0JBQW9CLEVBQUU7QUE3QjFEO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtJQUxJLElBTUFDLENBQUFBLG9CQUFvQixHQUFHLENBQUMsQ0FBQyxDQUFBO0FBRXpCO0FBQUEsSUFBQSxJQUFBLENBQ0FDLGNBQWMsR0FBQSxLQUFBLENBQUEsQ0FBQTtBQUVkO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtJQUxJLElBTUFDLENBQUFBLG9CQUFvQixHQUFHLEVBQUUsQ0FBQTtBQWFyQixJQUFBLElBQUksQ0FBQ1IsRUFBRSxHQUFHQSxFQUFFLEVBQUUsQ0FBQTtJQUNkLElBQUksQ0FBQ1MsTUFBTSxHQUFHTixjQUFjLENBQUE7SUFDNUIsSUFBSSxDQUFD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
