import { Debug } from '../core/debug.js';
import { math } from '../core/math/math.js';
import { Mat4 } from '../core/math/mat4.js';
import { PIXELFORMAT_RGBA32F, FILTER_NEAREST, TEXTURELOCK_READ } from '../platform/graphics/constants.js';
import { Texture } from '../platform/graphics/texture.js';

const _invMatrix = new Mat4();

/**
 * A skin instance is responsible for generating the matrix palette that is used to skin vertices
 * from object space to world space.
 *
 * @category Graphics
 */
class SkinInstance {
  /**
   * Create a new SkinInstance instance.
   *
   * @param {import('./skin.js').Skin} skin - The skin that will provide the inverse bind pose
   * matrices to generate the final matrix palette.
   */
  constructor(skin) {
    /**
     * An array of nodes representing each bone in this skin instance.
     *
     * @type {import('./graph-node.js').GraphNode[]}
     */
    this.bones = void 0;
    this.boneTextureSize = void 0;
    this._dirty = true;

    // optional root bone - used for cache lookup, not used for skinning
    this._rootBone = null;

    // sequential index of when the bone update was performed the last time
    this._skinUpdateIndex = -1;

    // true if bones need to be updated before the frustum culling (bones are needed to update bounds of the MeshInstance)
    this._updateBeforeCull = true;
    if (skin) {
      this.initSkin(skin);
    }
  }
  set rootBone(rootBone) {
    this._rootBone = rootBone;
  }
  get rootBone() {
    return this._rootBone;
  }
  init(device, numBones) {
    if (device.supportsBoneTextures) {
      // texture size - roughly square that fits all bones, width is multiply of 3 to simplify shader math
      const numPixels = numBones * 3;
      let width = Math.ceil(Math.sqrt(numPixels));
      width = math.roundUp(width, 3);
      const height = Math.ceil(numPixels / width);
      this.boneTexture = new Texture(device, {
        width: width,
        height: height,
        format: PIXELFORMAT_RGBA32F,
        mipmaps: false,
        minFilter: FILTER_NEAREST,
        magFilter: FILTER_NEAREST,
        name: 'skin'
      });
      this.boneTextureSize = [width, height, 1.0 / width, 1.0 / height];
      this.matrixPalette = this.boneTexture.lock({
        mode: TEXTURELOCK_READ
      });
      this.boneTexture.unlock();
    } else {
      this.matrixPalette = new Float32Array(numBones * 12);
    }
  }
  destroy() {
    if (this.boneTexture) {
      this.boneTexture.destroy();
      this.boneTexture = null;
    }
  }

  // resolved skin bones to a hierarchy with the rootBone at its root.
  // entity parameter specifies the entity used if the bone match is not found in the hierarchy - usually the entity the render component is attached to
  resolve(rootBone, entity) {
    this.rootBone = rootBone;

    // Resolve bone IDs to actual graph nodes of the hierarchy
    const skin = this.skin;
    const bones = [];
    for (let j = 0; j < skin.boneNames.length; j++) {
      const boneName = skin.boneNames[j];
      let bone = rootBone.findByName(boneName);
      if (!bone) {
        Debug.error(`Failed to find bone [${boneName}] in the entity hierarchy, RenderComponent on ${entity.name}, rootBone: ${rootBone.name}`);
        bone = entity;
      }
      bones.push(bone);
    }
    this.bones = bones;
  }
  initSkin(skin) {
    this.skin = skin;

    // Unique per clone
    this.bones = [];
    const numBones = skin.inverseBindPose.length;
    this.init(skin.device, numBones);
    this.matrices = [];
    for (let i = 0; i < numBones; i++) {
      this.matrices[i] = new Mat4();
    }
  }
  uploadBones(device) {
    // TODO: this is a bit strange looking. Change the Texture API to do a reupload
    if (device.supportsBoneTextures) {
      this.boneTexture.lock();
      this.boneTexture.unlock();
    }
  }
  _updateMatrices(rootNode, skinUpdateIndex) {
    // if not already up to date
    if (this._skinUpdateIndex !== skinUpdateIndex) {
      this._skinUpdateIndex = skinUpdateIndex;
      _invMatrix.copy(rootNode.getWorldTransform()).invert();
      for (let i = this.bones.length - 1; i >= 0; i--) {
        this.matrices[i].mulAffine2(_invMatrix, this.bones[i].getWorldTransform()); // world space -> rootNode space
        this.matrices[i].mulAffine2(this.matrices[i], this.skin.inverseBindPose[i]); // rootNode space -> bind space
      }
    }
  }

  updateMatrices(rootNode, skinUpdateIndex) {
    if (this._updateBeforeCull) {
      this._updateMatrices(rootNode, skinUpdateIndex);
    }
  }
  updateMatrixPalette(rootNode, skinUpdateIndex) {
    // make sure matrices are up to date
    this._updateMatrices(rootNode, skinUpdateIndex);

    // copy matrices to palette
    const mp = this.matrixPalette;
    const count = this.bones.length;
    for (let i = 0; i < count; i++) {
      const pe = this.matrices[i].data;

      // Copy the matrix into the palette, ready to be sent to the vertex shader, transpose matrix from 4x4 to 4x3 format as well
      const base = i * 12;
      mp[base] = pe[0];
      mp[base + 1] = pe[4];
      mp[base + 2] = pe[8];
      mp[base + 3] = pe[12];
      mp[base + 4] = pe[1];
      mp[base + 5] = pe[5];
      mp[base + 6] = pe[9];
      mp[base + 7] = pe[13];
      mp[base + 8] = pe[2];
      mp[base + 9] = pe[6];
      mp[base + 10] = pe[10];
      mp[base + 11] = pe[14];
    }
    this.uploadBones(this.skin.device);
  }
}

export { SkinInstance };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2tpbi1pbnN0YW5jZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3NjZW5lL3NraW4taW5zdGFuY2UuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVidWcgfSBmcm9tICcuLi9jb3JlL2RlYnVnLmpzJztcbmltcG9ydCB7IG1hdGggfSBmcm9tICcuLi9jb3JlL21hdGgvbWF0aC5qcyc7XG5pbXBvcnQgeyBNYXQ0IH0gZnJvbSAnLi4vY29yZS9tYXRoL21hdDQuanMnO1xuXG5pbXBvcnQgeyBGSUxURVJfTkVBUkVTVCwgUElYRUxGT1JNQVRfUkdCQTMyRiwgVEVYVFVSRUxPQ0tfUkVBRCB9IGZyb20gJy4uL3BsYXRmb3JtL2dyYXBoaWNzL2NvbnN0YW50cy5qcyc7XG5pbXBvcnQgeyBUZXh0dXJlIH0gZnJvbSAnLi4vcGxhdGZvcm0vZ3JhcGhpY3MvdGV4dHVyZS5qcyc7XG5cbmNvbnN0IF9pbnZNYXRyaXggPSBuZXcgTWF0NCgpO1xuXG4vKipcbiAqIEEgc2tpbiBpbnN0YW5jZSBpcyByZXNwb25zaWJsZSBmb3IgZ2VuZXJhdGluZyB0aGUgbWF0cml4IHBhbGV0dGUgdGhhdCBpcyB1c2VkIHRvIHNraW4gdmVydGljZXNcbiAqIGZyb20gb2JqZWN0IHNwYWNlIHRvIHdvcmxkIHNwYWNlLlxuICpcbiAqIEBjYXRlZ29yeSBHcmFwaGljc1xuICovXG5jbGFzcyBTa2luSW5zdGFuY2Uge1xuICAgIC8qKlxuICAgICAqIEFuIGFycmF5IG9mIG5vZGVzIHJlcHJlc2VudGluZyBlYWNoIGJvbmUgaW4gdGhpcyBza2luIGluc3RhbmNlLlxuICAgICAqXG4gICAgICogQHR5cGUge2ltcG9ydCgnLi9ncmFwaC1ub2RlLmpzJykuR3JhcGhOb2RlW119XG4gICAgICovXG4gICAgYm9uZXM7XG5cbiAgICBib25lVGV4dHVyZVNpemU7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgU2tpbkluc3RhbmNlIGluc3RhbmNlLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vc2tpbi5qcycpLlNraW59IHNraW4gLSBUaGUgc2tpbiB0aGF0IHdpbGwgcHJvdmlkZSB0aGUgaW52ZXJzZSBiaW5kIHBvc2VcbiAgICAgKiBtYXRyaWNlcyB0byBnZW5lcmF0ZSB0aGUgZmluYWwgbWF0cml4IHBhbGV0dGUuXG4gICAgICovXG4gICAgY29uc3RydWN0b3Ioc2tpbikge1xuICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7XG5cbiAgICAgICAgLy8gb3B0aW9uYWwgcm9vdCBib25lIC0gdXNlZCBmb3IgY2FjaGUgbG9va3VwLCBub3QgdXNlZCBmb3Igc2tpbm5pbmdcbiAgICAgICAgdGhpcy5fcm9vdEJvbmUgPSBudWxsO1xuXG4gICAgICAgIC8vIHNlcXVlbnRpYWwgaW5kZXggb2Ygd2hlbiB0aGUgYm9uZSB1cGRhdGUgd2FzIHBlcmZvcm1lZCB0aGUgbGFzdCB0aW1lXG4gICAgICAgIHRoaXMuX3NraW5VcGRhdGVJbmRleCA9IC0xO1xuXG4gICAgICAgIC8vIHRydWUgaWYgYm9uZXMgbmVlZCB0byBiZSB1cGRhdGVkIGJlZm9yZSB0aGUgZnJ1c3R1bSBjdWxsaW5nIChib25lcyBhcmUgbmVlZGVkIHRvIHVwZGF0ZSBib3VuZHMgb2YgdGhlIE1lc2hJbnN0YW5jZSlcbiAgICAgICAgdGhpcy5fdXBkYXRlQmVmb3JlQ3VsbCA9IHRydWU7XG5cbiAgICAgICAgaWYgKHNraW4pIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdFNraW4oc2tpbik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXQgcm9vdEJvbmUocm9vdEJvbmUpIHtcbiAgICAgICAgdGhpcy5fcm9vdEJvbmUgPSByb290Qm9uZTtcbiAgICB9XG5cbiAgICBnZXQgcm9vdEJvbmUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yb290Qm9uZTtcbiAgICB9XG5cbiAgICBpbml0KGRldmljZSwgbnVtQm9uZXMpIHtcblxuICAgICAgICBpZiAoZGV2aWNlLnN1cHBvcnRzQm9uZVRleHR1cmVzKSB7XG5cbiAgICAgICAgICAgIC8vIHRleHR1cmUgc2l6ZSAtIHJvdWdobHkgc3F1YXJlIHRoYXQgZml0cyBhbGwgYm9uZXMsIHdpZHRoIGlzIG11bHRpcGx5IG9mIDMgdG8gc2ltcGxpZnkgc2hhZGVyIG1hdGhcbiAgICAgICAgICAgIGNvbnN0IG51bVBpeGVscyA9IG51bUJvbmVzICogMztcbiAgICAgICAgICAgIGxldCB3aWR0aCA9IE1hdGguY2VpbChNYXRoLnNxcnQobnVtUGl4ZWxzKSk7XG4gICAgICAgICAgICB3aWR0aCA9IG1hdGgucm91bmRVcCh3aWR0aCwgMyk7XG4gICAgICAgICAgICBjb25zdCBoZWlnaHQgPSBNYXRoLmNlaWwobnVtUGl4ZWxzIC8gd2lkdGgpO1xuXG4gICAgICAgICAgICB0aGlzLmJvbmVUZXh0dXJlID0gbmV3IFRleHR1cmUoZGV2aWNlLCB7XG4gICAgICAgICAgICAgICAgd2lkdGg6IHdpZHRoLFxuICAgICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0LFxuICAgICAgICAgICAgICAgIGZvcm1hdDogUElYRUxGT1JNQVRfUkdCQTMyRixcbiAgICAgICAgICAgICAgICBtaXBtYXBzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBtaW5GaWx0ZXI6IEZJTFRFUl9ORUFSRVNULFxuICAgICAgICAgICAgICAgIG1hZ0ZpbHRlcjogRklMVEVSX05FQVJFU1QsXG4gICAgICAgICAgICAgICAgbmFtZTogJ3NraW4nXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5ib25lVGV4dHVyZVNpemUgPSBbd2lkdGgsIGhlaWdodCwgMS4wIC8gd2lkdGgsIDEuMCAvIGhlaWdodF07XG5cbiAgICAgICAgICAgIHRoaXMubWF0cml4UGFsZXR0ZSA9IHRoaXMuYm9uZVRleHR1cmUubG9jayh7IG1vZGU6IFRFWFRVUkVMT0NLX1JFQUQgfSk7XG4gICAgICAgICAgICB0aGlzLmJvbmVUZXh0dXJlLnVubG9jaygpO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm1hdHJpeFBhbGV0dGUgPSBuZXcgRmxvYXQzMkFycmF5KG51bUJvbmVzICogMTIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZGVzdHJveSgpIHtcblxuICAgICAgICBpZiAodGhpcy5ib25lVGV4dHVyZSkge1xuICAgICAgICAgICAgdGhpcy5ib25lVGV4dHVyZS5kZXN0cm95KCk7XG4gICAgICAgICAgICB0aGlzLmJvbmVUZXh0dXJlID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIHJlc29sdmVkIHNraW4gYm9uZXMgdG8gYSBoaWVyYXJjaHkgd2l0aCB0aGUgcm9vdEJvbmUgYXQgaXRzIHJvb3QuXG4gICAgLy8gZW50aXR5IHBhcmFtZXRlciBzcGVjaWZpZXMgdGhlIGVudGl0eSB1c2VkIGlmIHRoZSBib25lIG1hdGNoIGlzIG5vdCBmb3VuZCBpbiB0aGUgaGllcmFyY2h5IC0gdXN1YWxseSB0aGUgZW50aXR5IHRoZSByZW5kZXIgY29tcG9uZW50IGlzIGF0dGFjaGVkIHRvXG4gICAgcmVzb2x2ZShyb290Qm9uZSwgZW50aXR5KSB7XG5cbiAgICAgICAgdGhpcy5yb290Qm9uZSA9IHJvb3RCb25lO1xuXG4gICAgICAgIC8vIFJlc29sdmUgYm9uZSBJRHMgdG8gYWN0dWFsIGdyYXBoIG5vZGVzIG9mIHRoZSBoaWVyYXJjaHlcbiAgICAgICAgY29uc3Qgc2tpbiA9IHRoaXMuc2tpbjtcbiAgICAgICAgY29uc3QgYm9uZXMgPSBbXTtcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBza2luLmJvbmVOYW1lcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgY29uc3QgYm9uZU5hbWUgPSBza2luLmJvbmVOYW1lc1tqXTtcbiAgICAgICAgICAgIGxldCBib25lID0gcm9vdEJvbmUuZmluZEJ5TmFtZShib25lTmFtZSk7XG5cbiAgICAgICAgICAgIGlmICghYm9uZSkge1xuICAgICAgICAgICAgICAgIERlYnVnLmVycm9yKGBGYWlsZWQgdG8gZmluZCBib25lIFske2JvbmVOYW1lfV0gaW4gdGhlIGVudGl0eSBoaWVyYXJjaHksIFJlbmRlckNvbXBvbmVudCBvbiAke2VudGl0eS5uYW1lfSwgcm9vdEJvbmU6ICR7cm9vdEJvbmUubmFtZX1gKTtcbiAgICAgICAgICAgICAgICBib25lID0gZW50aXR5O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBib25lcy5wdXNoKGJvbmUpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuYm9uZXMgPSBib25lcztcbiAgICB9XG5cbiAgICBpbml0U2tpbihza2luKSB7XG5cbiAgICAgICAgdGhpcy5za2luID0gc2tpbjtcblxuICAgICAgICAvLyBVbmlxdWUgcGVyIGNsb25lXG4gICAgICAgIHRoaXMuYm9uZXMgPSBbXTtcblxuICAgICAgICBjb25zdCBudW1Cb25lcyA9IHNraW4uaW52ZXJzZUJpbmRQb3NlLmxlbmd0aDtcbiAgICAgICAgdGhpcy5pbml0KHNraW4uZGV2aWNlLCBudW1Cb25lcyk7XG5cbiAgICAgICAgdGhpcy5tYXRyaWNlcyA9IFtdO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUJvbmVzOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMubWF0cmljZXNbaV0gPSBuZXcgTWF0NCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdXBsb2FkQm9uZXMoZGV2aWNlKSB7XG5cbiAgICAgICAgLy8gVE9ETzogdGhpcyBpcyBhIGJpdCBzdHJhbmdlIGxvb2tpbmcuIENoYW5nZSB0aGUgVGV4dHVyZSBBUEkgdG8gZG8gYSByZXVwbG9hZFxuICAgICAgICBpZiAoZGV2aWNlLnN1cHBvcnRzQm9uZVRleHR1cmVzKSB7XG4gICAgICAgICAgICB0aGlzLmJvbmVUZXh0dXJlLmxvY2soKTtcbiAgICAgICAgICAgIHRoaXMuYm9uZVRleHR1cmUudW5sb2NrKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfdXBkYXRlTWF0cmljZXMocm9vdE5vZGUsIHNraW5VcGRhdGVJbmRleCkge1xuXG4gICAgICAgIC8vIGlmIG5vdCBhbHJlYWR5IHVwIHRvIGRhdGVcbiAgICAgICAgaWYgKHRoaXMuX3NraW5VcGRhdGVJbmRleCAhPT0gc2tpblVwZGF0ZUluZGV4KSB7XG4gICAgICAgICAgICB0aGlzLl9za2luVXBkYXRlSW5kZXggPSBza2luVXBkYXRlSW5kZXg7XG5cbiAgICAgICAgICAgIF9pbnZNYXRyaXguY29weShyb290Tm9kZS5nZXRXb3JsZFRyYW5zZm9ybSgpKS5pbnZlcnQoKTtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmJvbmVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXRyaWNlc1tpXS5tdWxBZmZpbmUyKF9pbnZNYXRyaXgsIHRoaXMuYm9uZXNbaV0uZ2V0V29ybGRUcmFuc2Zvcm0oKSk7IC8vIHdvcmxkIHNwYWNlIC0+IHJvb3ROb2RlIHNwYWNlXG4gICAgICAgICAgICAgICAgdGhpcy5tYXRyaWNlc1tpXS5tdWxBZmZpbmUyKHRoaXMubWF0cmljZXNbaV0sIHRoaXMuc2tpbi5pbnZlcnNlQmluZFBvc2VbaV0pOyAvLyByb290Tm9kZSBzcGFjZSAtPiBiaW5kIHNwYWNlXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB1cGRhdGVNYXRyaWNlcyhyb290Tm9kZSwgc2tpblVwZGF0ZUluZGV4KSB7XG5cbiAgICAgICAgaWYgKHRoaXMuX3VwZGF0ZUJlZm9yZUN1bGwpIHtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZU1hdHJpY2VzKHJvb3ROb2RlLCBza2luVXBkYXRlSW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdXBkYXRlTWF0cml4UGFsZXR0ZShyb290Tm9kZSwgc2tpblVwZGF0ZUluZGV4KSB7XG5cbiAgICAgICAgLy8gbWFrZSBzdXJlIG1hdHJpY2VzIGFyZSB1cCB0byBkYXRlXG4gICAgICAgIHRoaXMuX3VwZGF0ZU1hdHJpY2VzKHJvb3ROb2RlLCBza2luVXBkYXRlSW5kZXgpO1xuXG4gICAgICAgIC8vIGNvcHkgbWF0cmljZXMgdG8gcGFsZXR0ZVxuICAgICAgICBjb25zdCBtcCA9IHRoaXMubWF0cml4UGFsZXR0ZTtcbiAgICAgICAgY29uc3QgY291bnQgPSB0aGlzLmJvbmVzLmxlbmd0aDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBwZSA9IHRoaXMubWF0cmljZXNbaV0uZGF0YTtcblxuICAgICAgICAgICAgLy8gQ29weSB0aGUgbWF0cml4IGludG8gdGhlIHBhbGV0dGUsIHJlYWR5IHRvIGJlIHNlbnQgdG8gdGhlIHZlcnRleCBzaGFkZXIsIHRyYW5zcG9zZSBtYXRyaXggZnJvbSA0eDQgdG8gNHgzIGZvcm1hdCBhcyB3ZWxsXG4gICAgICAgICAgICBjb25zdCBiYXNlID0gaSAqIDEyO1xuICAgICAgICAgICAgbXBbYmFzZV0gPSBwZVswXTtcbiAgICAgICAgICAgIG1wW2Jhc2UgKyAxXSA9IHBlWzRdO1xuICAgICAgICAgICAgbXBbYmFzZSArIDJdID0gcGVbOF07XG4gICAgICAgICAgICBtcFtiYXNlICsgM10gPSBwZVsxMl07XG4gICAgICAgICAgICBtcFtiYXNlICsgNF0gPSBwZVsxXTtcbiAgICAgICAgICAgIG1wW2Jhc2UgKyA1XSA9IHBlWzVdO1xuICAgICAgICAgICAgbXBbYmFzZSArIDZdID0gcGVbOV07XG4gICAgICAgICAgICBtcFtiYXNlICsgN10gPSBwZVsxM107XG4gICAgICAgICAgICBtcFtiYXNlICsgOF0gPSBwZVsyXTtcbiAgICAgICAgICAgIG1wW2Jhc2UgKyA5XSA9IHBlWzZdO1xuICAgICAgICAgICAgbXBbYmFzZSArIDEwXSA9IHBlWzEwXTtcbiAgICAgICAgICAgIG1wW2Jhc2UgKyAxMV0gPSBwZVsxNF07XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnVwbG9hZEJvbmVzKHRoaXMuc2tpbi5kZXZpY2UpO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgU2tpbkluc3RhbmNlIH07XG4iXSwibmFtZXMiOlsiX2ludk1hdHJpeCIsIk1hdDQiLCJTa2luSW5zdGFuY2UiLCJjb25zdHJ1Y3RvciIsInNraW4iLCJib25lcyIsImJvbmVUZXh0dXJlU2l6ZSIsIl9kaXJ0eSIsIl9yb290Qm9uZSIsIl9za2luVXBkYXRlSW5kZXgiLCJfdXBkYXRlQmVmb3JlQ3VsbCIsImluaXRTa2luIiwicm9vdEJvbmUiLCJpbml0IiwiZGV2aWNlIiwibnVtQm9uZXMiLCJzdXBwb3J0c0JvbmVUZXh0dXJlcyIsIm51bVBpeGVscyIsIndpZHRoIiwiTWF0aCIsImNlaWwiLCJzcXJ0IiwibWF0aCIsInJvdW5kVXAiLCJoZWlnaHQiLCJib25lVGV4dHVyZSIsIlRleHR1cmUiLCJmb3JtYXQiLCJQSVhFTEZPUk1BVF9SR0JBMzJGIiwibWlwbWFwcyIsIm1pbkZpbHRlciIsIkZJTFRFUl9ORUFSRVNUIiwibWFnRmlsdGVyIiwibmFtZSIsIm1hdHJpeFBhbGV0dGUiLCJsb2NrIiwibW9kZSIsIlRFWFRVUkVMT0NLX1JFQUQiLCJ1bmxvY2siLCJGbG9hdDMyQXJyYXkiLCJkZXN0cm95IiwicmVzb2x2ZSIsImVudGl0eSIsImoiLCJib25lTmFtZXMiLCJsZW5ndGgiLCJib25lTmFtZSIsImJvbmUiLCJmaW5kQnlOYW1lIiwiRGVidWciLCJlcnJvciIsInB1c2giLCJpbnZlcnNlQmluZFBvc2UiLCJtYXRyaWNlcyIsImkiLCJ1cGxvYWRCb25lcyIsIl91cGRhdGVNYXRyaWNlcyIsInJvb3ROb2RlIiwic2tpblVwZGF0ZUluZGV4IiwiY29weSIsImdldFdvcmxkVHJhbnNmb3JtIiwiaW52ZXJ0IiwibXVsQWZmaW5lMiIsInVwZGF0ZU1hdHJpY2VzIiwidXBkYXRlTWF0cml4UGFsZXR0ZSIsIm1wIiwiY291bnQiLCJwZSIsImRhdGEiLCJiYXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFPQSxNQUFNQSxVQUFVLEdBQUcsSUFBSUMsSUFBSSxFQUFFLENBQUE7O0FBRTdCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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QUdGLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtNQUNwQkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtNQUNwQkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQTtNQUNyQkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtNQUNwQkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtNQUNwQkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtNQUNwQkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQTtNQUNyQkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtNQUNwQkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtNQUNwQkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsRUFBRSxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQTtNQUN0QkYsRUFBRSxDQUFDSSxJQUFJLEdBQUcsRUFBRSxDQUFDLEdBQUdGLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQTtBQUMxQixLQUFBO0lBRUEsSUFBSSxDQUFDWixXQUFXLENBQUMsSUFBSSxDQUFDbkQsSUFBSSxDQUFDVSxNQUFNLENBQUMsQ0FBQTtBQUN0QyxHQUFBO0FBQ0o7Ozs7In0=
