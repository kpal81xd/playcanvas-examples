import { Debug } from '../../core/debug.js';
import { SKYTYPE_DOME, SKYTYPE_BOX, SKYTYPE_INFINITE } from '../constants.js';
import { createBox, createMesh } from '../procedural.js';

class SkyGeometry {
  static create(device, type) {
    switch (type) {
      case SKYTYPE_BOX:
        return SkyGeometry.box(device);
      case SKYTYPE_DOME:
        return SkyGeometry.dome(device);
    }
    Debug.assert(type === SKYTYPE_INFINITE, `Unsupported sky geometry type ${type}`);
    return SkyGeometry.infinite(device);
  }
  static infinite(device) {
    return createBox(device);
  }
  static box(device) {
    return createBox(device, {
      yOffset: 0.5
    });
  }
  static dome(device) {
    // flatten bottom y-coordinate
    const bottomLimit = 0.1;

    // normalized distance from the center that is completely flat
    const curvatureRadius = 0.95;

    // derived values
    const curvatureRadiusSq = curvatureRadius * curvatureRadius;
    const radius = 0.5;
    const latitudeBands = 50;
    const longitudeBands = 50;
    const positions = [];
    const indices = [];
    for (let lat = 0; lat <= latitudeBands; lat++) {
      const theta = lat * Math.PI / latitudeBands;
      const sinTheta = Math.sin(theta);
      const cosTheta = Math.cos(theta);
      for (let lon = 0; lon <= longitudeBands; lon++) {
        // Sweep the sphere from the positive Z axis to match a 3DS Max sphere
        const phi = lon * 2 * Math.PI / longitudeBands - Math.PI / 2;
        const sinPhi = Math.sin(phi);
        const cosPhi = Math.cos(phi);
        const x = cosPhi * sinTheta;
        let y = cosTheta;
        const z = sinPhi * sinTheta;

        // flatten the lower hemisphere
        if (y < 0) {
          // scale vertices on the bottom
          y *= 0.3;

          // flatten the center
          if (x * x + z * z < curvatureRadiusSq) {
            y = -bottomLimit;
          }
        }

        // adjust y to have the center at the flat bottom
        y += bottomLimit;
        positions.push(x * radius, y * radius, z * radius);
      }
    }
    for (let lat = 0; lat < latitudeBands; ++lat) {
      for (let lon = 0; lon < longitudeBands; ++lon) {
        const first = lat * (longitudeBands + 1) + lon;
        const second = first + longitudeBands + 1;
        indices.push(first + 1, second, first);
        indices.push(first + 1, second + 1, second);
      }
    }
    return createMesh(device, positions, {
      indices: indices
    });
  }
}

export { SkyGeometry };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2t5LWdlb21ldHJ5LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvc2NlbmUvc2t5Ym94L3NreS1nZW9tZXRyeS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEZWJ1ZyB9IGZyb20gXCIuLi8uLi9jb3JlL2RlYnVnLmpzXCI7XG5pbXBvcnQgeyBTS1lUWVBFX0JPWCwgU0tZVFlQRV9ET01FLCBTS1lUWVBFX0lORklOSVRFIH0gZnJvbSBcIi4uL2NvbnN0YW50cy5qc1wiO1xuaW1wb3J0IHsgY3JlYXRlQm94LCBjcmVhdGVNZXNoIH0gZnJvbSBcIi4uL3Byb2NlZHVyYWwuanNcIjtcblxuY2xhc3MgU2t5R2VvbWV0cnkge1xuICAgIHN0YXRpYyBjcmVhdGUoZGV2aWNlLCB0eXBlKSB7XG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgY2FzZSBTS1lUWVBFX0JPWDogcmV0dXJuIFNreUdlb21ldHJ5LmJveChkZXZpY2UpO1xuICAgICAgICAgICAgY2FzZSBTS1lUWVBFX0RPTUU6IHJldHVybiBTa3lHZW9tZXRyeS5kb21lKGRldmljZSk7XG4gICAgICAgIH1cbiAgICAgICAgRGVidWcuYXNzZXJ0KHR5cGUgPT09IFNLWVRZUEVfSU5GSU5JVEUsIGBVbnN1cHBvcnRlZCBza3kgZ2VvbWV0cnkgdHlwZSAke3R5cGV9YCk7XG4gICAgICAgIHJldHVybiBTa3lHZW9tZXRyeS5pbmZpbml0ZShkZXZpY2UpO1xuICAgIH1cblxuICAgIHN0YXRpYyBpbmZpbml0ZShkZXZpY2UpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUJveChkZXZpY2UpO1xuICAgIH1cblxuICAgIHN0YXRpYyBib3goZGV2aWNlKSB7XG4gICAgICAgIHJldHVybiBjcmVhdGVCb3goZGV2aWNlLCB7XG4gICAgICAgICAgICB5T2Zmc2V0OiAwLjVcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGRvbWUoZGV2aWNlKSB7XG4gICAgICAgIC8vIGZsYXR0ZW4gYm90dG9tIHktY29vcmRpbmF0ZVxuICAgICAgICBjb25zdCBib3R0b21MaW1pdCA9IDAuMTtcblxuICAgICAgICAvLyBub3JtYWxpemVkIGRpc3RhbmNlIGZyb20gdGhlIGNlbnRlciB0aGF0IGlzIGNvbXBsZXRlbHkgZmxhdFxuICAgICAgICBjb25zdCBjdXJ2YXR1cmVSYWRpdXMgPSAwLjk1O1xuXG4gICAgICAgIC8vIGRlcml2ZWQgdmFsdWVzXG4gICAgICAgIGNvbnN0IGN1cnZhdHVyZVJhZGl1c1NxID0gY3VydmF0dXJlUmFkaXVzICogY3VydmF0dXJlUmFkaXVzO1xuXG4gICAgICAgIGNvbnN0IHJhZGl1cyA9IDAuNTtcbiAgICAgICAgY29uc3QgbGF0aXR1ZGVCYW5kcyA9IDUwO1xuICAgICAgICBjb25zdCBsb25naXR1ZGVCYW5kcyA9IDUwO1xuICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTtcbiAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IGxhdCA9IDA7IGxhdCA8PSBsYXRpdHVkZUJhbmRzOyBsYXQrKykge1xuICAgICAgICAgICAgY29uc3QgdGhldGEgPSBsYXQgKiBNYXRoLlBJIC8gbGF0aXR1ZGVCYW5kcztcbiAgICAgICAgICAgIGNvbnN0IHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpO1xuICAgICAgICAgICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcyh0aGV0YSk7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGxvbiA9IDA7IGxvbiA8PSBsb25naXR1ZGVCYW5kczsgbG9uKyspIHtcbiAgICAgICAgICAgICAgICAvLyBTd2VlcCB0aGUgc3BoZXJlIGZyb20gdGhlIHBvc2l0aXZlIFogYXhpcyB0byBtYXRjaCBhIDNEUyBNYXggc3BoZXJlXG4gICAgICAgICAgICAgICAgY29uc3QgcGhpID0gbG9uICogMiAqIE1hdGguUEkgLyBsb25naXR1ZGVCYW5kcyAtIE1hdGguUEkgLyAyO1xuICAgICAgICAgICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguc2luKHBoaSk7XG4gICAgICAgICAgICAgICAgY29uc3QgY29zUGhpID0gTWF0aC5jb3MocGhpKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjb3NQaGkgKiBzaW5UaGV0YTtcbiAgICAgICAgICAgICAgICBsZXQgeSA9IGNvc1RoZXRhO1xuICAgICAgICAgICAgICAgIGNvbnN0IHogPSBzaW5QaGkgKiBzaW5UaGV0YTtcblxuICAgICAgICAgICAgICAgIC8vIGZsYXR0ZW4gdGhlIGxvd2VyIGhlbWlzcGhlcmVcbiAgICAgICAgICAgICAgICBpZiAoeSA8IDApIHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBzY2FsZSB2ZXJ0aWNlcyBvbiB0aGUgYm90dG9tXG4gICAgICAgICAgICAgICAgICAgIHkgKj0gMC4zO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGZsYXR0ZW4gdGhlIGNlbnRlclxuICAgICAgICAgICAgICAgICAgICBpZiAoeCAqIHggKyB6ICogeiA8IGN1cnZhdHVyZVJhZGl1c1NxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB5ID0gLWJvdHRvbUxpbWl0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gYWRqdXN0IHkgdG8gaGF2ZSB0aGUgY2VudGVyIGF0IHRoZSBmbGF0IGJvdHRvbVxuICAgICAgICAgICAgICAgIHkgKz0gYm90dG9tTGltaXQ7XG5cbiAgICAgICAgICAgICAgICBwb3NpdGlvbnMucHVzaCh4ICogcmFkaXVzLCB5ICogcmFkaXVzLCB6ICogcmFkaXVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAobGV0IGxhdCA9IDA7IGxhdCA8IGxhdGl0dWRlQmFuZHM7ICsrbGF0KSB7XG4gICAgICAgICAgICBmb3IgKGxldCBsb24gPSAwOyBsb24gPCBsb25naXR1ZGVCYW5kczsgKytsb24pIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCAgPSAobGF0ICogKGxvbmdpdHVkZUJhbmRzICsgMSkpICsgbG9uO1xuICAgICAgICAgICAgICAgIGNvbnN0IHNlY29uZCA9IGZpcnN0ICsgbG9uZ2l0dWRlQmFuZHMgKyAxO1xuXG4gICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGZpcnN0ICsgMSwgc2Vjb25kLCBmaXJzdCk7XG4gICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGZpcnN0ICsgMSwgc2Vjb25kICsgMSwgc2Vjb25kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjcmVhdGVNZXNoKGRldmljZSwgcG9zaXRpb25zLCB7XG4gICAgICAgICAgICBpbmRpY2VzOiBpbmRpY2VzXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgU2t5R2VvbWV0cnkgfTtcbiJdLCJuYW1lcyI6WyJTa3lHZW9tZXRyeSIsImNyZWF0ZSIsImRldmljZSIsInR5cGUiLCJTS1lUWVBFX0JPWCIsImJveCIsIlNLWVRZUEVfRE9NRSIsImRvbWUiLCJEZWJ1ZyIsImFzc2VydCIsIlNLWVRZUEVfSU5GSU5JVEUiLCJpbmZpbml0ZSIsImNyZWF0ZUJveCIsInlPZmZzZXQiLCJib3R0b21MaW1pdCIsImN1cnZhdHVyZVJhZGl1cyIsImN1cnZhdHVyZVJhZGl1c1NxIiwicmFkaXVzIiwibGF0aXR1ZGVCYW5kcyIsImxvbmdpdHVkZUJhbmRzIiwicG9zaXRpb25zIiwiaW5kaWNlcyIsImxhdCIsInRoZXRhIiwiTWF0aCIsIlBJIiwic2luVGhldGEiLCJzaW4iLCJjb3NUaGV0YSIsImNvcyIsImxvbiIsInBoaSIsInNpblBoaSIsImNvc1BoaSIsIngiLCJ5IiwieiIsInB1c2giLCJmaXJzdCIsInNlY29uZCIsImNyZWF0ZU1lc2giXSwibWFwcGluZ3MiOiI7Ozs7QUFJQSxNQUFNQSxXQUFXLENBQUM7QUFDZCxFQUFBLE9BQU9DLE1BQU1BLENBQUNDLE1BQU0sRUFBRUMsSUFBSSxFQUFFO0FB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
