import { Mat4 } from '../../core/math/mat4.js';
import { Vec3 } from '../../core/math/vec3.js';
import { BUFFER_DYNAMIC } from '../../platform/graphics/constants.js';
import { VertexBuffer } from '../../platform/graphics/vertex-buffer.js';
import { DITHER_NONE } from '../constants.js';
import { MeshInstance } from '../mesh-instance.js';
import { Mesh } from '../mesh.js';
import { createBox } from '../procedural.js';
import { createGSplatMaterial } from './gsplat-material.js';
import { GSplatSorter } from './gsplat-sorter.js';

const mat = new Mat4();
const cameraPosition = new Vec3();
const cameraDirection = new Vec3();
const viewport = [0, 0];

/** @ignore */
class GSplatInstance {
  /**
   * @param {import('./gsplat.js').GSplat} splat - The splat instance.
   * @param {import('./gsplat-material.js').SplatMaterialOptions} options - The options.
   */
  constructor(splat, options) {
    /** @type {import('./gsplat.js').GSplat} */
    this.splat = void 0;
    /** @type {Mesh} */
    this.mesh = void 0;
    /** @type {MeshInstance} */
    this.meshInstance = void 0;
    /** @type {import('../materials/material.js').Material} */
    this.material = void 0;
    /** @type {VertexBuffer} */
    this.vb = void 0;
    this.options = {};
    /** @type {GSplatSorter | null} */
    this.sorter = null;
    this.lastCameraPosition = new Vec3();
    this.lastCameraDirection = new Vec3();
    /**
     * List of cameras this instance is visible for. Updated every frame by the renderer.
     *
     * @type {import('../camera.js').Camera[]}
     * @ignore
     */
    this.cameras = [];
    this.splat = splat;

    // clone options object
    options = Object.assign(this.options, options);

    // material
    const debugRender = options.debugRender;
    this.createMaterial(options);

    // mesh
    const device = splat.device;
    if (debugRender) {
      this.mesh = createBox(device, {
        halfExtents: new Vec3(1.0, 1.0, 1.0)
      });
    } else {
      this.mesh = new Mesh(device);
      this.mesh.setPositions(new Float32Array([-1, -1, 1, -1, 1, 1, -1, -1, 1, 1, -1, 1]), 2);
      this.mesh.update();
    }
    this.mesh.aabb.copy(splat.aabb);

    // initialize index data
    const numSplats = splat.numSplats;
    let indexData;
    if (!device.isWebGL1) {
      indexData = new Uint32Array(numSplats);
      for (let i = 0; i < numSplats; ++i) {
        indexData[i] = i;
      }
    } else {
      indexData = new Float32Array(numSplats);
      for (let i = 0; i < numSplats; ++i) {
        indexData[i] = i + 0.2;
      }
    }
    const vb = new VertexBuffer(device, splat.vertexFormat, numSplats, BUFFER_DYNAMIC, indexData.buffer);
    this.vb = vb;
    this.meshInstance = new MeshInstance(this.mesh, this.material);
    this.meshInstance.setInstancing(vb, true);
    this.meshInstance.gsplatInstance = this;

    // clone centers to allow multiple instances of sorter
    this.centers = new Float32Array(splat.centers);

    // create sorter
    if (!options.dither || options.dither === DITHER_NONE) {
      this.sorter = new GSplatSorter();
      this.sorter.init(this.vb, this.centers, !this.splat.device.isWebGL1);
    }
  }
  destroy() {
    var _this$sorter;
    this.material.destroy();
    this.vb.destroy();
    this.meshInstance.destroy();
    (_this$sorter = this.sorter) == null || _this$sorter.destroy();
  }
  clone() {
    return new GSplatInstance(this.splat, this.options);
  }
  createMaterial(options) {
    this.material = createGSplatMaterial(options);
    this.splat.setupMaterial(this.material);
    if (this.meshInstance) {
      this.meshInstance.material = this.material;
    }
  }
  updateViewport() {
    // TODO: improve, needs to handle render targets of different sizes
    const device = this.splat.device;
    viewport[0] = device.width;
    viewport[1] = device.height;
    this.material.setParameter('viewport', viewport);
  }

  /**
   * Sorts the GS vertices based on the given camera.
   * @param {import('../graph-node.js').GraphNode} cameraNode - The camera node used for sorting.
   */
  sort(cameraNode) {
    if (this.sorter) {
      const cameraMat = cameraNode.getWorldTransform();
      cameraMat.getTranslation(cameraPosition);
      cameraMat.getZ(cameraDirection);
      const modelMat = this.meshInstance.node.getWorldTransform();
      const invModelMat = mat.invert(modelMat);
      invModelMat.transformPoint(cameraPosition, cameraPosition);
      invModelMat.transformVector(cameraDirection, cameraDirection);

      // sort if the camera has changed
      if (!cameraPosition.equalsApprox(this.lastCameraPosition) || !cameraDirection.equalsApprox(this.lastCameraDirection)) {
        this.lastCameraPosition.copy(cameraPosition);
        this.lastCameraDirection.copy(cameraDirection);
        this.sorter.setCamera(cameraPosition, cameraDirection);
      }
    }
    this.updateViewport();
  }
  update() {
    if (this.cameras.length > 0) {
      // sort by the first camera it's visible for
      // TODO: extend to support multiple cameras
      const camera = this.cameras[0];
      this.sort(camera._node);

      // we get new list of cameras each frame
      this.cameras.length = 0;
    }
  }
}

export { GSplatInstance };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3NwbGF0LWluc3RhbmNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvc2NlbmUvZ3NwbGF0L2dzcGxhdC1pbnN0YW5jZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYXQ0IH0gZnJvbSAnLi4vLi4vY29yZS9tYXRoL21hdDQuanMnO1xuaW1wb3J0IHsgVmVjMyB9IGZyb20gJy4uLy4uL2NvcmUvbWF0aC92ZWMzLmpzJztcbmltcG9ydCB7IEJVRkZFUl9EWU5BTUlDIH0gZnJvbSAnLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3MvY29uc3RhbnRzLmpzJztcbmltcG9ydCB7IFZlcnRleEJ1ZmZlciB9IGZyb20gJy4uLy4uL3BsYXRmb3JtL2dyYXBoaWNzL3ZlcnRleC1idWZmZXIuanMnO1xuaW1wb3J0IHsgRElUSEVSX05PTkUgfSBmcm9tICcuLi9jb25zdGFudHMuanMnO1xuaW1wb3J0IHsgTWVzaEluc3RhbmNlIH0gZnJvbSAnLi4vbWVzaC1pbnN0YW5jZS5qcyc7XG5pbXBvcnQgeyBNZXNoIH0gZnJvbSAnLi4vbWVzaC5qcyc7XG5pbXBvcnQgeyBjcmVhdGVCb3ggfSBmcm9tICcuLi9wcm9jZWR1cmFsLmpzJztcbmltcG9ydCB7IGNyZWF0ZUdTcGxhdE1hdGVyaWFsIH0gZnJvbSAnLi9nc3BsYXQtbWF0ZXJpYWwuanMnO1xuaW1wb3J0IHsgR1NwbGF0U29ydGVyIH0gZnJvbSAnLi9nc3BsYXQtc29ydGVyLmpzJztcblxuY29uc3QgbWF0ID0gbmV3IE1hdDQoKTtcbmNvbnN0IGNhbWVyYVBvc2l0aW9uID0gbmV3IFZlYzMoKTtcbmNvbnN0IGNhbWVyYURpcmVjdGlvbiA9IG5ldyBWZWMzKCk7XG5jb25zdCB2aWV3cG9ydCA9IFswLCAwXTtcblxuLyoqIEBpZ25vcmUgKi9cbmNsYXNzIEdTcGxhdEluc3RhbmNlIHtcbiAgICAvKiogQHR5cGUge2ltcG9ydCgnLi9nc3BsYXQuanMnKS5HU3BsYXR9ICovXG4gICAgc3BsYXQ7XG5cbiAgICAvKiogQHR5cGUge01lc2h9ICovXG4gICAgbWVzaDtcblxuICAgIC8qKiBAdHlwZSB7TWVzaEluc3RhbmNlfSAqL1xuICAgIG1lc2hJbnN0YW5jZTtcblxuICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuLi9tYXRlcmlhbHMvbWF0ZXJpYWwuanMnKS5NYXRlcmlhbH0gKi9cbiAgICBtYXRlcmlhbDtcblxuICAgIC8qKiBAdHlwZSB7VmVydGV4QnVmZmVyfSAqL1xuICAgIHZiO1xuXG4gICAgb3B0aW9ucyA9IHt9O1xuXG4gICAgLyoqIEB0eXBlIHtHU3BsYXRTb3J0ZXIgfCBudWxsfSAqL1xuICAgIHNvcnRlciA9IG51bGw7XG5cbiAgICBsYXN0Q2FtZXJhUG9zaXRpb24gPSBuZXcgVmVjMygpO1xuXG4gICAgbGFzdENhbWVyYURpcmVjdGlvbiA9IG5ldyBWZWMzKCk7XG5cbiAgICAvKipcbiAgICAgKiBMaXN0IG9mIGNhbWVyYXMgdGhpcyBpbnN0YW5jZSBpcyB2aXNpYmxlIGZvci4gVXBkYXRlZCBldmVyeSBmcmFtZSBieSB0aGUgcmVuZGVyZXIuXG4gICAgICpcbiAgICAgKiBAdHlwZSB7aW1wb3J0KCcuLi9jYW1lcmEuanMnKS5DYW1lcmFbXX1cbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgY2FtZXJhcyA9IFtdO1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vZ3NwbGF0LmpzJykuR1NwbGF0fSBzcGxhdCAtIFRoZSBzcGxhdCBpbnN0YW5jZS5cbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi9nc3BsYXQtbWF0ZXJpYWwuanMnKS5TcGxhdE1hdGVyaWFsT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBvcHRpb25zLlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKHNwbGF0LCBvcHRpb25zKSB7XG4gICAgICAgIHRoaXMuc3BsYXQgPSBzcGxhdDtcblxuICAgICAgICAvLyBjbG9uZSBvcHRpb25zIG9iamVjdFxuICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih0aGlzLm9wdGlvbnMsIG9wdGlvbnMpO1xuXG4gICAgICAgIC8vIG1hdGVyaWFsXG4gICAgICAgIGNvbnN0IGRlYnVnUmVuZGVyID0gb3B0aW9ucy5kZWJ1Z1JlbmRlcjtcbiAgICAgICAgdGhpcy5jcmVhdGVNYXRlcmlhbChvcHRpb25zKTtcblxuICAgICAgICAvLyBtZXNoXG4gICAgICAgIGNvbnN0IGRldmljZSA9IHNwbGF0LmRldmljZTtcbiAgICAgICAgaWYgKGRlYnVnUmVuZGVyKSB7XG4gICAgICAgICAgICB0aGlzLm1lc2ggPSBjcmVhdGVCb3goZGV2aWNlLCB7XG4gICAgICAgICAgICAgICAgaGFsZkV4dGVudHM6IG5ldyBWZWMzKDEuMCwgMS4wLCAxLjApXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBNZXNoKGRldmljZSk7XG4gICAgICAgICAgICB0aGlzLm1lc2guc2V0UG9zaXRpb25zKG5ldyBGbG9hdDMyQXJyYXkoW1xuICAgICAgICAgICAgICAgIC0xLCAtMSwgMSwgLTEsIDEsIDEsIC0xLCAtMSwgMSwgMSwgLTEsIDFcbiAgICAgICAgICAgIF0pLCAyKTtcbiAgICAgICAgICAgIHRoaXMubWVzaC51cGRhdGUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubWVzaC5hYWJiLmNvcHkoc3BsYXQuYWFiYik7XG5cbiAgICAgICAgLy8gaW5pdGlhbGl6ZSBpbmRleCBkYXRhXG4gICAgICAgIGNvbnN0IG51bVNwbGF0cyA9IHNwbGF0Lm51bVNwbGF0cztcbiAgICAgICAgbGV0IGluZGV4RGF0YTtcbiAgICAgICAgaWYgKCFkZXZpY2UuaXNXZWJHTDEpIHtcbiAgICAgICAgICAgIGluZGV4RGF0YSA9IG5ldyBVaW50MzJBcnJheShudW1TcGxhdHMpO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1TcGxhdHM7ICsraSkge1xuICAgICAgICAgICAgICAgIGluZGV4RGF0YVtpXSA9IGk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpbmRleERhdGEgPSBuZXcgRmxvYXQzMkFycmF5KG51bVNwbGF0cyk7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVNwbGF0czsgKytpKSB7XG4gICAgICAgICAgICAgICAgaW5kZXhEYXRhW2ldID0gaSArIDAuMjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHZiID0gbmV3IFZlcnRleEJ1ZmZlcihcbiAgICAgICAgICAgIGRldmljZSxcbiAgICAgICAgICAgIHNwbGF0LnZlcnRleEZvcm1hdCxcbiAgICAgICAgICAgIG51bVNwbGF0cyxcbiAgICAgICAgICAgIEJVRkZFUl9EWU5BTUlDLFxuICAgICAgICAgICAgaW5kZXhEYXRhLmJ1ZmZlclxuICAgICAgICApO1xuICAgICAgICB0aGlzLnZiID0gdmI7XG5cbiAgICAgICAgdGhpcy5tZXNoSW5zdGFuY2UgPSBuZXcgTWVzaEluc3RhbmNlKHRoaXMubWVzaCwgdGhpcy5tYXRlcmlhbCk7XG4gICAgICAgIHRoaXMubWVzaEluc3RhbmNlLnNldEluc3RhbmNpbmcodmIsIHRydWUpO1xuICAgICAgICB0aGlzLm1lc2hJbnN0YW5jZS5nc3BsYXRJbnN0YW5jZSA9IHRoaXM7XG5cbiAgICAgICAgLy8gY2xvbmUgY2VudGVycyB0byBhbGxvdyBtdWx0aXBsZSBpbnN0YW5jZXMgb2Ygc29ydGVyXG4gICAgICAgIHRoaXMuY2VudGVycyA9IG5ldyBGbG9hdDMyQXJyYXkoc3BsYXQuY2VudGVycyk7XG5cbiAgICAgICAgLy8gY3JlYXRlIHNvcnRlclxuICAgICAgICBpZiAoIW9wdGlvbnMuZGl0aGVyIHx8IG9wdGlvbnMuZGl0aGVyID09PSBESVRIRVJfTk9ORSkge1xuICAgICAgICAgICAgdGhpcy5zb3J0ZXIgPSBuZXcgR1NwbGF0U29ydGVyKCk7XG4gICAgICAgICAgICB0aGlzLnNvcnRlci5pbml0KHRoaXMudmIsIHRoaXMuY2VudGVycywgIXRoaXMuc3BsYXQuZGV2aWNlLmlzV2ViR0wxKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMubWF0ZXJpYWwuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLnZiLmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5tZXNoSW5zdGFuY2UuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLnNvcnRlcj8uZGVzdHJveSgpO1xuICAgIH1cblxuICAgIGNsb25lKCkge1xuICAgICAgICByZXR1cm4gbmV3IEdTcGxhdEluc3RhbmNlKHRoaXMuc3BsYXQsIHRoaXMub3B0aW9ucyk7XG4gICAgfVxuXG4gICAgY3JlYXRlTWF0ZXJpYWwob3B0aW9ucykge1xuICAgICAgICB0aGlzLm1hdGVyaWFsID0gY3JlYXRlR1NwbGF0TWF0ZXJpYWwob3B0aW9ucyk7XG4gICAgICAgIHRoaXMuc3BsYXQuc2V0dXBNYXRlcmlhbCh0aGlzLm1hdGVyaWFsKTtcbiAgICAgICAgaWYgKHRoaXMubWVzaEluc3RhbmNlKSB7XG4gICAgICAgICAgICB0aGlzLm1lc2hJbnN0YW5jZS5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB1cGRhdGVWaWV3cG9ydCgpIHtcbiAgICAgICAgLy8gVE9ETzogaW1wcm92ZSwgbmVlZHMgdG8gaGFuZGxlIHJlbmRlciB0YXJnZXRzIG9mIGRpZmZlcmVudCBzaXplc1xuICAgICAgICBjb25zdCBkZXZpY2UgPSB0aGlzLnNwbGF0LmRldmljZTtcbiAgICAgICAgdmlld3BvcnRbMF0gPSBkZXZpY2Uud2lkdGg7XG4gICAgICAgIHZpZXdwb3J0WzFdID0gZGV2aWNlLmhlaWdodDtcbiAgICAgICAgdGhpcy5tYXRlcmlhbC5zZXRQYXJhbWV0ZXIoJ3ZpZXdwb3J0Jywgdmlld3BvcnQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNvcnRzIHRoZSBHUyB2ZXJ0aWNlcyBiYXNlZCBvbiB0aGUgZ2l2ZW4gY2FtZXJhLlxuICAgICAqIEBwYXJhbSB7aW1wb3J0KCcuLi9ncmFwaC1ub2RlLmpzJykuR3JhcGhOb2RlfSBjYW1lcmFOb2RlIC0gVGhlIGNhbWVyYSBub2RlIHVzZWQgZm9yIHNvcnRpbmcuXG4gICAgICovXG4gICAgc29ydChjYW1lcmFOb2RlKSB7XG4gICAgICAgIGlmICh0aGlzLnNvcnRlcikge1xuICAgICAgICAgICAgY29uc3QgY2FtZXJhTWF0ID0gY2FtZXJhTm9kZS5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgICAgICAgICAgY2FtZXJhTWF0LmdldFRyYW5zbGF0aW9uKGNhbWVyYVBvc2l0aW9uKTtcbiAgICAgICAgICAgIGNhbWVyYU1hdC5nZXRaKGNhbWVyYURpcmVjdGlvbik7XG5cbiAgICAgICAgICAgIGNvbnN0IG1vZGVsTWF0ID0gdGhpcy5tZXNoSW5zdGFuY2Uubm9kZS5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgICAgICAgICAgY29uc3QgaW52TW9kZWxNYXQgPSBtYXQuaW52ZXJ0KG1vZGVsTWF0KTtcbiAgICAgICAgICAgIGludk1vZGVsTWF0LnRyYW5zZm9ybVBvaW50KGNhbWVyYVBvc2l0aW9uLCBjYW1lcmFQb3NpdGlvbik7XG4gICAgICAgICAgICBpbnZNb2RlbE1hdC50cmFuc2Zvcm1WZWN0b3IoY2FtZXJhRGlyZWN0aW9uLCBjYW1lcmFEaXJlY3Rpb24pO1xuXG4gICAgICAgICAgICAvLyBzb3J0IGlmIHRoZSBjYW1lcmEgaGFzIGNoYW5nZWRcbiAgICAgICAgICAgIGlmICghY2FtZXJhUG9zaXRpb24uZXF1YWxzQXBwcm94KHRoaXMubGFzdENhbWVyYVBvc2l0aW9uKSB8fCAhY2FtZXJhRGlyZWN0aW9uLmVxdWFsc0FwcHJveCh0aGlzLmxhc3RDYW1lcmFEaXJlY3Rpb24pKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0Q2FtZXJhUG9zaXRpb24uY29weShjYW1lcmFQb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0Q2FtZXJhRGlyZWN0aW9uLmNvcHkoY2FtZXJhRGlyZWN0aW9uKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNvcnRlci5zZXRDYW1lcmEoY2FtZXJhUG9zaXRpb24sIGNhbWVyYURpcmVjdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnVwZGF0ZVZpZXdwb3J0KCk7XG4gICAgfVxuXG4gICAgdXBkYXRlKCkge1xuICAgICAgICBpZiAodGhpcy5jYW1lcmFzLmxlbmd0aCA+IDApIHtcblxuICAgICAgICAgICAgLy8gc29ydCBieSB0aGUgZmlyc3QgY2FtZXJhIGl0J3MgdmlzaWJsZSBmb3JcbiAgICAgICAgICAgIC8vIFRPRE86IGV4dGVuZCB0byBzdXBwb3J0IG11bHRpcGxlIGNhbWVyYXNcbiAgICAgICAgICAgIGNvbnN0IGNhbWVyYSA9IHRoaXMuY2FtZXJhc1swXTtcbiAgICAgICAgICAgIHRoaXMuc29ydChjYW1lcmEuX25vZGUpO1xuXG4gICAgICAgICAgICAvLyB3ZSBnZXQgbmV3IGxpc3Qgb2YgY2FtZXJhcyBlYWNoIGZyYW1lXG4gICAgICAgICAgICB0aGlzLmNhbWVyYXMubGVuZ3RoID0gMDtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IHsgR1NwbGF0SW5zdGFuY2UgfTtcbiJdLCJuYW1lcyI6WyJtYXQiLCJNYXQ0IiwiY2FtZXJhUG9zaXRpb24iLCJWZWMzIiwiY2FtZXJhRGlyZWN0aW9uIiwidmlld3BvcnQiLCJHU3BsYXRJbnN0YW5jZSIsImNvbnN0cnVjdG9yIiwic3BsYXQiLCJvcHRpb25zIiwibWVzaCIsIm1lc2hJbnN0YW5jZSIsIm1hdGVyaWFsIiwidmIiLCJzb3J0ZXIiLCJsYXN0Q2FtZXJhUG9zaXRpb24iLCJsYXN0Q2FtZXJhRGlyZWN0aW9uIiwiY2FtZXJhcyIsIk9iamVjdCIsImFzc2lnbiIsImRlYnVnUmVuZGVyIiwiY3JlYXRlTWF0ZXJpYWwiLCJkZXZpY2UiLCJjcmVhdGVCb3giLCJoYWxmRXh0ZW50cyIsIk1lc2giLCJzZXRQb3NpdGlvbnMiLCJGbG9hdDMyQXJyYXkiLCJ1cGRhdGUiLCJhYWJiIiwiY29weSIsIm51bVNwbGF0cyIsImluZGV4RGF0YSIsImlzV2ViR0wxIiwiVWludDMyQXJyYXkiLCJpIiwiVmVydGV4QnVmZmVyIiwidmVydGV4Rm9ybWF0IiwiQlVGRkVSX0RZTkFNSUMiLCJidWZmZXIiLCJNZXNoSW5zdGFuY2UiLCJzZXRJbnN0YW5jaW5nIiwiZ3NwbGF0SW5zdGFuY2UiLCJjZW50ZXJzIiwiZGl0aGVyIiwiRElUSEVSX05PTkUiLCJHU3BsYXRTb3J0ZXIiLCJpbml0IiwiZGVzdHJveSIsIl90aGlzJHNvcnRlciIsImNsb25lIiwiY3JlYXRlR1NwbGF0TWF0ZXJpYWwiLCJzZXR1cE1hdGVyaWFsIiwidXBkYXRlVmlld3BvcnQiLCJ3aWR0aCIsImhlaWdodCIsInNldFBhcmFtZXRlciIsInNvcnQiLCJjYW1lcmFOb2RlIiwiY2FtZXJhTWF0IiwiZ2V0V29ybGRUcmFuc2Zvcm0iLCJnZXRUcmFuc2xhdGlvbiIsImdldFoiLCJtb2RlbE1hdCIsIm5vZGUiLCJpbnZNb2RlbE1hdCIsImludmVydCIsInRyYW5zZm9ybVBvaW50IiwidHJhbnNmb3JtVmVjdG9yIiwiZXF1YWxzQXBwcm94Iiwic2V0Q2FtZXJhIiwibGVuZ3RoIiwiY2FtZXJhIiwiX25vZGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBV0EsTUFBTUEsR0FBRyxHQUFHLElBQUlDLElBQUksRUFBRSxDQUFBO0FBQ3RCLE1BQU1DLGNBQWMsR0FBRyxJQUFJQyxJQUFJLEVBQUUsQ0FBQTtBQUNqQyxNQUFNQyxlQUFlLEdBQUcsSUFBSUQsSUFBSSxFQUFFLENBQUE7QUFDbEMsTUFBTUUsUUFBUSxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBOztBQUV2QjtBQUNBLE1BQU1DLGNBQWMsQ0FBQztBQWlDakI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsV0FBV0EsQ0FBQ0MsS0FBSyxFQUFFQyxPQUFPLEVBQUU7QUFwQzVCO0FBQUEsSUFBQSxJQUFBLENBQ0FELEtB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
