import { Debug } from '../../core/debug.js';
import { Quat } from '../../core/math/quat.js';
import { Vec3 } from '../../core/math/vec3.js';

class InterpolatedKey {
  constructor() {
    this._written = false;
    this._name = '';
    this._keyFrames = [];

    // Result of interpolation
    this._quat = new Quat();
    this._pos = new Vec3();
    this._scale = new Vec3();

    // Optional destination for interpolated keyframe
    this._targetNode = null;
  }
  getTarget() {
    return this._targetNode;
  }
  setTarget(node) {
    this._targetNode = node;
  }
}

/**
 * Represents a skeleton used to play animations.
 *
 * @category Animation
 */
class Skeleton {
  /**
   * Create a new Skeleton instance.
   *
   * @param {import('../graph-node.js').GraphNode} graph - The root {@link GraphNode} of the
   * skeleton.
   */
  constructor(graph) {
    /**
     * Determines whether skeleton is looping its animation.
     *
     * @type {boolean}
     */
    this.looping = true;
    /**
     * @type {import('./animation.js').Animation}
     * @private
     */
    this._animation = null;
    this._time = 0;
    this._interpolatedKeys = [];
    this._interpolatedKeyDict = {};
    this._currKeyIndices = {};
    this.graph = null;
    const addInterpolatedKeys = node => {
      const interpKey = new InterpolatedKey();
      interpKey._name = node.name;
      this._interpolatedKeys.push(interpKey);
      this._interpolatedKeyDict[node.name] = interpKey;
      this._currKeyIndices[node.name] = 0;
      for (let i = 0; i < node._children.length; i++) addInterpolatedKeys(node._children[i]);
    };
    addInterpolatedKeys(graph);
  }

  /**
   * Animation currently assigned to skeleton.
   *
   * @type {import('./animation.js').Animation}
   */
  set animation(value) {
    this._animation = value;
    this.currentTime = 0;
  }
  get animation() {
    return this._animation;
  }

  /**
   * Current time of currently active animation in seconds. This value is between zero and the
   * duration of the animation.
   *
   * @type {number}
   */
  set currentTime(value) {
    this._time = value;
    const numNodes = this._interpolatedKeys.length;
    for (let i = 0; i < numNodes; i++) {
      const node = this._interpolatedKeys[i];
      const nodeName = node._name;
      this._currKeyIndices[nodeName] = 0;
    }
    this.addTime(0);
    this.updateGraph();
  }
  get currentTime() {
    return this._time;
  }

  /**
   * Read-only property that returns number of nodes of a skeleton.
   *
   * @type {number}
   */
  get numNodes() {
    return this._interpolatedKeys.length;
  }

  /**
   * Progresses the animation assigned to the specified skeleton by the supplied time delta. If
   * the delta takes the animation passed its end point, if the skeleton is set to loop, the
   * animation will continue from the beginning. Otherwise, the animation's current time will
   * remain at its duration (i.e. the end).
   *
   * @param {number} delta - The time in seconds to progress the skeleton's animation.
   */
  addTime(delta) {
    if (this._animation !== null) {
      const nodes = this._animation._nodes;
      const duration = this._animation.duration;

      // Check if we can early out
      if (this._time === duration && !this.looping) {
        return;
      }

      // Step the current time and work out if we need to jump ahead, clamp or wrap around
      this._time += delta;
      if (this._time > duration) {
        this._time = this.looping ? 0.0 : duration;
        for (let i = 0; i < nodes.length; i++) {
          const node = nodes[i];
          const nodeName = node._name;
          this._currKeyIndices[nodeName] = 0;
        }
      } else if (this._time < 0) {
        this._time = this.looping ? duration : 0.0;
        for (let i = 0; i < nodes.length; i++) {
          const node = nodes[i];
          const nodeName = node._name;
          this._currKeyIndices[nodeName] = node._keys.length - 2;
        }
      }

      // For each animated node...

      // keys index offset
      const offset = delta >= 0 ? 1 : -1;
      for (let i = 0; i < nodes.length; i++) {
        const node = nodes[i];
        const nodeName = node._name;
        const keys = node._keys;

        // Determine the interpolated keyframe for this animated node
        const interpKey = this._interpolatedKeyDict[nodeName];
        if (interpKey === undefined) {
          Debug.warn(`Unknown skeleton node name: ${nodeName}`);
          continue;
        }
        // If there's only a single key, just copy the key to the interpolated key...
        let foundKey = false;
        if (keys.length !== 1) {
          // Otherwise, find the keyframe pair for this node
          for (let currKeyIndex = this._currKeyIndices[nodeName]; currKeyIndex < keys.length - 1 && currKeyIndex >= 0; currKeyIndex += offset) {
            const k1 = keys[currKeyIndex];
            const k2 = keys[currKeyIndex + 1];
            if (k1.time <= this._time && k2.time >= this._time) {
              const alpha = (this._time - k1.time) / (k2.time - k1.time);
              interpKey._pos.lerp(k1.position, k2.position, alpha);
              interpKey._quat.slerp(k1.rotation, k2.rotation, alpha);
              interpKey._scale.lerp(k1.scale, k2.scale, alpha);
              interpKey._written = true;
              this._currKeyIndices[nodeName] = currKeyIndex;
              foundKey = true;
              break;
            }
          }
        }
        if (keys.length === 1 || !foundKey && this._time === 0.0 && this.looping) {
          interpKey._pos.copy(keys[0].position);
          interpKey._quat.copy(keys[0].rotation);
          interpKey._scale.copy(keys[0].scale);
          interpKey._written = true;
        }
      }
    }
  }

  /**
   * Blends two skeletons together.
   *
   * @param {Skeleton} skel1 - Skeleton holding the first pose to be blended.
   * @param {Skeleton} skel2 - Skeleton holding the second pose to be blended.
   * @param {number} alpha - The value controlling the interpolation in relation to the two input
   * skeletons. The value is in the range 0 to 1, 0 generating skel1, 1 generating skel2 and
   * anything in between generating a spherical interpolation between the two.
   */
  blend(skel1, skel2, alpha) {
    const numNodes = this._interpolatedKeys.length;
    for (let i = 0; i < numNodes; i++) {
      const key1 = skel1._interpolatedKeys[i];
      const key2 = skel2._interpolatedKeys[i];
      const dstKey = this._interpolatedKeys[i];
      if (key1._written && key2._written) {
        dstKey._quat.slerp(key1._quat, skel2._interpolatedKeys[i]._quat, alpha);
        dstKey._pos.lerp(key1._pos, skel2._interpolatedKeys[i]._pos, alpha);
        dstKey._scale.lerp(key1._scale, key2._scale, alpha);
        dstKey._written = true;
      } else if (key1._written) {
        dstKey._quat.copy(key1._quat);
        dstKey._pos.copy(key1._pos);
        dstKey._scale.copy(key1._scale);
        dstKey._written = true;
      } else if (key2._written) {
        dstKey._quat.copy(key2._quat);
        dstKey._pos.copy(key2._pos);
        dstKey._scale.copy(key2._scale);
        dstKey._written = true;
      }
    }
  }

  /**
   * Links a skeleton to a node hierarchy. The nodes animated skeleton are then subsequently used
   * to drive the local transformation matrices of the node hierarchy.
   *
   * @param {import('../graph-node.js').GraphNode} graph - The root node of the graph that the
   * skeleton is to drive.
   */
  setGraph(graph) {
    this.graph = graph;
    if (graph) {
      for (let i = 0; i < this._interpolatedKeys.length; i++) {
        const interpKey = this._interpolatedKeys[i];
        const graphNode = graph.findByName(interpKey._name);
        this._interpolatedKeys[i].setTarget(graphNode);
      }
    } else {
      for (let i = 0; i < this._interpolatedKeys.length; i++) {
        this._interpolatedKeys[i].setTarget(null);
      }
    }
  }

  /**
   * Synchronizes the currently linked node hierarchy with the current state of the skeleton.
   * Internally, this function converts the interpolated keyframe at each node in the skeleton
   * into the local transformation matrix at each corresponding node in the linked node
   * hierarchy.
   */
  updateGraph() {
    if (this.graph) {
      for (let i = 0; i < this._interpolatedKeys.length; i++) {
        const interpKey = this._interpolatedKeys[i];
        if (interpKey._written) {
          const transform = interpKey.getTarget();
          transform.localPosition.copy(interpKey._pos);
          transform.localRotation.copy(interpKey._quat);
          transform.localScale.copy(interpKey._scale);
          if (!transform._dirtyLocal) transform._dirtifyLocal();
          interpKey._written = false;
        }
      }
    }
  }
}

export { Skeleton };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2tlbGV0b24uanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9zY2VuZS9hbmltYXRpb24vc2tlbGV0b24uanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVidWcgfSBmcm9tICcuLi8uLi9jb3JlL2RlYnVnLmpzJztcbmltcG9ydCB7IFF1YXQgfSBmcm9tICcuLi8uLi9jb3JlL21hdGgvcXVhdC5qcyc7XG5pbXBvcnQgeyBWZWMzIH0gZnJvbSAnLi4vLi4vY29yZS9tYXRoL3ZlYzMuanMnO1xuXG5jbGFzcyBJbnRlcnBvbGF0ZWRLZXkge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLl93cml0dGVuID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX25hbWUgPSAnJztcbiAgICAgICAgdGhpcy5fa2V5RnJhbWVzID0gW107XG5cbiAgICAgICAgLy8gUmVzdWx0IG9mIGludGVycG9sYXRpb25cbiAgICAgICAgdGhpcy5fcXVhdCA9IG5ldyBRdWF0KCk7XG4gICAgICAgIHRoaXMuX3BvcyA9IG5ldyBWZWMzKCk7XG4gICAgICAgIHRoaXMuX3NjYWxlID0gbmV3IFZlYzMoKTtcblxuICAgICAgICAvLyBPcHRpb25hbCBkZXN0aW5hdGlvbiBmb3IgaW50ZXJwb2xhdGVkIGtleWZyYW1lXG4gICAgICAgIHRoaXMuX3RhcmdldE5vZGUgPSBudWxsO1xuICAgIH1cblxuICAgIGdldFRhcmdldCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldE5vZGU7XG4gICAgfVxuXG4gICAgc2V0VGFyZ2V0KG5vZGUpIHtcbiAgICAgICAgdGhpcy5fdGFyZ2V0Tm9kZSA9IG5vZGU7XG4gICAgfVxufVxuXG4vKipcbiAqIFJlcHJlc2VudHMgYSBza2VsZXRvbiB1c2VkIHRvIHBsYXkgYW5pbWF0aW9ucy5cbiAqXG4gKiBAY2F0ZWdvcnkgQW5pbWF0aW9uXG4gKi9cbmNsYXNzIFNrZWxldG9uIHtcbiAgICAvKipcbiAgICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgc2tlbGV0b24gaXMgbG9vcGluZyBpdHMgYW5pbWF0aW9uLlxuICAgICAqXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICovXG4gICAgbG9vcGluZyA9IHRydWU7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgU2tlbGV0b24gaW5zdGFuY2UuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi4vZ3JhcGgtbm9kZS5qcycpLkdyYXBoTm9kZX0gZ3JhcGggLSBUaGUgcm9vdCB7QGxpbmsgR3JhcGhOb2RlfSBvZiB0aGVcbiAgICAgKiBza2VsZXRvbi5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihncmFwaCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogQHR5cGUge2ltcG9ydCgnLi9hbmltYXRpb24uanMnKS5BbmltYXRpb259XG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9hbmltYXRpb24gPSBudWxsO1xuICAgICAgICB0aGlzLl90aW1lID0gMDtcblxuICAgICAgICB0aGlzLl9pbnRlcnBvbGF0ZWRLZXlzID0gW107XG4gICAgICAgIHRoaXMuX2ludGVycG9sYXRlZEtleURpY3QgPSB7fTtcbiAgICAgICAgdGhpcy5fY3VycktleUluZGljZXMgPSB7fTtcblxuICAgICAgICB0aGlzLmdyYXBoID0gbnVsbDtcblxuICAgICAgICBjb25zdCBhZGRJbnRlcnBvbGF0ZWRLZXlzID0gKG5vZGUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGludGVycEtleSA9IG5ldyBJbnRlcnBvbGF0ZWRLZXkoKTtcbiAgICAgICAgICAgIGludGVycEtleS5fbmFtZSA9IG5vZGUubmFtZTtcbiAgICAgICAgICAgIHRoaXMuX2ludGVycG9sYXRlZEtleXMucHVzaChpbnRlcnBLZXkpO1xuICAgICAgICAgICAgdGhpcy5faW50ZXJwb2xhdGVkS2V5RGljdFtub2RlLm5hbWVdID0gaW50ZXJwS2V5O1xuICAgICAgICAgICAgdGhpcy5fY3VycktleUluZGljZXNbbm9kZS5uYW1lXSA9IDA7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5fY2hpbGRyZW4ubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICAgICAgYWRkSW50ZXJwb2xhdGVkS2V5cyhub2RlLl9jaGlsZHJlbltpXSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgYWRkSW50ZXJwb2xhdGVkS2V5cyhncmFwaCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQW5pbWF0aW9uIGN1cnJlbnRseSBhc3NpZ25lZCB0byBza2VsZXRvbi5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtpbXBvcnQoJy4vYW5pbWF0aW9uLmpzJykuQW5pbWF0aW9ufVxuICAgICAqL1xuICAgIHNldCBhbmltYXRpb24odmFsdWUpIHtcbiAgICAgICAgdGhpcy5fYW5pbWF0aW9uID0gdmFsdWU7XG4gICAgICAgIHRoaXMuY3VycmVudFRpbWUgPSAwO1xuICAgIH1cblxuICAgIGdldCBhbmltYXRpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9hbmltYXRpb247XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3VycmVudCB0aW1lIG9mIGN1cnJlbnRseSBhY3RpdmUgYW5pbWF0aW9uIGluIHNlY29uZHMuIFRoaXMgdmFsdWUgaXMgYmV0d2VlbiB6ZXJvIGFuZCB0aGVcbiAgICAgKiBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uLlxuICAgICAqXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBzZXQgY3VycmVudFRpbWUodmFsdWUpIHtcbiAgICAgICAgdGhpcy5fdGltZSA9IHZhbHVlO1xuICAgICAgICBjb25zdCBudW1Ob2RlcyA9IHRoaXMuX2ludGVycG9sYXRlZEtleXMubGVuZ3RoO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bU5vZGVzOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLl9pbnRlcnBvbGF0ZWRLZXlzW2ldO1xuICAgICAgICAgICAgY29uc3Qgbm9kZU5hbWUgPSBub2RlLl9uYW1lO1xuICAgICAgICAgICAgdGhpcy5fY3VycktleUluZGljZXNbbm9kZU5hbWVdID0gMDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYWRkVGltZSgwKTtcbiAgICAgICAgdGhpcy51cGRhdGVHcmFwaCgpO1xuICAgIH1cblxuICAgIGdldCBjdXJyZW50VGltZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RpbWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVhZC1vbmx5IHByb3BlcnR5IHRoYXQgcmV0dXJucyBudW1iZXIgb2Ygbm9kZXMgb2YgYSBza2VsZXRvbi5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgZ2V0IG51bU5vZGVzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5faW50ZXJwb2xhdGVkS2V5cy5sZW5ndGg7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJvZ3Jlc3NlcyB0aGUgYW5pbWF0aW9uIGFzc2lnbmVkIHRvIHRoZSBzcGVjaWZpZWQgc2tlbGV0b24gYnkgdGhlIHN1cHBsaWVkIHRpbWUgZGVsdGEuIElmXG4gICAgICogdGhlIGRlbHRhIHRha2VzIHRoZSBhbmltYXRpb24gcGFzc2VkIGl0cyBlbmQgcG9pbnQsIGlmIHRoZSBza2VsZXRvbiBpcyBzZXQgdG8gbG9vcCwgdGhlXG4gICAgICogYW5pbWF0aW9uIHdpbGwgY29udGludWUgZnJvbSB0aGUgYmVnaW5uaW5nLiBPdGhlcndpc2UsIHRoZSBhbmltYXRpb24ncyBjdXJyZW50IHRpbWUgd2lsbFxuICAgICAqIHJlbWFpbiBhdCBpdHMgZHVyYXRpb24gKGkuZS4gdGhlIGVuZCkuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gZGVsdGEgLSBUaGUgdGltZSBpbiBzZWNvbmRzIHRvIHByb2dyZXNzIHRoZSBza2VsZXRvbidzIGFuaW1hdGlvbi5cbiAgICAgKi9cbiAgICBhZGRUaW1lKGRlbHRhKSB7XG4gICAgICAgIGlmICh0aGlzLl9hbmltYXRpb24gIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IG5vZGVzID0gdGhpcy5fYW5pbWF0aW9uLl9ub2RlcztcbiAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gdGhpcy5fYW5pbWF0aW9uLmR1cmF0aW9uO1xuXG4gICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBjYW4gZWFybHkgb3V0XG4gICAgICAgICAgICBpZiAoKHRoaXMuX3RpbWUgPT09IGR1cmF0aW9uKSAmJiAhdGhpcy5sb29waW5nKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBTdGVwIHRoZSBjdXJyZW50IHRpbWUgYW5kIHdvcmsgb3V0IGlmIHdlIG5lZWQgdG8ganVtcCBhaGVhZCwgY2xhbXAgb3Igd3JhcCBhcm91bmRcbiAgICAgICAgICAgIHRoaXMuX3RpbWUgKz0gZGVsdGE7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLl90aW1lID4gZHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICB0aGlzLl90aW1lID0gdGhpcy5sb29waW5nID8gMC4wIDogZHVyYXRpb247XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBub2RlID0gbm9kZXNbaV07XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vZGVOYW1lID0gbm9kZS5fbmFtZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycktleUluZGljZXNbbm9kZU5hbWVdID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX3RpbWUgPCAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fdGltZSA9IHRoaXMubG9vcGluZyA/IGR1cmF0aW9uIDogMC4wO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBub2RlTmFtZSA9IG5vZGUuX25hbWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJLZXlJbmRpY2VzW25vZGVOYW1lXSA9IG5vZGUuX2tleXMubGVuZ3RoIC0gMjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgLy8gRm9yIGVhY2ggYW5pbWF0ZWQgbm9kZS4uLlxuXG4gICAgICAgICAgICAvLyBrZXlzIGluZGV4IG9mZnNldFxuICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gKGRlbHRhID49IDAgPyAxIDogLTEpO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGVOYW1lID0gbm9kZS5fbmFtZTtcbiAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gbm9kZS5fa2V5cztcblxuICAgICAgICAgICAgICAgIC8vIERldGVybWluZSB0aGUgaW50ZXJwb2xhdGVkIGtleWZyYW1lIGZvciB0aGlzIGFuaW1hdGVkIG5vZGVcbiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnBLZXkgPSB0aGlzLl9pbnRlcnBvbGF0ZWRLZXlEaWN0W25vZGVOYW1lXTtcbiAgICAgICAgICAgICAgICBpZiAoaW50ZXJwS2V5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgRGVidWcud2FybihgVW5rbm93biBza2VsZXRvbiBub2RlIG5hbWU6ICR7bm9kZU5hbWV9YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSdzIG9ubHkgYSBzaW5nbGUga2V5LCBqdXN0IGNvcHkgdGhlIGtleSB0byB0aGUgaW50ZXJwb2xhdGVkIGtleS4uLlxuICAgICAgICAgICAgICAgIGxldCBmb3VuZEtleSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChrZXlzLmxlbmd0aCAhPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGZpbmQgdGhlIGtleWZyYW1lIHBhaXIgZm9yIHRoaXMgbm9kZVxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBjdXJyS2V5SW5kZXggPSB0aGlzLl9jdXJyS2V5SW5kaWNlc1tub2RlTmFtZV07IGN1cnJLZXlJbmRleCA8IGtleXMubGVuZ3RoIC0gMSAmJiBjdXJyS2V5SW5kZXggPj0gMDsgY3VycktleUluZGV4ICs9IG9mZnNldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgazEgPSBrZXlzW2N1cnJLZXlJbmRleF07XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrMiA9IGtleXNbY3VycktleUluZGV4ICsgMV07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoazEudGltZSA8PSB0aGlzLl90aW1lKSAmJiAoazIudGltZSA+PSB0aGlzLl90aW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gKHRoaXMuX3RpbWUgLSBrMS50aW1lKSAvIChrMi50aW1lIC0gazEudGltZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnBLZXkuX3Bvcy5sZXJwKGsxLnBvc2l0aW9uLCBrMi5wb3NpdGlvbiwgYWxwaGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVycEtleS5fcXVhdC5zbGVycChrMS5yb3RhdGlvbiwgazIucm90YXRpb24sIGFscGhhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnBLZXkuX3NjYWxlLmxlcnAoazEuc2NhbGUsIGsyLnNjYWxlLCBhbHBoYSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwS2V5Ll93cml0dGVuID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJLZXlJbmRpY2VzW25vZGVOYW1lXSA9IGN1cnJLZXlJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEtleSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAxIHx8ICghZm91bmRLZXkgJiYgdGhpcy5fdGltZSA9PT0gMC4wICYmIHRoaXMubG9vcGluZykpIHtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJwS2V5Ll9wb3MuY29weShrZXlzWzBdLnBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJwS2V5Ll9xdWF0LmNvcHkoa2V5c1swXS5yb3RhdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIGludGVycEtleS5fc2NhbGUuY29weShrZXlzWzBdLnNjYWxlKTtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJwS2V5Ll93cml0dGVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCbGVuZHMgdHdvIHNrZWxldG9ucyB0b2dldGhlci5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7U2tlbGV0b259IHNrZWwxIC0gU2tlbGV0b24gaG9sZGluZyB0aGUgZmlyc3QgcG9zZSB0byBiZSBibGVuZGVkLlxuICAgICAqIEBwYXJhbSB7U2tlbGV0b259IHNrZWwyIC0gU2tlbGV0b24gaG9sZGluZyB0aGUgc2Vjb25kIHBvc2UgdG8gYmUgYmxlbmRlZC5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgdmFsdWUgY29udHJvbGxpbmcgdGhlIGludGVycG9sYXRpb24gaW4gcmVsYXRpb24gdG8gdGhlIHR3byBpbnB1dFxuICAgICAqIHNrZWxldG9ucy4gVGhlIHZhbHVlIGlzIGluIHRoZSByYW5nZSAwIHRvIDEsIDAgZ2VuZXJhdGluZyBza2VsMSwgMSBnZW5lcmF0aW5nIHNrZWwyIGFuZFxuICAgICAqIGFueXRoaW5nIGluIGJldHdlZW4gZ2VuZXJhdGluZyBhIHNwaGVyaWNhbCBpbnRlcnBvbGF0aW9uIGJldHdlZW4gdGhlIHR3by5cbiAgICAgKi9cbiAgICBibGVuZChza2VsMSwgc2tlbDIsIGFscGhhKSB7XG4gICAgICAgIGNvbnN0IG51bU5vZGVzID0gdGhpcy5faW50ZXJwb2xhdGVkS2V5cy5sZW5ndGg7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtTm9kZXM7IGkrKykge1xuICAgICAgICAgICAgY29uc3Qga2V5MSA9IHNrZWwxLl9pbnRlcnBvbGF0ZWRLZXlzW2ldO1xuICAgICAgICAgICAgY29uc3Qga2V5MiA9IHNrZWwyLl9pbnRlcnBvbGF0ZWRLZXlzW2ldO1xuICAgICAgICAgICAgY29uc3QgZHN0S2V5ID0gdGhpcy5faW50ZXJwb2xhdGVkS2V5c1tpXTtcblxuICAgICAgICAgICAgaWYgKGtleTEuX3dyaXR0ZW4gJiYga2V5Mi5fd3JpdHRlbikge1xuICAgICAgICAgICAgICAgIGRzdEtleS5fcXVhdC5zbGVycChrZXkxLl9xdWF0LCBza2VsMi5faW50ZXJwb2xhdGVkS2V5c1tpXS5fcXVhdCwgYWxwaGEpO1xuICAgICAgICAgICAgICAgIGRzdEtleS5fcG9zLmxlcnAoa2V5MS5fcG9zLCBza2VsMi5faW50ZXJwb2xhdGVkS2V5c1tpXS5fcG9zLCBhbHBoYSk7XG4gICAgICAgICAgICAgICAgZHN0S2V5Ll9zY2FsZS5sZXJwKGtleTEuX3NjYWxlLCBrZXkyLl9zY2FsZSwgYWxwaGEpO1xuICAgICAgICAgICAgICAgIGRzdEtleS5fd3JpdHRlbiA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGtleTEuX3dyaXR0ZW4pIHtcbiAgICAgICAgICAgICAgICBkc3RLZXkuX3F1YXQuY29weShrZXkxLl9xdWF0KTtcbiAgICAgICAgICAgICAgICBkc3RLZXkuX3Bvcy5jb3B5KGtleTEuX3Bvcyk7XG4gICAgICAgICAgICAgICAgZHN0S2V5Ll9zY2FsZS5jb3B5KGtleTEuX3NjYWxlKTtcbiAgICAgICAgICAgICAgICBkc3RLZXkuX3dyaXR0ZW4gPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkyLl93cml0dGVuKSB7XG4gICAgICAgICAgICAgICAgZHN0S2V5Ll9xdWF0LmNvcHkoa2V5Mi5fcXVhdCk7XG4gICAgICAgICAgICAgICAgZHN0S2V5Ll9wb3MuY29weShrZXkyLl9wb3MpO1xuICAgICAgICAgICAgICAgIGRzdEtleS5fc2NhbGUuY29weShrZXkyLl9zY2FsZSk7XG4gICAgICAgICAgICAgICAgZHN0S2V5Ll93cml0dGVuID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExpbmtzIGEgc2tlbGV0b24gdG8gYSBub2RlIGhpZXJhcmNoeS4gVGhlIG5vZGVzIGFuaW1hdGVkIHNrZWxldG9uIGFyZSB0aGVuIHN1YnNlcXVlbnRseSB1c2VkXG4gICAgICogdG8gZHJpdmUgdGhlIGxvY2FsIHRyYW5zZm9ybWF0aW9uIG1hdHJpY2VzIG9mIHRoZSBub2RlIGhpZXJhcmNoeS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW1wb3J0KCcuLi9ncmFwaC1ub2RlLmpzJykuR3JhcGhOb2RlfSBncmFwaCAtIFRoZSByb290IG5vZGUgb2YgdGhlIGdyYXBoIHRoYXQgdGhlXG4gICAgICogc2tlbGV0b24gaXMgdG8gZHJpdmUuXG4gICAgICovXG4gICAgc2V0R3JhcGgoZ3JhcGgpIHtcbiAgICAgICAgdGhpcy5ncmFwaCA9IGdyYXBoO1xuXG4gICAgICAgIGlmIChncmFwaCkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9pbnRlcnBvbGF0ZWRLZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW50ZXJwS2V5ID0gdGhpcy5faW50ZXJwb2xhdGVkS2V5c1tpXTtcbiAgICAgICAgICAgICAgICBjb25zdCBncmFwaE5vZGUgPSBncmFwaC5maW5kQnlOYW1lKGludGVycEtleS5fbmFtZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5faW50ZXJwb2xhdGVkS2V5c1tpXS5zZXRUYXJnZXQoZ3JhcGhOb2RlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5faW50ZXJwb2xhdGVkS2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHRoaXMuX2ludGVycG9sYXRlZEtleXNbaV0uc2V0VGFyZ2V0KG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3luY2hyb25pemVzIHRoZSBjdXJyZW50bHkgbGlua2VkIG5vZGUgaGllcmFyY2h5IHdpdGggdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIHNrZWxldG9uLlxuICAgICAqIEludGVybmFsbHksIHRoaXMgZnVuY3Rpb24gY29udmVydHMgdGhlIGludGVycG9sYXRlZCBrZXlmcmFtZSBhdCBlYWNoIG5vZGUgaW4gdGhlIHNrZWxldG9uXG4gICAgICogaW50byB0aGUgbG9jYWwgdHJhbnNmb3JtYXRpb24gbWF0cml4IGF0IGVhY2ggY29ycmVzcG9uZGluZyBub2RlIGluIHRoZSBsaW5rZWQgbm9kZVxuICAgICAqIGhpZXJhcmNoeS5cbiAgICAgKi9cbiAgICB1cGRhdGVHcmFwaCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZ3JhcGgpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5faW50ZXJwb2xhdGVkS2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGludGVycEtleSA9IHRoaXMuX2ludGVycG9sYXRlZEtleXNbaV07XG4gICAgICAgICAgICAgICAgaWYgKGludGVycEtleS5fd3JpdHRlbikge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFuc2Zvcm0gPSBpbnRlcnBLZXkuZ2V0VGFyZ2V0KCk7XG5cbiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtLmxvY2FsUG9zaXRpb24uY29weShpbnRlcnBLZXkuX3Bvcyk7XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybS5sb2NhbFJvdGF0aW9uLmNvcHkoaW50ZXJwS2V5Ll9xdWF0KTtcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtLmxvY2FsU2NhbGUuY29weShpbnRlcnBLZXkuX3NjYWxlKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRyYW5zZm9ybS5fZGlydHlMb2NhbClcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybS5fZGlydGlmeUxvY2FsKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaW50ZXJwS2V5Ll93cml0dGVuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgeyBTa2VsZXRvbiB9O1xuIl0sIm5hbWVzIjpbIkludGVycG9sYXRlZEtleSIsImNvbnN0cnVjdG9yIiwiX3dyaXR0ZW4iLCJfbmFtZSIsIl9rZXlGcmFtZXMiLCJfcXVhdCIsIlF1YXQiLCJfcG9zIiwiVmVjMyIsIl9zY2FsZSIsIl90YXJnZXROb2RlIiwiZ2V0VGFyZ2V0Iiwic2V0VGFyZ2V0Iiwibm9kZSIsIlNrZWxldG9uIiwiZ3JhcGgiLCJsb29waW5nIiwiX2FuaW1hdGlvbiIsIl90aW1lIiwiX2ludGVycG9sYXRlZEtleXMiLCJfaW50ZXJwb2xhdGVkS2V5RGljdCIsIl9jdXJyS2V5SW5kaWNlcyIsImFkZEludGVycG9sYXRlZEtleXMiLCJpbnRlcnBLZXkiLCJuYW1lIiwicHVzaCIsImkiLCJfY2hpbGRyZW4iLCJsZW5ndGgiLCJhbmltYXRpb24iLCJ2YWx1ZSIsImN1cnJlbnRUaW1lIiwibnVtTm9kZXMiLCJub2RlTmFtZSIsImFkZFRpbWUiLCJ1cGRhdGVHcmFwaCIsImRlbHRhIiwibm9kZXMiLCJfbm9kZXMiLCJkdXJhdGlvbiIsIl9rZXlzIiwib2Zmc2V0Iiwia2V5cyIsInVuZGVmaW5lZCIsIkRlYnVnIiwid2FybiIsImZvdW5kS2V5IiwiY3VycktleUluZGV4IiwiazEiLCJrMiIsInRpbWUiLCJhbHBoYSIsImxlcnAiLCJwb3NpdGlvbiIsInNsZXJwIiwicm90YXRpb24iLCJzY2FsZSIsImNvcHkiLCJibGVuZCIsInNrZWwxIiwic2tlbDIiLCJrZXkxIiwia2V5MiIsImRzdEtleSIsInNldEdyYXBoIiwiZ3JhcGhOb2RlIiwiZmluZEJ5TmFtZSIsInRyYW5zZm9ybSIsImxvY2FsUG9zaXRpb24iLCJsb2NhbFJvdGF0aW9uIiwibG9jYWxTY2FsZSIsIl9kaXJ0eUxvY2FsIiwiX2RpcnRpZnlMb2NhbCJdLCJtYXBwaW5ncyI6Ijs7OztBQUlBLE1BQU1BLGVBQWUsQ0FBQztBQUNsQkMsRUFBQUEsV0FBV0EsR0FBRztJQUNWLElBQUksQ0FBQ0MsUUFBUSxHQUFHLEtBQUssQ0FBQTtJQUNyQixJQUFJLENBQUNDLEtBQUssR0FBRyxFQUFFLENBQUE7SUFDZixJQUFJLENBQUNDLFVBQVUsR0FBRyxFQUFFLENBQUE7O0FBRXBCO0FBQ0EsSUFBQSxJQUFJLENBQUNDLEtBQUssR0FBRyxJQUFJQyxJQUFJLEVBQUUsQ0FBQTtBQUN2QixJQUFBLElBQUksQ0FBQ0MsSUFBSSxHQUFHLElBQUlDLElBQUksRUFBRSxDQUFBO0FBQ3RCLElBQUEsSUFBSSxDQUFDQyxNQUFNLEdBQUcsSUFBSUQsSUFBSSxFQUFFLENBQUE7O0FBRXhCO0lBQ0EsSUFBSSxDQUFDRSxXQUFXLEdBQUcsSUFB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
